<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ« - AI & ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç‰ˆ</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J7QD0MNVWG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J7QD0MNVWG');
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f0ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e6e6ff;
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .control-group select, .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .control-group select:focus, .control-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .analysis-container {
            display: grid;
            grid-template-columns: 1fr 1.4fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        .image-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .image-container {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }

        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .image-container canvas {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 10px;
            cursor: crosshair;
        }

        .ball-position-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 100%);
            border: 3px solid #FF4500;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            box-shadow: 0 3px 12px rgba(255, 69, 0, 0.4);
            cursor: pointer;
            animation: ballPulse 1.5s ease-in-out infinite;
        }

        @keyframes ballPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .ball-position-marker::after {
            content: 'ğŸŒï¸â€â™‚ï¸';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .click-instruction {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 15;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); }
        }

        .ball-position-instruction {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 215, 0, 0.85);
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
            border: 2px solid #FFD700;
            max-width: 150px;
            line-height: 1.2;
        }

        .score-feedback-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .score-feedback-item {
            background: linear-gradient(135deg, #f6f9fc 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .detailed-comparison {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid #fd7e14;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .comparison-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .comparison-label {
            font-weight: bold;
            color: #495057;
            flex: 0 0 25%;
        }

        .comparison-current {
            color: #dc3545;
            font-weight: bold;
            flex: 0 0 30%;
            text-align: center;
        }

        .comparison-ideal {
            color: #28a745;
            font-weight: bold;
            flex: 0 0 30%;
            text-align: center;
        }

        .comparison-gap {
            color: #fd7e14;
            font-weight: bold;
            flex: 0 0 15%;
            text-align: center;
            font-size: 0.9em;
        }

        .improvement-steps {
            background: #e8f4f8;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .improvement-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .improvement-step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            background: #17a2b8;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .visual-comparison {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid #007bff;
        }

        .before-after-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .comparison-side {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            position: relative;
        }

        .comparison-before {
            background: #fff2f2;
            border: 2px solid #dc3545;
        }

        .comparison-after {
            background: #f2fff2;
            border: 2px solid #28a745;
        }

        .comparison-label-visual {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
            font-size: 0.9em;
        }

        .label-before {
            background: #dc3545;
            color: white;
        }

        .label-after {
            background: #28a745;
            color: white;
        }

        .angle-display {
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .angle-before {
            color: #dc3545;
        }

        .angle-after {
            color: #28a745;
        }

        .visual-indicator {
            margin: 10px 0;
            height: 60px;
            position: relative;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .before-after-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .score-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .advice-text {
            color: #666;
            line-height: 1.6;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .score-label {
            color: #666;
            font-size: 0.9em;
        }

        .score-excellent { border-left-color: #28a745; }
        .score-good { border-left-color: #17a2b8; }
        .score-average { border-left-color: #ffc107; }
        .score-poor { border-left-color: #dc3545; }

        .score-excellent .score-value { color: #28a745; }
        .score-good .score-value { color: #17a2b8; }
        .score-average .score-value { color: #ffc107; }
        .score-poor .score-value { color: #dc3545; }

        .radar-container {
            position: relative;
            height: 800px; /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§æœ€å¤§ã‚µã‚¤ã‚º */
            margin: 20px 0;
            padding: 25px;
        }

        .feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .feedback h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .feedback-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .feedback-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .feedback-item p {
            color: #666;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .social-btn {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .social-btn:active {
            transform: translateY(0);
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
            }
            
            .analysis-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
        }

        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1em;
            }

            .upload-area {
                padding: 30px 15px;
                border-width: 2px;
            }

            .upload-icon {
                font-size: 3em;
            }

            .upload-text {
                font-size: 1.1em;
            }

            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç›£ä¿®è€…æƒ…å ±ã‚’ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èª¿æ•´ */
            .header div[style*="display: flex"] {
                flex-direction: column !important;
                text-align: center !important;
                gap: 10px !important;
                padding: 12px !important;
            }

            .header div[style*="display: flex"] img {
                width: 60px !important;
                height: 60px !important;
            }

            .analysis-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .upload-section {
                padding: 15px;
            }

            .upload-area {
                padding: 30px 20px;
            }

            .upload-icon {
                font-size: 3em;
            }

            .upload-text {
                font-size: 16px;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .control-group {
                flex-direction: column;
                gap: 8px;
                text-align: left;
            }

            .control-group label {
                font-size: 16px;
                font-weight: bold;
            }

            .control-group select,
            .control-group button {
                font-size: 16px;
                padding: 12px;
                min-height: 44px; /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚º */
            }

            .score-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .score-feedback-item {
                padding: 15px;
            }

            .score-title {
                font-size: 16px;
            }

            .score-value {
                font-size: 18px;
            }

            .advice-text {
                font-size: 16px; /* ã‚³ãƒ¡ãƒ³ãƒˆæ–‡å­—ã‚’å¤§ãã */
                line-height: 1.6;
            }

            /* ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èª¿æ•´ */
            .radar-container {
                height: 700px !important; /* ã‚¹ãƒãƒ›ã§æœ€å¤§ã‚µã‚¤ã‚º */
                padding: 10px !important;
            }

            /* ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢ã‚’ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èª¿æ•´ */
            #socialShare div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 12px !important;
            }

            .social-btn {
                justify-content: center !important;
                padding: 14px 20px !important;
                font-size: 16px !important;
            }

            /* ãƒ¬ãƒƒã‚¹ãƒ³æ¡ˆå†…ã‚’ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èª¿æ•´ */
            #lessonPromotion {
                padding: 20px 15px !important;
            }

            #lessonPromotion div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 15px !important;
            }

            #lessonPromotion img {
                width: 70px !important;
                height: 70px !important;
            }

            #lessonPromotion h3 {
                font-size: 18px !important;
            }

            #lessonPromotion p {
                font-size: 14px !important;
            }

            /* ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯æŒ‡ç¤ºã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            #ballPositionInstruction {
                font-size: 14px !important;
                padding: 8px 12px !important;
                top: 5px !important;
                right: 5px !important;
            }

            /* ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            #imageContainer {
                margin: 15px 0;
            }

            #uploadedImage {
                max-height: 450px !important; /* ã‚¹ãƒãƒ›ã§ã‚‚ã‚ˆã‚Šå¤§ãã */
            }
        }

        /* å°ã•ãªã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ */
        @media (max-width: 480px) {
            .radar-container {
                height: 600px !important; /* å°å‹ã‚¹ãƒãƒ›ã§ã‚‚å¤§ãã */
            }
            .container {
                padding: 8px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .upload-area {
                padding: 25px 15px;
            }

            .upload-icon {
                font-size: 2.5em;
            }

            /* ãƒœã‚¿ãƒ³ã®ã‚¿ãƒƒãƒå¯¾å¿œ */
            .control-group select,
            .control-group button {
                min-height: 48px !important; /* ã‚¿ãƒƒãƒã—ã‚„ã™ã„ã‚µã‚¤ã‚º */
                font-size: 16px !important; /* ã‚ºãƒ¼ãƒ é˜²æ­¢ */
                padding: 12px 15px !important;
            }

            .upload-text {
                font-size: 14px;
            }

            .control-group select,
            .control-group button {
                font-size: 14px;
                padding: 10px;
            }

            .score-feedback-item {
                padding: 12px;
            }

            .score-title {
                font-size: 14px;
            }

            .score-value {
                font-size: 16px;
            }

            .advice-text {
                font-size: 15px; /* å°å‹ã‚¹ãƒãƒ›ã§ã‚‚èª­ã¿ã‚„ã™ã */
            }

            #lessonPromotion {
                padding: 15px 10px !important;
            }

            #lessonPromotion h3 {
                font-size: 16px !important;
            }

            #lessonPromotion p {
                font-size: 13px !important;
            }

            #uploadedImage {
                max-height: 350px !important; /* å°å‹ã‚¹ãƒãƒ›ã§ã‚‚ã‚ˆã‚Šå¤§ãã */
            }
        }

        /* ãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        @media (max-width: 768px) and (orientation: landscape) {
            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 0.9em;
            }

            #uploadedImage {
                max-height: 200px !important;
            }
            
            .radar-container {
                height: 500px !important; /* ãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ã§ã‚‚å¤§ãã */
            }
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆèª¿æ•´ */
        @media (max-width: 768px) {
            .radar-container canvas {
                max-width: 100% !important;
                max-height: 650px !important; /* ã‚­ãƒ£ãƒ³ãƒã‚¹æœ€å¤§ã‚µã‚¤ã‚º */
            }
            
            /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§ã‚‚æ–‡å­—ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ä½™ç™½ã‚’ç¢ºä¿ */
            .radar-container {
                margin: 10px 0 !important;
                padding: 5px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒï¸ ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
            <p>AIæ­è¼‰ - MediaPipe & ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆåˆ†æç‰ˆ</p>
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 2px solid #ddd; display: flex; align-items: center; gap: 15px;">
                <a href="https://noyamagolf.com/" target="_blank" style="display: block; flex-shrink: 0;">
                    <img src="noyama-keiji.png" alt="é‡å±±ä½³æ²»" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #007bff; object-fit: cover; cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #007bff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: none; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px; cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">é‡å±±</div>
                </a>
                <div style="flex: 1; color: #333;">
                    <h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: bold; color: #007bff;">
                        ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ—ãƒ­é‡å±±ä½³æ²»ç›£ä¿®
                    </h3>
                    <p style="margin: 0; font-size: 14px; color: #666;">
                        <a href="https://noyamagolf.com/" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 500;">
                            ğŸŒ https://noyamagolf.com/
                        </a>
                    </p>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                <div class="upload-icon">ğŸ“¸</div>
                <div class="upload-text">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                <p>JPG, PNG, GIFå½¢å¼ã«å¯¾å¿œ</p>
                
                <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼šã‚«ãƒ¡ãƒ©ã¨ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®é¸æŠãƒœã‚¿ãƒ³ -->
                <div id="mobileButtons" style="display: none; gap: 10px; margin-top: 15px;">
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                    <input type="file" id="galleryInput" accept="image/*" style="display: none;">
                    <button type="button" onclick="document.getElementById('cameraInput').click()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 14px; cursor: pointer;">ğŸ“· ã‚«ãƒ¡ãƒ©</button>
                    <button type="button" onclick="document.getElementById('galleryInput').click()" style="padding: 10px 20px; background: #764ba2; color: white; border: none; border-radius: 5px; font-size: 14px; cursor: pointer;">ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼</button>
                </div>
            </div>
            <input type="file" id="imageInput" class="file-input" accept="image/*">
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="viewSelect">æ’®å½±è¦–ç‚¹:</label>
                <select id="viewSelect">
                    <option value="front">æ­£é¢</option>
                    <option value="back">å¾Œæ–¹</option>
                </select>
            </div>
            <div class="control-group">
                <label for="clubSelect">ã‚¯ãƒ©ãƒ–é¸æŠ:</label>
                <select id="clubSelect">
                    <option value="Driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
                    <option value="FairwayWood">ãƒ•ã‚§ã‚¢ã‚¦ã‚§ã‚¤ã‚¦ãƒƒãƒ‰</option>
                    <option value="Utility">ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¼</option>
                    <option value="3Iron">3ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="4Iron">4ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="5Iron">5ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="6Iron">6ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="7Iron" selected>7ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="8Iron">8ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="9Iron">9ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="Wedge">ã‚¦ã‚¨ãƒƒã‚¸</option>
                </select>
            </div>
            <div class="control-group">
                <button id="startDiagnosis" class="btn">ğŸ” è¨ºæ–­é–‹å§‹</button>
            </div>
        </div>

        <div id="analysisResults" class="hidden">
            <div class="analysis-container">
                <div class="image-section">
                    <h3>ğŸ“Š å§¿å‹¢åˆ†æçµæœ</h3>
                    <div class="image-container" id="imageContainer">
                        <img id="uploadedImage" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ">
                        <canvas id="poseCanvas"></canvas>
                        <div class="click-instruction" id="clickInstruction">âš ï¸ æ­£é¢æ’®å½±æ™‚ï¼šä¸Šæ‰‹ãæ¤œå‡ºã•ã‚Œã¦ã„ãªã„ã¨ãã«ã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
                        <div class="ball-position-instruction" id="ballPositionInstruction">
                            ğŸŒï¸â€â™‚ï¸ ã‚´ãƒ«ãƒ•ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
                            <small>æ­£é¢æ’®å½±ã§ã¯å¿…é ˆã§ã™</small>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>ğŸ“ˆ ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</h3>
                    <div class="radar-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="score-feedback-grid" id="scoreFeedbackGrid">
                <!-- ã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’çµ±åˆè¡¨ç¤º -->
            </div>
            
            <!-- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
            <div id="socialShare" class="hidden" style="margin-top: 20px; padding: 20px; background: white; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">ğŸ“± è¨ºæ–­çµæœã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ï¼</h3>
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="shareToTwitter()" class="social-btn twitter-btn" style="background: #1DA1F2; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                        Twitter
                    </button>
                    
                    <button onclick="shareToFacebook()" class="social-btn facebook-btn" style="background: #4267B2; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </button>
                    
                    <button onclick="shareToLine()" class="social-btn line-btn" style="background: #00B900; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.349 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.629 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.070 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                        </svg>
                        LINE
                    </button>
                    
                    <button onclick="copyToClipboard()" class="social-btn copy-btn" style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                        URLã‚³ãƒ”ãƒ¼
                    </button>
                </div>
            </div>

            <!-- è¨ºæ–­çµæœå¾Œã®ãƒ¬ãƒƒã‚¹ãƒ³æ¡ˆå†… -->
            <div id="lessonPromotion" class="hidden" style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 15px; text-align: center; box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);">
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                    <a href="https://noyamagolf.com/" target="_blank" style="display: block;">
                        <img src="noyama-keiji.png" alt="é‡å±±ä½³æ²»" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; object-fit: cover; cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: none; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">é‡å±±</div>
                    </a>
                    <div style="color: white; text-align: left; flex: 1; min-width: 250px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: bold;">
                            ğŸŒï¸ è¨ºæ–­çµæœã‚’ã‚‚ã¨ã«ã€ã•ã‚‰ãªã‚‹ä¸Šé”ã‚’ç›®æŒ‡ã—ã¾ã›ã‚“ã‹ï¼Ÿ
                        </h3>
                        <p style="margin: 0 0 12px 0; font-size: 16px; line-height: 1.4;">
                            ãƒ—ãƒ­ãŒæ•™ãˆã‚‹å®Ÿè·µçš„ãªãƒ¬ãƒƒã‚¹ãƒ³ã§ã€ç†æƒ³ã®ã‚¹ã‚¤ãƒ³ã‚°ã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: flex-start; margin-bottom: 12px;">
                            <a href="https://noyamagolf.com/%e3%83%a9%e3%82%a6%e3%83%b3%e3%83%89%e3%83%ac%e3%83%83%e3%82%b9%e3%83%b3/" target="_blank" style="text-decoration: none;">
                                <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-size: 14px; color: white; border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">
                                    ğŸŒï¸ ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¬ãƒƒã‚¹ãƒ³
                                </div>
                            </a>
                            <a href="https://noyamagolf.com/%e3%82%aa%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%83%ac%e3%83%83%e3%82%b9%e3%83%b3/" target="_blank" style="text-decoration: none;">
                                <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-size: 14px; color: white; border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">
                                    ğŸ’» ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¬ãƒƒã‚¹ãƒ³
                                </div>
                            </a>
                            <a href="https://noyamagolf.com/%e3%82%b9%e3%82%bf%e3%82%b8%e3%82%aa%e3%83%ac%e3%83%83%e3%82%b9%e3%83%b3/" target="_blank" style="text-decoration: none;">
                                <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-size: 14px; color: white; border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">
                                    ğŸ‘¨â€ğŸ« ãƒãƒ³ãƒ„ãƒ¼ãƒãƒ³ãƒ¬ãƒƒã‚¹ãƒ³
                                </div>
                            </a>
                        </div>
                        <p style="margin: 0; font-size: 16px;">
                            <a href="https://noyamagolf.com/" target="_blank" style="color: #FFD700; text-decoration: underline; font-weight: bold; font-size: 18px;">é‡å±±ä½³æ²»ã®ã‚´ãƒ«ãƒ•ãƒ¬ãƒƒã‚¹ãƒ³</a> ã§è©³ç´°ã‚’ã”ç¢ºèªãã ã•ã„
                        </p>
                    </div>
                    <div style="color: white; font-size: 40px;">â›³</div>
                </div>
            </div>
        </div>

        <div id="loadingSection" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>AIåˆ†æä¸­...</p>
        </div>
    </div>

    <script>
        let pose;
        let camera;
        let poseResults;
        let uploadedImageElement;
        let radarChartInstance;
        let userClickedBallPosition = null;
        let isBallPositionClickEnabled = false;
        let isDiagnosisStarted = false; // è¨ºæ–­é–‹å§‹ãƒ•ãƒ©ã‚°

        // MediaPipe PoseåˆæœŸåŒ–
        function initMediaPipe() {
            try {
                if (typeof Pose === 'undefined') {
                    console.error('MediaPipe Poseãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    alert('MediaPipeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                pose = new Pose({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                    }
                });

                // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                console.log('ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º:', isMobile ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'PC');
                
                pose.setOptions({
                    modelComplexity: 0, // å…¨ãƒ‡ãƒã‚¤ã‚¹ã§è»½é‡ãƒ¢ãƒ¼ãƒ‰
                    smoothLandmarks: false, // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç„¡åŠ¹ã§é«˜é€ŸåŒ–
                    enableSegmentation: false,
                    smoothSegmentation: false, // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç„¡åŠ¹ã§é«˜é€ŸåŒ–
                    minDetectionConfidence: isMobile ? 0.5 : 0.7, // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯é©åº¦ãªé–¾å€¤
                    minTrackingConfidence: isMobile ? 0.5 : 0.7, // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯é©åº¦ãªé–¾å€¤
                    staticImageMode: true // é™çš„ç”»åƒãƒ¢ãƒ¼ãƒ‰
                });
                console.log('MediaPipeè¨­å®šå®Œäº†');

                pose.onResults(onPoseResults);
                console.log('MediaPipeåˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('MediaPipeåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('MediaPipeã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        }

        // Poseçµæœå‡¦ç†
        function onPoseResults(results) {
            console.log('MediaPipeçµæœå—ä¿¡:', results);
            poseResults = results;
            
            // å¿…ãšæç”»ã‚’å®Ÿè¡Œ
            if (uploadedImageElement) {
                console.log('æç”»ã‚’å®Ÿè¡Œã—ã¾ã™');
                drawPoseOverlay();
            }
            
            // åˆ†æã¯è¨ºæ–­ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®ã¿å®Ÿè¡Œ
            // analyzePosture();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('imageInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageUpload(e.target.files[0]);
            }
        });

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // Google Analytics ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
            if (typeof gtag !== 'undefined') {
                gtag('event', 'image_upload', {
                    'event_category': 'engagement',
                    'event_label': 'Golf Photo Upload'
                });
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('uploadedImage');
                img.src = e.target.result;
                img.onload = function() {
                    uploadedImageElement = img;
                    userClickedBallPosition = null; // ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                    isDiagnosisStarted = false; // è¨ºæ–­ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ç”»åƒã«åˆã‚ã›ã¦è¨­å®š
                    const canvas = document.getElementById('poseCanvas');
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ç”»åƒã®ã‚µã‚¤ã‚ºã‚’å–å¾—
                    setTimeout(() => {
                        const imgRect = img.getBoundingClientRect();
                        const containerRect = img.parentElement.getBoundingClientRect();
                        
                        // ç”»åƒã®å®Ÿéš›ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å–å¾—
                        const displayWidth = img.clientWidth;
                        const displayHeight = img.clientHeight;
                        
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’æ­£ç¢ºã«è¨­å®š
                        canvas.width = displayWidth;
                        canvas.height = displayHeight;
                        canvas.style.width = displayWidth + 'px';
                        canvas.style.height = displayHeight + 'px';
                        
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç”»åƒã¨å®Œå…¨ã«é‡ã­ã‚‹
                        canvas.style.position = 'absolute';
                        canvas.style.top = img.offsetTop + 'px';
                        canvas.style.left = img.offsetLeft + 'px';
                        canvas.style.transform = 'none';
                        canvas.style.display = 'block';
                        canvas.style.pointerEvents = 'auto';
                        
                        console.log('ã‚­ãƒ£ãƒ³ãƒã‚¹æœ€çµ‚è¨­å®š:', canvas.width, 'x', canvas.height);
                        console.log('ç”»åƒä½ç½®:', img.offsetTop, img.offsetLeft);
                    }, 150);
                    
                    console.log('ç”»åƒãƒ­ãƒ¼ãƒ‰å®Œäº†:', img.width, 'x', img.height);
                    console.log('ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º:', canvas.width, 'x', canvas.height);
                    
                    // åˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    document.getElementById('analysisResults').classList.remove('hidden');
                    
                    // ç”»åƒã‚’ç¢ºå®Ÿã«è¡¨ç¤º
                    img.style.display = 'block';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '400px';
                    img.style.borderRadius = '10px';
                    
                    setupBallPositionClick();
                    updateDiagnosisButtonState(); // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                    
                    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã«è‡ªå‹•ã§MediaPipeå‡¦ç†ã‚’å®Ÿè¡Œï¼ˆãƒãƒ¼ã‚ºæ¤œå‡ºã®ã¿ï¼‰
                    setTimeout(() => {
                        if (pose && uploadedImageElement) {
                            console.log('è‡ªå‹•MediaPipeå‡¦ç†é–‹å§‹');
                            pose.send({image: uploadedImageElement});
                        }
                    }, 800); // ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®šå¾Œã«å®Ÿè¡Œ
                };
            };
            reader.readAsDataURL(file);
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ã®è¨­å®šï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function setupBallPositionClick() {
            const viewType = document.getElementById('viewSelect').value;
            const canvas = document.getElementById('poseCanvas');
            const container = document.getElementById('imageContainer');
            const instruction = document.getElementById('clickInstruction');
            const ballInstruction = document.getElementById('ballPositionInstruction');
            
            if (viewType === 'front') {
                isBallPositionClickEnabled = true;
                canvas.style.pointerEvents = 'auto';
                canvas.style.cursor = 'crosshair';
                
                // æŒ‡ç¤ºã‚’è¡¨ç¤ºï¼ˆç°¡æ½”ã«ï¼‰
                instruction.style.display = 'block';
                ballInstruction.style.display = 'block';
                ballInstruction.innerHTML = 'ğŸŒï¸â€â™‚ï¸ ã‚´ãƒ«ãƒ•ãƒœãƒ¼ãƒ«<br>ã‚¯ãƒªãƒƒã‚¯';
                ballInstruction.style.backgroundColor = 'rgba(255, 215, 0, 0.85)';
                ballInstruction.style.borderColor = '#FFD700';
                
                // ã‚¯ãƒªãƒƒã‚¯ãƒ»ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                canvas.removeEventListener('click', handleBallPositionClick); // é‡è¤‡é˜²æ­¢
                canvas.removeEventListener('touchstart', handleBallPositionClick); // é‡è¤‡é˜²æ­¢
                canvas.addEventListener('click', handleBallPositionClick);
                canvas.addEventListener('touchstart', handleBallPositionClick, { passive: false });
                
                // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼åŠ¹æœ
                canvas.addEventListener('mouseenter', () => {
                    ballInstruction.style.backgroundColor = 'rgba(255, 215, 0, 1)';
                    ballInstruction.style.transform = 'translateX(-50%) scale(1.05)';
                });
                
                canvas.addEventListener('mouseleave', () => {
                    ballInstruction.style.backgroundColor = 'rgba(255, 215, 0, 0.9)';
                    ballInstruction.style.transform = 'translateX(-50%) scale(1)';
                });
                
                // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateDiagnosisButtonState();
                
                // 7ç§’å¾Œã«ä¸Šéƒ¨æŒ‡ç¤ºã‚’éè¡¨ç¤º
                setTimeout(() => {
                    instruction.style.display = 'none';
                }, 7000);
            } else {
                isBallPositionClickEnabled = false;
                canvas.style.pointerEvents = 'none';
                canvas.style.cursor = 'default';
                instruction.style.display = 'none';
                ballInstruction.style.display = 'none';
                canvas.removeEventListener('click', handleBallPositionClick);
                
                // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateDiagnosisButtonState();
            }
        }

        // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateDiagnosisButtonState() {
            const diagnosisBtn = document.getElementById('startDiagnosis');
            const viewType = document.getElementById('viewSelect').value;
            
            if (viewType === 'front') {
                if (userClickedBallPosition) {
                    // ãƒœãƒ¼ãƒ«ä½ç½®ãŒè¨­å®šæ¸ˆã¿ - ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    diagnosisBtn.disabled = false;
                    diagnosisBtn.textContent = 'ğŸ” è¨ºæ–­é–‹å§‹';
                    diagnosisBtn.style.opacity = '1';
                    diagnosisBtn.style.cursor = 'pointer';
                } else {
                    // ãƒœãƒ¼ãƒ«ä½ç½®ãŒæœªè¨­å®š - ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                    diagnosisBtn.disabled = true;
                    diagnosisBtn.textContent = 'ğŸŒï¸â€â™‚ï¸ ã‚´ãƒ«ãƒ•ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
                    diagnosisBtn.style.opacity = '0.6';
                    diagnosisBtn.style.cursor = 'not-allowed';
                }
            } else {
                // å¾Œæ–¹è¦–ç‚¹ã§ã¯é€šå¸¸é€šã‚Šæœ‰åŠ¹
                diagnosisBtn.disabled = false;
                diagnosisBtn.textContent = 'ğŸ” è¨ºæ–­é–‹å§‹';
                diagnosisBtn.style.opacity = '1';
                diagnosisBtn.style.cursor = 'pointer';
            }
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function handleBallPositionClick(event) {
            if (!isBallPositionClickEnabled) return;
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’é˜²æ­¢
            if (event.type === 'touchstart') {
                event.preventDefault();
            }
            
            const canvas = document.getElementById('poseCanvas');
            const rect = canvas.getBoundingClientRect();
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã¨ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®åº§æ¨™å–å¾—ã‚’çµ±ä¸€
            let clientX, clientY;
            if (event.type === 'touchstart' && event.touches.length > 0) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            // è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å–å¾—ï¼ˆCSSã‚µã‚¤ã‚ºï¼‰
            const displayWidth = rect.width;
            const displayHeight = rect.height;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’æ­£è¦åŒ–ï¼ˆ0-1ã®ç¯„å›²ï¼‰
            const normalizedX = x / displayWidth;
            const normalizedY = y / displayHeight;
            
            userClickedBallPosition = { x: normalizedX, y: normalizedY };
            
            // ãƒœãƒ¼ãƒ«ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
            showBallPositionMarker(x, y);
            
            // æŒ‡ç¤ºã‚’æ›´æ–°
            const ballInstruction = document.getElementById('ballPositionInstruction');
            ballInstruction.innerHTML = 'âœ… ãƒœãƒ¼ãƒ«ä½ç½®ãŒè¨­å®šã•ã‚Œã¾ã—ãŸï¼<br><small>è¨ºæ–­é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</small>';
            ballInstruction.style.backgroundColor = 'rgba(40, 167, 69, 0.9)';
            ballInstruction.style.borderColor = '#28a745';
            
            // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateDiagnosisButtonState();
            
            // è¨ºæ–­é–‹å§‹ã¾ã§è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼ˆã‚¿ã‚¤ãƒãƒ¼å‰Šé™¤ï¼‰
            // setTimeout(() => {
            //     ballInstruction.style.display = 'none';
            // }, 5000);
            
            console.log('ãƒœãƒ¼ãƒ«ä½ç½®ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', userClickedBallPosition);
            console.log('ã‚¯ãƒªãƒƒã‚¯åº§æ¨™:', x, y, 'ã‚­ãƒ£ãƒ³ãƒã‚¹è¡¨ç¤ºã‚µã‚¤ã‚º:', displayWidth, displayHeight);
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
        function showBallPositionMarker(x, y) {
            const container = document.getElementById('imageContainer');
            
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            const existingMarker = container.querySelector('.ball-position-marker');
            if (existingMarker) {
                existingMarker.remove();
            }
            
            // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
            const marker = document.createElement('div');
            marker.className = 'ball-position-marker';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            
            container.appendChild(marker);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading() {
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('analysisResults').classList.add('hidden');
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('analysisResults').classList.remove('hidden');
            // è¨ºæ–­çµæœå¾Œã®ãƒ¬ãƒƒã‚¹ãƒ³æ¡ˆå†…ã‚’è¡¨ç¤º
            document.getElementById('lessonPromotion').classList.remove('hidden');
            
            // ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('socialShare').classList.remove('hidden');
        }

        // ç”»åƒå‡¦ç†
        async function processImage() {
            if (!uploadedImageElement) {
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            if (!pose) {
                console.error('MediaPipeãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                alert('MediaPipeã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                return;
            }

            console.log('MediaPipeå‡¦ç†é–‹å§‹...');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æº–å‚™
            const canvas = document.getElementById('poseCanvas');
            if (!canvas) {
                console.error('poseCanvasãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            canvas.width = uploadedImageElement.clientWidth || uploadedImageElement.width;
            canvas.height = uploadedImageElement.clientHeight || uploadedImageElement.height;
            
            // MediaPipeã§ãƒãƒ¼ã‚ºæ¤œå‡ºï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
            try {
                showLoading(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                console.log('MediaPipeå‡¦ç†é–‹å§‹ - ç”»åƒã‚µã‚¤ã‚º:', uploadedImageElement.width, 'x', uploadedImageElement.height);
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆã‚¹ãƒãƒ›ã§ã¯çŸ­ã‚ã«ï¼‰
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const timeout = isMobile ? 8000 : 5000; // ãƒ¢ãƒã‚¤ãƒ«ã¯8ç§’ã€PCã¯5ç§’
                
                let processCompleted = false;
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
                const timeoutHandler = setTimeout(() => {
                    if (!processCompleted) {
                        console.warn('MediaPipeå‡¦ç†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                        hideLoading();
                        showFallbackMode();
                    }
                }, timeout);
                
                // MediaPipeé€ä¿¡
                await pose.send({image: uploadedImageElement});
                console.log('MediaPipeé€ä¿¡å®Œäº†');
                
                // çµæœãƒã‚§ãƒƒã‚¯ï¼ˆçŸ­æ™‚é–“ã§è¤‡æ•°å›ï¼‰
                let checkCount = 0;
                const maxChecks = isMobile ? 8 : 5;
                const checkInterval = 1000;
                
                const resultChecker = setInterval(() => {
                    checkCount++;
                    console.log(`çµæœãƒã‚§ãƒƒã‚¯ ${checkCount}/${maxChecks}`, poseResults ? 'ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'ãƒ‡ãƒ¼ã‚¿ãªã—');
                    
                    if (poseResults && poseResults.poseLandmarks) {
                        // æˆåŠŸï¼šãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿å–å¾—
                        clearInterval(resultChecker);
                        clearTimeout(timeoutHandler);
                        processCompleted = true;
                        hideLoading();
                        console.log('ãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', poseResults.poseLandmarks.length, 'ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯');
                        drawPoseOverlay();
                        analyzePosture();
                    } else if (checkCount >= maxChecks) {
                        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰
                        clearInterval(resultChecker);
                        clearTimeout(timeoutHandler);
                        processCompleted = true;
                        hideLoading();
                        console.log('æœ€å¤§ãƒã‚§ãƒƒã‚¯å›æ•°åˆ°é” - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰');
                        showFallbackMode();
                    }
                }, checkInterval);
                
            } catch (error) {
                hideLoading();
                console.error('MediaPipeå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                showFallbackMode();
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ˆMediaPipeãªã—ã§ã‚‚è¨ºæ–­å¯èƒ½ï¼‰
        function showFallbackMode() {
            const canvas = document.getElementById('poseCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
            ctx.fillStyle = 'rgba(0, 150, 255, 0.8)';
            ctx.fillRect(10, 10, canvas.width - 20, 80);
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('ğŸ“· æ‰‹å‹•è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰', 20, 35);
            ctx.font = '14px Arial';
            ctx.fillText('ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ã‚¿ãƒƒãƒ—ã—ã¦è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 20, 55);
            ctx.fillText('ï¼ˆAIè‡ªå‹•æ¤œå‡ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸï¼‰', 20, 75);
            
            // æ‰‹å‹•ãƒœãƒ¼ãƒ«ä½ç½®é¸æŠã‚’æœ‰åŠ¹åŒ–
            setTimeout(() => {
                enableManualBallPositioning();
            }, 1500);
        }
        
        // æ‰‹å‹•ãƒœãƒ¼ãƒ«ä½ç½®é¸æŠã‚’æœ‰åŠ¹åŒ–
        function enableManualBallPositioning() {
            isBallPositionClickEnabled = true;
            const canvas = document.getElementById('poseCanvas');
            canvas.style.cursor = 'crosshair';
            
            // æŒ‡ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
            showBallPositionClickInstruction();
            updateDiagnosisButtonState();
            
            console.log('æ‰‹å‹•ãƒœãƒ¼ãƒ«ä½ç½®é¸æŠãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–');
        }

        // ãƒãƒ¼ã‚ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”»ï¼ˆå¼·åˆ¶è¡¨ç¤ºï¼‰
        function drawPoseOverlay() {
            const canvas = document.getElementById('poseCanvas');
            const ctx = canvas.getContext('2d');
            const img = uploadedImageElement;

            if (!canvas || !ctx || !img) {
                console.log('æç”»è¦ç´ ãŒä¸è¶³:', {canvas: !!canvas, ctx: !!ctx, img: !!img});
                return;
            }

            // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”»åƒã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const displayedWidth = img.clientWidth || img.offsetWidth;
            const displayedHeight = img.clientHeight || img.offsetHeight;
            
            // å…ƒç”»åƒã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const originalWidth = img.naturalWidth || img.width;
            const originalHeight = img.naturalHeight || img.height;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
            canvas.width = displayedWidth;
            canvas.height = displayedHeight;
            canvas.style.width = displayedWidth + 'px';
            canvas.style.height = displayedHeight + 'px';

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            console.log('æç”»é–‹å§‹ - è¡¨ç¤ºã‚µã‚¤ã‚º:', displayedWidth, 'x', displayedHeight);
            console.log('å…ƒç”»åƒã‚µã‚¤ã‚º:', originalWidth, 'x', originalHeight);

            if (poseResults && poseResults.poseLandmarks && poseResults.poseLandmarks.length > 0) {
                console.log('MediaPipe landmarks detected:', poseResults.poseLandmarks.length);
                
                // ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ç‡ã‚’è¨ˆç®—ï¼ˆMediaPipeã®åº§æ¨™ã¯0-1ã®ç¯„å›²ï¼‰
                const scaleX = displayedWidth;
                const scaleY = displayedHeight;
                
                // æ¥ç¶šç·šã‚’å…ˆã«æç”»ï¼ˆèƒŒæ™¯ï¼‰
                drawConnections(ctx, poseResults.poseLandmarks, scaleX, scaleY);
                
                // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’ä¸Šã«æç”»ï¼ˆå‰æ™¯ï¼‰
                drawLandmarks(ctx, poseResults.poseLandmarks, scaleX, scaleY);
                
                // ãƒœãƒ¼ãƒ«ä½ç½®ã¨ç†æƒ³ä½ç½®ã‚’æç”»ï¼ˆæ­£é¢ã‹ã‚‰ã®å ´åˆã¯è‡ªå‹•æ¤œå‡ºã‚’è©¦è¡Œï¼‰
                const viewType = document.getElementById('viewSelect').value;
                if (viewType === 'front') {
                    tryAutomaticBallDetection(ctx, poseResults.poseLandmarks, scaleX, scaleY);
                } else {
                    drawBallPosition(ctx, poseResults.poseLandmarks, scaleX, scaleY);
                }
            } else {
                console.log('No pose landmarks detected or empty result');
                // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæ¤œå‡ºã•ã‚Œãªã„å ´åˆã§ã‚‚ä½•ã‹ã‚’æç”»
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.fillRect(10, 10, 200, 30);
                ctx.fillStyle = '#000';
                ctx.font = '14px Arial';
                ctx.fillText('MediaPipe: ãƒãƒ¼ã‚ºæ¤œå‡ºä¸­...', 15, 30);
            }
        }

        // è‡ªå‹•ãƒœãƒ¼ãƒ«ä½ç½®æ¤œå‡ºã‚’è©¦è¡Œ
        function tryAutomaticBallDetection(ctx, landmarks, width, height) {
            const clubType = document.getElementById('clubSelect').value;
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            
            if (!leftAnkle || !rightAnkle || !leftWrist || !rightWrist) {
                // å¿…è¦ãªãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯æ‰‹å‹•é¸æŠã«åˆ‡ã‚Šæ›¿ãˆ
                showBallPositionClickInstruction();
                return;
            }
            
            // æ‰‹ã®ä½ç½®ã‹ã‚‰è‡ªå‹•ã§ãƒœãƒ¼ãƒ«ä½ç½®ã‚’æ¨å®š
            const handCenter = (leftWrist.x + rightWrist.x) / 2;
            const footY = Math.max(leftAnkle.y, rightAnkle.y);
            
            // æ¨å®šä¿¡é ¼åº¦ã‚’è¨ˆç®—ï¼ˆæ‰‹é¦–ã®æ¤œå‡ºä¿¡é ¼åº¦ãŒä½ã„å ´åˆã¯æ‰‹å‹•é¸æŠï¼‰
            const confidence = Math.min(leftWrist.visibility, rightWrist.visibility);
            
            if (confidence < 0.7) {
                // ä¿¡é ¼åº¦ãŒä½ã„å ´åˆã¯æ‰‹å‹•é¸æŠã«åˆ‡ã‚Šæ›¿ãˆ
                showBallPositionClickInstruction();
                return;
            }
            
            // è‡ªå‹•æ¤œå‡ºæˆåŠŸ - ãƒœãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®š
            userClickedBallPosition = { x: handCenter, y: footY + 0.03 };
            
            // è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸãƒœãƒ¼ãƒ«ä½ç½®ã‚’æç”»
            drawAutomaticBallPosition(ctx, handCenter, footY, width, height);
            
            // ç†æƒ³ä½ç½®ã‚‚æç”»ï¼ˆè¨ºæ–­é–‹å§‹å¾Œã®ã¿ï¼‰
            if (isDiagnosisStarted) {
                drawIdealBallPosition(ctx, landmarks, width, height, clubType);
            }
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showAutoDetectionSuccess();
        }
        
        // è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸãƒœãƒ¼ãƒ«ä½ç½®ã‚’æç”»
        function drawAutomaticBallPosition(ctx, x, footY, width, height) {
            // è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸãƒœãƒ¼ãƒ«ä½ç½®ï¼ˆé’ã„å††ï¼‰
            ctx.fillStyle = '#0066FF';
            ctx.globalAlpha = 0.8;
            ctx.beginPath();
            ctx.arc(x * width, (footY + 0.03) * height, 10, 0, 2 * Math.PI);
            ctx.fill();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#0066FF';
            ctx.globalAlpha = 1.0;
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('è‡ªå‹•æ¤œå‡º', x * width, (footY + 0.03) * height - 15);
            
            // è¦–è¦šçš„ãƒãƒ¼ã‚«ãƒ¼ã‚‚è¡¨ç¤º
            const ballMarkerX = x * width;
            const ballMarkerY = (footY + 0.03) * height;
            showBallPositionMarker(ballMarkerX, ballMarkerY);
        }
        
        // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ã‚’æç”»
        function drawIdealBallPosition(ctx, landmarks, width, height, clubType) {
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const leftHeel = landmarks[29];
            const rightHeel = landmarks[30];
            
            if (!leftAnkle || !rightAnkle) return;
            
            // è¶³ã®ä½ç½®è¨ˆç®—
            const leftFootCenter = leftHeel ? leftHeel.x : leftAnkle.x;
            const rightFootCenter = rightHeel ? rightHeel.x : rightAnkle.x;
            const stanceCenter = (leftFootCenter + rightFootCenter) / 2;
            
            // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®
            const idealPositions = {
                'Driver': leftFootCenter,                // å·¦è¶³ã‹ã‹ã¨ä½ç½®
                'FairwayWood': leftFootCenter + 0.02,   // å·¦è¶³ã‹ã‹ã¨å†…å´ã‚ˆã‚Šå°‘ã—å³
                'Utility': stanceCenter - 0.02,        // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '3Iron': stanceCenter - 0.015,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '4Iron': stanceCenter - 0.01,          // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '5Iron': stanceCenter - 0.005,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '6Iron': stanceCenter,                  // ä¸­å¤®
                '7Iron': stanceCenter,                  // ä¸­å¤®
                '8Iron': stanceCenter + 0.005,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³
                '9Iron': stanceCenter + 0.01,          // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³
                'Wedge': stanceCenter + 0.03           // ä¸­å¤®ã‚ˆã‚Šå³
            };
            
            const idealPosition = idealPositions[clubType] || stanceCenter;
            const footY = Math.max(leftAnkle.y, rightAnkle.y);
            
            // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ã‚’ç·‘ã®å††ã§æç”»
            ctx.fillStyle = '#00FF00';
            ctx.globalAlpha = 0.7;
            ctx.beginPath();
            ctx.arc(idealPosition * width, footY * height + 20, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#00FF00';
            ctx.globalAlpha = 1.0;
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ç†æƒ³ä½ç½®', idealPosition * width, footY * height + 5);
        }
        
        // è‡ªå‹•æ¤œå‡ºæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showAutoDetectionSuccess() {
            const ballInstruction = document.getElementById('ballPositionInstruction');
            if (ballInstruction) {
                ballInstruction.innerHTML = 'âœ… ãƒœãƒ¼ãƒ«ä½ç½®ã‚’è‡ªå‹•æ¤œå‡ºã—ã¾ã—ãŸï¼<br><small>æ­£ã—ãæ¤œå‡ºã•ã‚Œã¦ã„ãªã„æ™‚ã¯ãƒœãƒ¼ãƒ«ã®ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</small>';
                ballInstruction.style.backgroundColor = 'rgba(40, 167, 69, 0.9)';
                ballInstruction.style.display = 'block';
                
                // è¨ºæ–­é–‹å§‹ã¾ã§è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼ˆã‚¿ã‚¤ãƒãƒ¼å‰Šé™¤ï¼‰
                // setTimeout(() => {
                //     ballInstruction.style.display = 'none';
                // }, 5000);
            }
            
            // è¨ºæ–­ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            updateDiagnosisButtonState();
            
            // æ‰‹å‹•èª¿æ•´ã®ãŸã‚ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ã‚‚æœ‰åŠ¹ã«ã—ã¦ãŠã
            isBallPositionClickEnabled = true;
            const canvas = document.getElementById('poseCanvas');
            canvas.style.cursor = 'crosshair';
            canvas.removeEventListener('click', handleBallPositionClick);
            canvas.removeEventListener('touchstart', handleBallPositionClick);
            canvas.addEventListener('click', handleBallPositionClick);
            canvas.addEventListener('touchstart', handleBallPositionClick, { passive: false });
        }
        
        // ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯æŒ‡ç¤ºã‚’è¡¨ç¤º
        function showBallPositionClickInstruction() {
            const ballInstruction = document.getElementById('ballPositionInstruction');
            if (ballInstruction) {
                ballInstruction.innerHTML = 'ğŸŒï¸â€â™‚ï¸ è‡ªå‹•æ¤œå‡ºå¤±æ•—<br>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
                ballInstruction.style.backgroundColor = 'rgba(255, 140, 0, 0.9)';
                ballInstruction.style.display = 'block';
            }
            
            // æ‰‹å‹•ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
            isBallPositionClickEnabled = true;
            const canvas = document.getElementById('poseCanvas');
            canvas.style.cursor = 'crosshair';
            canvas.removeEventListener('click', handleBallPositionClick);
            canvas.removeEventListener('touchstart', handleBallPositionClick);
            canvas.addEventListener('click', handleBallPositionClick);
            canvas.addEventListener('touchstart', handleBallPositionClick, { passive: false });
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®æç”»ï¼ˆå¾Œæ–¹è¦–ç‚¹ç”¨ï¼‰
        function drawBallPosition(ctx, landmarks, width, height) {
            const clubType = document.getElementById('clubSelect').value;
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const leftHeel = landmarks[29];
            const rightHeel = landmarks[30];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            
            if (!leftAnkle || !rightAnkle) return;
            
            // è¶³ã®ä½ç½®è¨ˆç®—
            const leftFootCenter = leftHeel ? leftHeel.x : leftAnkle.x;
            const rightFootCenter = rightHeel ? rightHeel.x : rightAnkle.x;
            const stanceCenter = (leftFootCenter + rightFootCenter) / 2;
            
            // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®
            const idealPositions = {
                'Driver': leftFootCenter,                // å·¦è¶³ã‹ã‹ã¨ä½ç½®
                'FairwayWood': leftFootCenter + 0.01,
                'Utility': stanceCenter - 0.02,
                '3Iron': stanceCenter - 0.015,
                '4Iron': stanceCenter - 0.01,
                '5Iron': stanceCenter - 0.005,
                '6Iron': stanceCenter,
                '7Iron': stanceCenter,
                '8Iron': stanceCenter + 0.005,
                '9Iron': stanceCenter + 0.01,
                'Wedge': stanceCenter + 0.03
            };
            
            const idealPosition = idealPositions[clubType] || stanceCenter;
            
            // æ¨å®šãƒœãƒ¼ãƒ«ä½ç½®
            let estimatedBallPosition = stanceCenter;
            if (leftWrist && rightWrist) {
                const handCenter = (leftWrist.x + rightWrist.x) / 2;
                estimatedBallPosition = handCenter;
            }
            
            // è¶³å…ƒã®é«˜ã•ã‚’å–å¾—
            const footY = Math.max(leftAnkle.y, rightAnkle.y);
            
            // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ã‚’ç·‘ã®å††ã§æç”»ï¼ˆè¨ºæ–­é–‹å§‹å¾Œã®ã¿ï¼‰
            if (isDiagnosisStarted) {
                ctx.fillStyle = '#00FF00';
                ctx.globalAlpha = 0.7;
                ctx.beginPath();
                ctx.arc(idealPosition * width, footY * height + 20, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // ãƒ©ãƒ™ãƒ«
                ctx.fillStyle = '#00FF00';
                ctx.globalAlpha = 1.0;
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ç†æƒ³', idealPosition * width, footY * height + 45);
            }
            
            // æ¨å®šãƒœãƒ¼ãƒ«ä½ç½®ã‚’é’ã„å††ã§æç”»
            ctx.fillStyle = '#0066FF';
            ctx.globalAlpha = 0.7;
            ctx.beginPath();
            ctx.arc(estimatedBallPosition * width, footY * height + 20, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#0066FF';
            ctx.globalAlpha = 1.0;
            ctx.fillText('æ¨å®š', estimatedBallPosition * width, footY * height + 65);
            
            ctx.globalAlpha = 1.0;
        }

        // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æç”»ï¼ˆMediaPipeæ¨™æº–ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»å¼·åŒ–ç‰ˆï¼‰
        function drawLandmarks(ctx, landmarks, width, height) {
            console.log('Drawing landmarks, count:', landmarks.length);
            
            landmarks.forEach((landmark, index) => {
                // ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯ã‚’ç·©ãã—ã¦ã€ã‚ˆã‚Šå¤šãã®ç‚¹ã‚’è¡¨ç¤º
                if (landmark.visibility < 0.3) return; 
                
                const x = landmark.x * width;
                const y = landmark.y * height;
                
                // éƒ¨ä½åˆ¥ã®è‰²åˆ†ã‘ï¼ˆã‚ˆã‚Šé®®ã‚„ã‹ãªè‰²ï¼‰
                let color;
                if (index <= 10) {
                    color = '#FF4500'; // é¡”ãƒ»é ­éƒ¨ï¼šèµ¤ã‚ªãƒ¬ãƒ³ã‚¸
                } else if (index >= 11 && index <= 22) {
                    color = '#00CED1'; // ä¸ŠåŠèº«ï¼šãƒ€ãƒ¼ã‚¯ã‚¿ãƒ¼ã‚³ã‚¤ã‚º
                } else {
                    color = '#1E90FF'; // ä¸‹åŠèº«ï¼šãƒ‰ãƒƒã‚¸ãƒ–ãƒ«ãƒ¼
                }
                
                // é‡è¦ãªé–¢ç¯€ç‚¹ã¯å¤§ããè¡¨ç¤ºï¼ˆã•ã‚‰ã«å°ã•ãï¼‰
                const isKeyPoint = [0, 11, 12, 13, 14, 15, 16, 23, 24, 25, 26, 27, 28].includes(index);
                const radius = isKeyPoint ? 2 : 1; // ã•ã‚‰ã«å°ã•ã
                
                // é–¢ç¯€ç‚¹ã‚’èµ¤ã„å††ã§æç”»
                ctx.fillStyle = '#FF0000'; // èµ¤è‰²ã«çµ±ä¸€
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.fill();
                
                // ç•ªå·è¡¨ç¤ºã‚’å‰Šé™¤ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
                // if (isKeyPoint) {
                //     ctx.fillStyle = '#FFFFFF';
                //     ctx.font = 'bold 12px Arial';
                //     ctx.textAlign = 'center';
                //     ctx.strokeStyle = '#000000';
                //     ctx.lineWidth = 3;
                //     ctx.strokeText(index.toString(), x, y + 4);
                //     ctx.fillText(index.toString(), x, y + 4);
                // }
            });
        }

        // æ¥ç¶šç·šæç”»ï¼ˆMediaPipeæ¨™æº–æº–æ‹ ãƒ»å¼·åŒ–ç‰ˆï¼‰
        function drawConnections(ctx, landmarks, width, height) {
            console.log('Drawing connections...');
            ctx.lineWidth = 2; // ç´°ã„ç·š

            // MediaPipe Poseæ¨™æº–ã®æ¥ç¶šç·šå®šç¾©
            const connections = [
                // é¡”
                [0, 1], [1, 2], [2, 3], [3, 7], [0, 4], [4, 5], [5, 6], [6, 8],
                // ä¸ŠåŠèº«
                [9, 10], [11, 12], [11, 13], [13, 15], [15, 17], [15, 19], [15, 21], [17, 19],
                [12, 14], [14, 16], [16, 18], [16, 20], [16, 22], [18, 20],
                [11, 23], [12, 24], [23, 24],
                // ä¸‹åŠèº«
                [23, 25], [25, 27], [27, 29], [29, 31], [27, 31],
                [24, 26], [26, 28], [28, 30], [30, 32], [28, 32]
            ];

            connections.forEach(([start, end]) => {
                // ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯ã‚’ç·©ãã—ã¦ã€ã‚ˆã‚Šå¤šãã®ç·šã‚’è¡¨ç¤º
                if (landmarks[start] && landmarks[end] && 
                    landmarks[start].visibility > 0.3 && landmarks[end].visibility > 0.3) {
                    
                    // è‰²ã‚’ç·‘è‰²ã«çµ±ä¸€
                    ctx.strokeStyle = '#00FF00'; // ã™ã¹ã¦ã®æ¥ç¶šç·šã‚’ç·‘è‰²ã«
                    
                    // å½±ä»˜ãã®ç·šã‚’æç”»
                    ctx.shadowColor = 'rgba(0,0,0,0.3)';
                    ctx.shadowBlur = 2;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;
                    
                    ctx.beginPath();
                    ctx.moveTo(landmarks[start].x * width, landmarks[start].y * height);
                    ctx.lineTo(landmarks[end].x * width, landmarks[end].y * height);
                    ctx.stroke();
                    
                    // å½±ã‚’ãƒªã‚»ãƒƒãƒˆ
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                }
            });
        }

        // å§¿å‹¢åˆ†æ
        function analyzePosture() {
            console.log('åˆ†æé–‹å§‹ã€ãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿:', poseResults);
            
            if (!poseResults || !poseResults.poseLandmarks) {
                // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼šãƒœãƒ¼ãƒ«ä½ç½®ã®ã¿ã§åŸºæœ¬è¨ºæ–­
                if (userClickedBallPosition) {
                    console.log('æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ï¼šãƒœãƒ¼ãƒ«ä½ç½®ã®ã¿ã§è¨ºæ–­å®Ÿè¡Œ');
                    performManualAnalysis();
                } else {
                    alert('ãƒãƒ¼ã‚ºãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ‰‹å‹•è¨ºæ–­ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚');
                    hideLoading();
                }
                return;
            }

            const clubType = document.getElementById('clubSelect').value;
            const scores = calculatePostureScores(poseResults.poseLandmarks, clubType);
            
            console.log('è¨ˆç®—ã•ã‚ŒãŸã‚¹ã‚³ã‚¢:', scores);
            
            displayResults(scores);
            createRadarChart(scores);
            
            hideLoading();
        }
        
        // æ‰‹å‹•åˆ†æï¼ˆãƒœãƒ¼ãƒ«ä½ç½®ã®ã¿ï¼‰
        function performManualAnalysis() {
            const clubType = document.getElementById('clubSelect').value;
            const ballPos = userClickedBallPosition;
            
            console.log('æ‰‹å‹•åˆ†æé–‹å§‹ - ãƒœãƒ¼ãƒ«ä½ç½®:', ballPos, 'ã‚¯ãƒ©ãƒ–:', clubType);
            
            // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ç°¡æ˜“ã‚¹ã‚³ã‚¢è¨ˆç®—
            const manualScores = {
                ballPosition: calculateManualBallPositionScore(ballPos, clubType),
                bodyAlignment: 75, // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯å¹³å‡å€¤
                forwardTilt: 75,   // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯å¹³å‡å€¤
                kneeFlexion: 75,   // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯å¹³å‡å€¤
                stability: 80,     // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯å¹³å‡å€¤
                overall: 0
            };
            
            // å…¨ä½“ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆãƒœãƒ¼ãƒ«ä½ç½®ã‚’é‡è¦–ï¼‰
            manualScores.overall = Math.round(
                (manualScores.ballPosition * 0.4) +  // ãƒœãƒ¼ãƒ«ä½ç½®40%
                (manualScores.bodyAlignment * 0.15) + // ãã®ä»–å„15%
                (manualScores.forwardTilt * 0.15) +
                (manualScores.kneeFlexion * 0.15) +
                (manualScores.stability * 0.15)
            );
            
            console.log('æ‰‹å‹•åˆ†æã‚¹ã‚³ã‚¢:', manualScores);
            
            // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ç”¨ã®çµæœè¡¨ç¤º
            displayManualResults(manualScores, clubType);
        }
        
        // æ‰‹å‹•ãƒœãƒ¼ãƒ«ä½ç½®ã‚¹ã‚³ã‚¢è¨ˆç®—
        function calculateManualBallPositionScore(ballPos, clubType) {
            if (!ballPos) return 50;
            
            const x = ballPos.x; // 0-1ã®ç¯„å›²
            
            // ã‚¯ãƒ©ãƒ–ã‚¿ã‚¤ãƒ—åˆ¥ç†æƒ³ä½ç½®ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const idealPositions = {
                'driver': 0.4,    // å·¦å¯„ã‚Š
                'iron': 0.5,      // ä¸­å¤®
                'wedge': 0.55     // ã‚„ã‚„å³å¯„ã‚Š
            };
            
            const ideal = idealPositions[clubType] || 0.5;
            const deviation = Math.abs(x - ideal);
            
            // ã‚¹ã‚³ã‚¢è¨ˆç®—
            if (deviation < 0.05) return 95;
            if (deviation < 0.1) return 85;
            if (deviation < 0.15) return 75;
            if (deviation < 0.2) return 65;
            return 50;
        }
        
        // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰çµæœè¡¨ç¤º
        function displayManualResults(scores, clubType) {
            hideLoading();
            
            // é€šå¸¸ã®çµæœè¡¨ç¤ºã‚’ä½¿ç”¨ï¼ˆã‚¹ã‚³ã‚¢ã‚’èª¿æ•´æ¸ˆã¿ï¼‰
            displayResults(scores);
            
            // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã®æ³¨æ„äº‹é …ã‚’è¿½åŠ è¡¨ç¤º
            setTimeout(() => {
                const resultSection = document.getElementById('resultSection');
                if (resultSection) {
                    const manualNotice = document.createElement('div');
                    manualNotice.style.cssText = `
                        margin-top: 15px; 
                        padding: 15px; 
                        background: rgba(0, 150, 255, 0.1); 
                        border-left: 4px solid #0096ff; 
                        border-radius: 5px;
                        font-size: 14px;
                        color: #333;
                    `;
                    manualNotice.innerHTML = `
                        <strong>ğŸ“± æ‰‹å‹•è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰</strong><br>
                        AIãƒãƒ¼ã‚ºæ¤œå‡ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ãƒœãƒ¼ãƒ«ä½ç½®ã®ã¿ã§è¨ºæ–­ã—ã¾ã—ãŸã€‚<br>
                        ã‚ˆã‚Šè©³ç´°ãªè¨ºæ–­ã«ã¯ã€å…¨èº«ãŒå†™ã£ãŸé®®æ˜ãªç”»åƒã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
                    `;
                    resultSection.appendChild(manualNotice);
                }
            }, 500);
        }

        // å§¿å‹¢ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆè¦–ç‚¹åˆ¥ï¼‰
        function calculatePostureScores(landmarks, clubType) {
            const viewType = document.getElementById('viewSelect').value;
            let scores = {};

            if (viewType === 'front') {
                // æ­£é¢è¦–ç‚¹ï¼šãƒœãƒ¼ãƒ«ä½ç½®ã€ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã€é‡å¿ƒé…åˆ†ã€ãƒãƒ©ãƒ³ã‚¹ã€é ­ã®ä½ç½®
                const stanceResult = evaluateStanceWidth(landmarks, clubType);
                const balanceResult = evaluateBalance(landmarks);
                const headResult = evaluateHeadPosition(landmarks);
                const weightResult = evaluateWeightDistribution(landmarks, clubType);
                scores = {
                    ballPosition: evaluateBallPosition(landmarks, clubType).score,
                    ballPositionData: evaluateBallPosition(landmarks, clubType),
                    stance: stanceResult.score,
                    stanceStatus: stanceResult.status,
                    weight: weightResult.score,
                    weightData: weightResult,
                    balance: balanceResult.score,
                    balanceData: balanceResult,
                    headPosition: headResult.score,
                    headData: headResult
                };
            } else {
                // å¾Œæ–¹è¦–ç‚¹ï¼šä½“ã®å‘ãã€å‰å‚¾è§’åº¦ã€æ‰‹ã®ä½ç½®ã€å‰å¾Œã®é‡å¿ƒã€èƒŒç­‹ã®æ›²ãŒã‚Šå…·åˆ
                const bodyAlignmentResult = evaluateBodyAlignment(landmarks);
                const forwardTiltResult = evaluateForwardTilt(landmarks);
                const handPositionResult = evaluateHandPosition(landmarks, clubType);
                const spinalCurveResult = evaluateSpinalCurve(landmarks);
                
                scores = {
                    bodyAlignment: bodyAlignmentResult.score,
                    bodyAlignmentData: bodyAlignmentResult,
                    forwardTilt: forwardTiltResult.score,
                    forwardTiltData: forwardTiltResult,
                    handPosition: handPositionResult.score,
                    handPositionData: handPositionResult,
                    frontBackWeight: evaluateFrontBackWeight(landmarks),
                    spinalCurve: spinalCurveResult.score,
                    spinalCurveData: spinalCurveResult
                };
            }

            // ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆæ•°å€¤ã®ã¿ã‚’å¯¾è±¡ï¼‰
            const numericScores = Object.entries(scores).filter(([key, value]) => 
                typeof value === 'number' && key !== 'total'
            ).map(([key, value]) => value);
            
            const totalScore = numericScores.reduce((sum, score) => sum + score, 0) / numericScores.length;
            scores.total = Math.round(totalScore);

            return scores;
        }

        // æ–°ã—ã„è©•ä¾¡é–¢æ•°ï¼ˆå¾Œæ–¹è¦–ç‚¹ç”¨ï¼‰
        
        // ä½“ã®å‘ãè©•ä¾¡ï¼ˆè‚©ã€è…°ã€ã‹ã‹ã¨ã®ãƒ©ã‚¤ãƒ³ï¼‰
        function evaluateBodyAlignment(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftHeel = landmarks[29];
            const rightHeel = landmarks[30];
            
            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip || !leftHeel || !rightHeel) {
                return { score: 0, currentValue: 0, idealValue: 0, unit: 'cm', status: 'unknown' };
            }
            
            // è‚©ã€è…°ã€ã‹ã‹ã¨ã®ãƒ©ã‚¤ãƒ³ãŒå¹³è¡Œã‹ã©ã†ã‹ã‚’è©•ä¾¡
            const shoulderLine = Math.abs(leftShoulder.x - rightShoulder.x);
            const hipLine = Math.abs(leftHip.x - rightHip.x);
            const heelLine = Math.abs(leftHeel.x - rightHeel.x);
            
            const alignmentDeviation = Math.abs(shoulderLine - hipLine) + Math.abs(hipLine - heelLine);
            const deviationInCm = alignmentDeviation * 50; // cmå˜ä½ã«å¤‰æ›
            
            let score;
            if (alignmentDeviation < 0.02) score = 95;
            else if (alignmentDeviation < 0.04) score = 85;
            else if (alignmentDeviation < 0.06) score = 75;
            else if (alignmentDeviation < 0.08) score = 65;
            else score = 50;
            
            return {
                score: score,
                currentValue: Math.round(deviationInCm * 10) / 10,
                idealValue: 0,
                unit: 'cmã®ã‚ºãƒ¬',
                status: score >= 80 ? 'good' : 'needs_improvement'
            };
        }
        
        // å‰å‚¾è§’åº¦è©•ä¾¡
        function evaluateForwardTilt(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!nose || !leftShoulder || !rightShoulder || !leftHip || !rightHip) {
                return { score: 0, currentValue: 0, idealValue: 0, unit: 'åº¦', status: 'unknown' };
            }
            
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            
            // å‰å‚¾è§’åº¦ã‚’è¨ˆç®—
            const tiltAngle = Math.atan2(shoulderCenter.y - hipCenter.y, shoulderCenter.x - hipCenter.x) * 180 / Math.PI;
            const currentTilt = Math.abs(tiltAngle);
            
            // ã‚¯ãƒ©ãƒ–åˆ¥ã®ç†æƒ³çš„ãªå‰å‚¾è§’åº¦
            const idealTilts = {
                'Driver': 30,
                'FairwayWood': 32,
                'Utility': 34,
                '3Iron': 36,
                '4Iron': 37,
                '5Iron': 38,
                '6Iron': 39,
                '7Iron': 40,
                '8Iron': 42,
                '9Iron': 44,
                'Wedge': 45
            };
            
            const clubType = document.getElementById('clubSelect').value;
            const idealTilt = idealTilts[clubType] || 35;
            const deviation = Math.abs(currentTilt - idealTilt);
            
            // åˆ¤å®šã‚’ç”˜ãã™ã‚‹
            let score;
            if (deviation < 8) score = 95;
            else if (deviation < 15) score = 90;
            else if (deviation < 22) score = 85;
            else if (deviation < 30) score = 75;
            else score = 65;
            
            return {
                score: score,
                currentValue: Math.round(currentTilt * 10) / 10,
                idealValue: idealTilt,
                unit: 'åº¦',
                status: score >= 80 ? 'good' : 'needs_improvement'
            };
        }
        
        // æ‰‹ã®ä½ç½®è©•ä¾¡
        function evaluateHandPosition(landmarks, clubType) {
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!leftWrist || !rightWrist || !leftShoulder || !rightShoulder) {
                return { score: 0, currentValue: 0, idealValue: 0, unit: 'cm', status: 'unknown' };
            }
            
            const handCenter = {
                x: (leftWrist.x + rightWrist.x) / 2,
                y: (leftWrist.y + rightWrist.y) / 2
            };
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            
            // æ‰‹ã¨è‚©ã®ä½ç½®é–¢ä¿‚ã‚’è©•ä¾¡
            const handDistance = Math.abs(handCenter.x - shoulderCenter.x);
            const handDistanceInCm = handDistance * 100; // cmå˜ä½ã«å¤‰æ›
            
            let idealDistance, idealDescription;
            if (clubType === 'Driver') {
                idealDistance = 0.03; // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯å°‘ã—å‰
                idealDescription = 'è‚©ã®çœŸä¸‹ã‚ˆã‚Šå°‘ã—å‰';
            } else {
                idealDistance = 0.01; // ä»–ã®ã‚¯ãƒ©ãƒ–ã¯è‚©ã®çœŸä¸‹
                idealDescription = 'è‚©ã®çœŸä¸‹';
            }
            
            const idealDistanceInCm = idealDistance * 100;
            const deviation = Math.abs(handDistance - idealDistance);
            
            let score;
            if (deviation < 0.01) score = 95;
            else if (deviation < 0.02) score = 85;
            else if (deviation < 0.03) score = 75;
            else if (deviation < 0.04) score = 65;
            else score = 50;
            
            return {
                score: score,
                currentValue: Math.round(handDistanceInCm * 10) / 10,
                idealValue: Math.round(idealDistanceInCm * 10) / 10,
                unit: 'cm',
                status: score >= 80 ? 'good' : 'needs_improvement',
                description: idealDescription
            };
        }
        
        // å‰å¾Œã®é‡å¿ƒè©•ä¾¡
        function evaluateFrontBackWeight(landmarks) {
            const nose = landmarks[0];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            
            if (!nose || !leftHip || !rightHip || !leftAnkle || !rightAnkle) return 0;
            
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            const ankleCenter = {
                x: (leftAnkle.x + rightAnkle.x) / 2,
                y: (leftAnkle.y + rightAnkle.y) / 2
            };
            
            // å‰å¾Œã®é‡å¿ƒãƒãƒ©ãƒ³ã‚¹ã‚’è©•ä¾¡
            const weightBalance = Math.abs(hipCenter.x - ankleCenter.x);
            
            if (weightBalance < 0.02) return 95;
            if (weightBalance < 0.04) return 85;
            if (weightBalance < 0.06) return 75;
            if (weightBalance < 0.08) return 65;
            return 50;
        }
        
        // èƒŒç­‹ã®æ›²ãŒã‚Šå…·åˆè©•ä¾¡
        function evaluateSpinalCurve(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!nose || !leftShoulder || !rightShoulder || !leftHip || !rightHip) {
                return { score: 0, status: 'unknown', description: '' };
            }
            
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            
            // èƒŒç­‹ã®è‡ªç„¶ãªã‚«ãƒ¼ãƒ–ã‚’è©•ä¾¡ï¼ˆç°¡ç•¥åŒ–ï¼‰
            const headToShoulder = nose.x - shoulderCenter.x;
            const shoulderToHip = shoulderCenter.x - hipCenter.x;
            const spineDeviation = Math.abs(headToShoulder) + Math.abs(shoulderToHip);
            
            let score;
            let status;
            let description;
            
            // åˆ¤å®šã‚’ã•ã‚‰ã«ç”˜ãã™ã‚‹
            if (spineDeviation < 0.08) {
                score = 95;
                status = 'good';
                description = 'è‡ªç„¶ãªSå­—ã‚«ãƒ¼ãƒ–';
            } else if (spineDeviation < 0.15) {
                score = 90;
                status = 'good';
                description = 'è‰¯å¥½ãªã‚«ãƒ¼ãƒ–';
            } else if (spineDeviation < 0.22) {
                score = 85;
                status = 'good';
                // é ­ãŒå‰ã«å‡ºã™ãã¦ã„ã‚‹å ´åˆã¯çŒ«èƒŒå‚¾å‘
                if (headToShoulder > 0.12) {
                    description = 'çŒ«èƒŒæ°—å‘³';
                } else if (headToShoulder < -0.12) {
                    description = 'åã‚Šæ°—å‘³';
                } else {
                    description = 'è‰¯å¥½ãªã‚«ãƒ¼ãƒ–';
                }
            } else if (spineDeviation < 0.30) {
                score = 80;
                status = 'needs_improvement';
                if (headToShoulder > 0.12) {
                    description = 'çŒ«èƒŒæ°—å‘³';
                } else if (headToShoulder < -0.12) {
                    description = 'åã‚Šéã';
                } else {
                    description = 'è»½å¾®ãªæ­ªã¿';
                }
            } else if (spineDeviation < 0.40) {
                score = 75;
                status = 'needs_improvement';
                if (headToShoulder > 0.15) {
                    description = 'çŒ«èƒŒ';
                } else if (headToShoulder < -0.15) {
                    description = 'åã‚Šéã';
                } else {
                    description = 'å§¿å‹¢ã®æ­ªã¿';
                }
            } else {
                score = 70;
                status = 'needs_improvement';
                if (headToShoulder > 0.15) {
                    description = 'å¼·ã„çŒ«èƒŒ';
                } else if (headToShoulder < -0.15) {
                    description = 'å¼·ã„åã‚Šéã';
                } else {
                    description = 'å¤§ããªå§¿å‹¢ã®æ­ªã¿';
                }
            }
            
            return { score: score, status: status, description: description };
        }
        
        // æ—§è©•ä¾¡é–¢æ•°ï¼ˆæ­£é¢è¦–ç‚¹ç”¨ã«ä¿æŒï¼‰
        
        // è„Šæ¤è§’åº¦è©•ä¾¡ï¼ˆæ­£é¢ãƒ»å¾Œé¢è¦–ç‚¹å¯¾å¿œï¼‰
        function evaluateSpineAngle(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip) return 0;
            
            // æ­£é¢è¦–ç‚¹ã§ã®è„Šæ¤ã®ç›´ç·šæ€§ã‚’è©•ä¾¡
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            
            // æ°´å¹³ã‹ã‚‰ã®å‚¾ãã‚’è¨ˆç®—
            const spineDeviation = Math.abs(shoulderCenter.x - hipCenter.x);
            
            if (spineDeviation < 0.02) return 95;
            if (spineDeviation < 0.04) return 85;
            if (spineDeviation < 0.06) return 75;
            if (spineDeviation < 0.08) return 65;
            return 50;
        }

        // è‚©ã®ä½ç½®è©•ä¾¡ï¼ˆæ­£é¢è¦–ç‚¹æœ€é©åŒ–ï¼‰
        function evaluateShoulderAlignment(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!leftShoulder || !rightShoulder) return 0;
            
            // æ­£é¢è¦–ç‚¹ã§ã®è‚©ã®æ°´å¹³åº¦ã‚’è©•ä¾¡
            const heightDiff = Math.abs(leftShoulder.y - rightShoulder.y);
            
            // æ­£é¢ã‹ã‚‰ã¯è‚©ã®é«˜ã•ã®é•ã„ãŒã‚ˆã‚Šæ˜ç¢ºã«è¦‹ãˆã‚‹
            if (heightDiff < 0.015) return 95;
            if (heightDiff < 0.03) return 85;
            if (heightDiff < 0.045) return 75;
            if (heightDiff < 0.06) return 65;
            return 50;
        }

        // è†ã®ä½ç½®è©•ä¾¡ï¼ˆæ­£é¢è¦–ç‚¹æœ€é©åŒ–ï¼‰
        function evaluateKneeAlignment(landmarks) {
            const leftKnee = landmarks[25];
            const rightKnee = landmarks[26];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftKnee || !rightKnee || !leftHip || !rightHip) return 0;
            
            // æ­£é¢è¦–ç‚¹ã§ã®è†ã®ä½ç½®ã‚’è‚¡é–¢ç¯€ã¨ã®é–¢ä¿‚ã§è©•ä¾¡
            const leftKneeAlignment = Math.abs(leftKnee.x - leftHip.x);
            const rightKneeAlignment = Math.abs(rightKnee.x - rightHip.x);
            
            // è†ã®é«˜ã•ã®æƒã„å…·åˆã‚‚è©•ä¾¡
            const kneeHeightDiff = Math.abs(leftKnee.y - rightKnee.y);
            
            const avgAlignment = (leftKneeAlignment + rightKneeAlignment) / 2;
            const totalDeviation = avgAlignment + kneeHeightDiff;
            
            if (totalDeviation < 0.03) return 95;
            if (totalDeviation < 0.06) return 85;
            if (totalDeviation < 0.09) return 75;
            if (totalDeviation < 0.12) return 65;
            return 50;
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®è©•ä¾¡ï¼ˆæ”¹è‰¯ç‰ˆãƒ»ã‚¯ãƒªãƒƒã‚¯å¯¾å¿œï¼‰
        function evaluateBallPosition(landmarks, clubType) {
            const leftAnkle = landmarks[27]; // å·¦è¶³é¦–
            const rightAnkle = landmarks[28]; // å³è¶³é¦–
            const leftHeel = landmarks[29]; // å·¦ã‹ã‹ã¨
            const rightHeel = landmarks[30]; // å³ã‹ã‹ã¨
            const leftToe = landmarks[31]; // å·¦ã¤ã¾å…ˆ
            const rightToe = landmarks[32]; // å³ã¤ã¾å…ˆ
            
            if (!leftAnkle || !rightAnkle || !leftHeel || !rightHeel) return 0;
            
            // ã‚ˆã‚Šæ­£ç¢ºãªè¶³ã®ä½ç½®è¨ˆç®—
            const leftFootCenter = leftHeel ? leftHeel.x : leftAnkle.x;
            const rightFootCenter = rightHeel ? rightHeel.x : rightAnkle.x;
            const stanceCenter = (leftFootCenter + rightFootCenter) / 2;
            
            // ã‚¯ãƒ©ãƒ–åˆ¥ã®ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ï¼ˆå·¦è¶³ã‹ã‹ã¨å†…å´ã‚’åŸºæº–ï¼‰
            const idealPositions = {
                'Driver': leftFootCenter,                // å·¦è¶³ã‹ã‹ã¨ä½ç½®
                'FairwayWood': leftFootCenter + 0.02,   // å·¦è¶³ã‹ã‹ã¨å†…å´ã‚ˆã‚Šå°‘ã—å³
                'Utility': stanceCenter - 0.02,        // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '3Iron': stanceCenter - 0.015,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '4Iron': stanceCenter - 0.01,          // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '5Iron': stanceCenter - 0.005,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '6Iron': stanceCenter,                  // ä¸­å¤®
                '7Iron': stanceCenter,                  // ä¸­å¤®
                '8Iron': stanceCenter + 0.005,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³
                '9Iron': stanceCenter + 0.01,          // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³
                'Wedge': stanceCenter + 0.03           // ä¸­å¤®ã‚ˆã‚Šå³
            };
            
            // å®Ÿéš›ã®ãƒœãƒ¼ãƒ«ä½ç½®ã‚’æ±ºå®š
            let actualBallPosition;
            
            if (userClickedBallPosition && document.getElementById('viewSelect').value === 'front') {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã‚’ä½¿ç”¨
                actualBallPosition = userClickedBallPosition.x;
            } else {
                // æ‰‹é¦–ã®ä½ç½®ã‹ã‚‰æ¨å®š
                const leftWrist = landmarks[15];
                const rightWrist = landmarks[16];
                actualBallPosition = stanceCenter; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                
                if (leftWrist && rightWrist) {
                    // æ‰‹é¦–ã®ä¸­å¤®ã‹ã‚‰ãƒœãƒ¼ãƒ«ä½ç½®ã‚’æ¨å®š
                    const handCenter = (leftWrist.x + rightWrist.x) / 2;
                    actualBallPosition = handCenter;
                }
            }
            
            const idealPosition = idealPositions[clubType] || stanceCenter;
            const deviation = Math.abs(actualBallPosition - idealPosition);
            const isLeftOfIdeal = actualBallPosition > idealPosition; // ç†æƒ³ä½ç½®ã‚ˆã‚Šå·¦ã«ã‚ã‚‹ï¼ˆMediaPipeåº§æ¨™ç³»ã§ã¯é€†ï¼‰
            
            // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆå°‘ã—å³ã—ãèª¿æ•´ï¼‰
            let score;
            if (deviation < 0.020) score = 95; // 95ç‚¹ã®ç¯„å›²ã‚’ç‹­ã
            else if (deviation < 0.040) score = 90;
            else if (deviation < 0.060) score = 85;
            else if (deviation < 0.080) score = 75;
            else if (deviation < 0.105) score = 65;
            else score = 50;
            
            return {
                score: score,
                actualPosition: actualBallPosition,
                idealPosition: idealPosition,
                deviation: deviation,
                isLeftOfIdeal: isLeftOfIdeal,
                clubType: clubType
            };
        }

        // ã‚¹ã‚¿ãƒ³ã‚¹å¹…è©•ä¾¡
        function evaluateStanceWidth(landmarks, clubType) {
            const leftFoot = landmarks[27];
            const rightFoot = landmarks[28];
            
            if (!leftFoot || !rightFoot) return { score: 0, status: 'unknown' };
            
            const stanceWidth = Math.abs(leftFoot.x - rightFoot.x);
            
            const idealWidths = {
                'Driver': 0.28,        // è‚©å¹…ã‚ˆã‚Šã‚‚å°‘ã—åºƒã‚
                'FairwayWood': 0.22,   // è‚©å¹…ç¨‹åº¦
                'Utility': 0.22,      // è‚©å¹…ç¨‹åº¦
                '3Iron': 0.22,        // è‚©å¹…ç¨‹åº¦
                '4Iron': 0.22,        // è‚©å¹…ç¨‹åº¦
                '5Iron': 0.22,        // è‚©å¹…ç¨‹åº¦
                '6Iron': 0.22,        // è‚©å¹…ç¨‹åº¦
                '7Iron': 0.22,        // è‚©å¹…ç¨‹åº¦
                '8Iron': 0.22,        // è‚©å¹…ç¨‹åº¦
                '9Iron': 0.22,        // è‚©å¹…ç¨‹åº¦
                'Wedge': 0.22         // è‚©å¹…ç¨‹åº¦ï¼ˆè‚©å¹…+10cm = 0.22ç›¸å½“ï¼‰
            };
            
            const idealWidth = idealWidths[clubType] || 0.20;
            const deviation = stanceWidth - idealWidth;
            
            let score, status;
            
            // åˆ¤å®šã‚’ç”˜ãã™ã‚‹
            if (Math.abs(deviation) < 0.04) {
                score = 95;
                status = 'ideal';
            } else if (Math.abs(deviation) < 0.07) {
                score = 90;
                status = deviation > 0 ? 'slightly_wide' : 'slightly_narrow';
            } else if (Math.abs(deviation) < 0.10) {
                score = 85;
                status = deviation > 0 ? 'wide' : 'narrow';
            } else if (Math.abs(deviation) < 0.13) {
                score = 75;
                status = deviation > 0 ? 'too_wide' : 'too_narrow';
            } else {
                score = 65;
                status = deviation > 0 ? 'much_too_wide' : 'much_too_narrow';
            }
            
            return { 
                score: score, 
                status: status
            };
        }

        // é‡å¿ƒé…åˆ†è©•ä¾¡ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
        function evaluateWeightDistribution(landmarks, clubType) {
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftFoot = landmarks[27];
            const rightFoot = landmarks[28];
            
            if (!leftHip || !rightHip || !leftFoot || !rightFoot) {
                return { score: 0, status: 'unknown', currentBalance: '', idealBalance: '' };
            }
            
            // é‡å¿ƒä½ç½®ã‚’æ¨å®šï¼ˆè…°ã®ä½ç½®ã¨è¶³ã®ä½ç½®ã‹ã‚‰ï¼‰
            const hipCenter = (leftHip.x + rightHip.x) / 2;
            const footCenter = (leftFoot.x + rightFoot.x) / 2;
            
            // å·¦å³ã®é‡å¿ƒé…åˆ†ã‚’è¨ˆç®—
            const weightDistribution = (hipCenter - footCenter) / Math.abs(leftFoot.x - rightFoot.x);
            
            let score;
            let status;
            let currentBalance;
            let idealBalance;
            
            if (clubType === 'Driver') {
                // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼š6:4ã§å³é‡å¿ƒãŒç†æƒ³
                idealBalance = 'å³è¶³6ï¼šå·¦è¶³4';
                const idealRightWeight = 0.1; // å³ã«10%åã£ãŸçŠ¶æ…‹
                const deviation = Math.abs(weightDistribution - idealRightWeight);
                
                if (weightDistribution > idealRightWeight + 0.15) {
                    currentBalance = 'å³è¶³ã«é‡å¿ƒãŒã‹ã‹ã‚Šã™ã';
                    status = 'too_right';
                } else if (weightDistribution < idealRightWeight - 0.15) {
                    currentBalance = 'å·¦è¶³ã«é‡å¿ƒãŒã‹ã‹ã‚Šã™ã';
                    status = 'too_left';
                } else if (weightDistribution > idealRightWeight + 0.08) {
                    currentBalance = 'å³è¶³é‡å¿ƒãŒå¼·ã‚';
                    status = 'slightly_right';
                } else if (weightDistribution < idealRightWeight - 0.08) {
                    currentBalance = 'å·¦è¶³é‡å¿ƒãŒå¼·ã‚';
                    status = 'slightly_left';
                } else {
                    currentBalance = 'é©åˆ‡ãªå³é‡å¿ƒ';
                    status = 'good';
                }
                
                if (deviation < 0.05) score = 95;
                else if (deviation < 0.10) score = 85;
                else if (deviation < 0.15) score = 75;
                else if (deviation < 0.20) score = 65;
                else score = 50;
            } else {
                // ãã®ä»–ã®ã‚¯ãƒ©ãƒ–ï¼š5:5ã§å‡ç­‰ãŒç†æƒ³
                idealBalance = 'å·¦å³å‡ç­‰ï¼ˆ5ï¼š5ï¼‰';
                const deviation = Math.abs(weightDistribution);
                
                if (weightDistribution > 0.12) {
                    currentBalance = 'å³è¶³ã«é‡å¿ƒãŒã‹ã‹ã‚Šã™ã';
                    status = 'too_right';
                } else if (weightDistribution < -0.12) {
                    currentBalance = 'å·¦è¶³ã«é‡å¿ƒãŒã‹ã‹ã‚Šã™ã';
                    status = 'too_left';
                } else if (weightDistribution > 0.06) {
                    currentBalance = 'å³è¶³é‡å¿ƒãŒå¼·ã‚';
                    status = 'slightly_right';
                } else if (weightDistribution < -0.06) {
                    currentBalance = 'å·¦è¶³é‡å¿ƒãŒå¼·ã‚';
                    status = 'slightly_left';
                } else {
                    currentBalance = 'é©åˆ‡ãªå‡ç­‰é…åˆ†';
                    status = 'good';
                }
                
                if (deviation < 0.03) score = 95;
                else if (deviation < 0.06) score = 85;
                else if (deviation < 0.09) score = 75;
                else if (deviation < 0.12) score = 65;
                else score = 50;
            }
            
            return { 
                score: score, 
                status: status, 
                currentBalance: currentBalance, 
                idealBalance: idealBalance 
            };
        }

        // ãƒãƒ©ãƒ³ã‚¹è©•ä¾¡
        function evaluateBalance(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip) return { score: 0, currentValue: 0, idealValue: 0, unit: 'cm' };
            
            const shoulderCenter = (leftShoulder.x + rightShoulder.x) / 2;
            const hipCenter = (leftHip.x + rightHip.x) / 2;
            const balance = Math.abs(shoulderCenter - hipCenter);
            
            // ãƒãƒ©ãƒ³ã‚¹ã®ã‚ºãƒ¬ã‚’cmå˜ä½ã«å¤‰æ›ï¼ˆä»®æƒ³çš„ãªå¤‰æ›ï¼‰
            const balanceInCm = balance * 100; // 0.01 = 1cmç›¸å½“ã¨ä»®å®š
            
            let score;
            if (balance < 0.02) score = 95;
            else if (balance < 0.04) score = 85;
            else if (balance < 0.06) score = 75;
            else if (balance < 0.08) score = 65;
            else score = 50;
            
            return {
                score: score,
                currentValue: Math.round(balanceInCm * 10) / 10,
                idealValue: 0,
                unit: 'cmã®ã‚ºãƒ¬'
            };
        }

        // é ­ã®ä½ç½®è©•ä¾¡
        function evaluateHeadPosition(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!nose || !leftShoulder || !rightShoulder) return { score: 0, currentValue: 0, idealValue: 0, unit: 'cm' };
            
            const shoulderCenter = (leftShoulder.x + rightShoulder.x) / 2;
            const headPosition = Math.abs(nose.x - shoulderCenter);
            
            // é ­ã®ã‚ºãƒ¬ã‚’cmå˜ä½ã«å¤‰æ›
            const headOffsetInCm = headPosition * 100;
            
            let score;
            if (headPosition < 0.03) score = 95;
            else if (headPosition < 0.06) score = 85;
            else if (headPosition < 0.09) score = 75;
            else if (headPosition < 0.12) score = 65;
            else score = 50;
            
            return {
                score: score,
                currentValue: Math.round(headOffsetInCm * 10) / 10,
                idealValue: 0,
                unit: 'cmã®ã‚ºãƒ¬'
            };
        }

        // è©³ç´°æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateDetailedComparison(key, scores, clubType) {
            const viewType = document.getElementById('viewSelect').value;
            
            switch(key) {
                case 'ballPosition':
                    if (scores.ballPositionData) {
                        const data = scores.ballPositionData;
                        const positionNames = {
                            'Driver': 'å·¦è¶³ã‹ã‹ã¨ä½ç½®',
                            'FairwayWood': 'å·¦è¶³ã‹ã‹ã¨å†…å´ã‚ˆã‚Šå°‘ã—å³',
                            'Utility': 'ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦',
                            '3Iron': 'ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦',
                            '4Iron': 'ä¸­å¤®',
                            '5Iron': 'ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³',
                            '6Iron': 'ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³',
                            '7Iron': 'ä¸­å¤®ã‚ˆã‚Šå³',
                            '8Iron': 'ä¸­å¤®ã‚ˆã‚Šå³',
                            '9Iron': 'å³è¶³ã‚ˆã‚Š',
                            'PW': 'å³è¶³ã‚ˆã‚Š',
                            'SW': 'å³è¶³å¯„ã‚Š'
                        };
                        
                        const currentPos = data.isLeftOfIdeal ? 'ç†æƒ³ä½ç½®ã‚ˆã‚Šå·¦' : 'ç†æƒ³ä½ç½®ã‚ˆã‚Šå³';
                        const idealPos = positionNames[clubType] || 'é©åˆ‡ãªä½ç½®';
                        const deviation = Math.round(data.deviation * 100 * 10) / 10;
                        
                        return {
                            current: currentPos,
                            ideal: idealPos,
                            gap: `${deviation}cm`,
                            steps: [
                                'è¶³ã®ä½ç½®ã‚’ç¢ºèªã—ã€ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èª¿æ•´ã—ã¾ã™',
                                `ãƒœãƒ¼ãƒ«ä½ç½®ã‚’${data.isLeftOfIdeal ? 'å³ã«' : 'å·¦ã«'}ç´„${deviation}cmç§»å‹•ã•ã›ã¾ã™`,
                                'æ•°å›ç´ æŒ¯ã‚Šã‚’ã—ã¦ä½ç½®ã‚’ä½“ã«è¦šãˆã•ã›ã¾ã™'
                            ]
                        };
                    }
                    return null;
                    
                case 'stance':
                    if (scores.stanceStatus) {
                        const status = scores.stanceStatus;
                        const idealDesc = clubType === 'Driver' ? 'è‚©å¹…ã‚ˆã‚Šã‚‚å°‘ã—åºƒã‚ï¼ˆç´„60cmï¼‰' : 'è‚©å¹…ç¨‹åº¦ï¼ˆç´„50cmï¼‰';
                        
                        let currentDesc = '';
                        let adjustmentDesc = '';
                        
                        switch(status) {
                            case 'slightly_narrow':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šã‚‚å°‘ã—ç‹­ã„';
                                adjustmentDesc = '5-10cmåºƒã’ã‚‹';
                                break;
                            case 'narrow':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šã‚‚ç‹­ã„';
                                adjustmentDesc = '10-15cmåºƒã’ã‚‹';
                                break;
                            case 'too_narrow':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šã‚‚ã‹ãªã‚Šç‹­ã„';
                                adjustmentDesc = '15-20cmåºƒã’ã‚‹';
                                break;
                            case 'much_too_narrow':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šã‚‚éå¸¸ã«ç‹­ã„';
                                adjustmentDesc = '20cmä»¥ä¸Šåºƒã’ã‚‹';
                                break;
                            case 'slightly_wide':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šã‚‚å°‘ã—åºƒã„';
                                adjustmentDesc = '5-10cmç‹­ã‚ã‚‹';
                                break;
                            case 'wide':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šã‚‚åºƒã„';
                                adjustmentDesc = '10-15cmç‹­ã‚ã‚‹';
                                break;
                            case 'too_wide':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šã‚‚ã‹ãªã‚Šåºƒã„';
                                adjustmentDesc = '15-20cmç‹­ã‚ã‚‹';
                                break;
                            case 'much_too_wide':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šã‚‚éå¸¸ã«åºƒã„';
                                adjustmentDesc = '20cmä»¥ä¸Šç‹­ã‚ã‚‹';
                                break;
                            default:
                                return null;
                        }
                        
                        return {
                            current: currentDesc,
                            ideal: idealDesc,
                            gap: adjustmentDesc,
                            steps: [
                                'ä¸¡è¶³ã®ä½ç½®ã‚’ç¢ºèªã—ã¾ã™',
                                `è¶³å¹…ã‚’${adjustmentDesc}èª¿æ•´ã—ã¾ã™`,
                                'èª¿æ•´å¾Œã€æ•°å›ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–ã‚Šç›´ã—ã¦æ„Ÿè¦šã‚’ç¢ºèªã—ã¾ã™'
                            ]
                        };
                    }
                    return null;
                    
                case 'balance':
                    if (scores.balanceData) {
                        const data = scores.balanceData;
                        return {
                            current: `${data.currentValue}${data.unit}`,
                            ideal: `${data.idealValue}${data.unit}`,
                            gap: `${Math.abs(data.currentValue - data.idealValue)}${data.unit}`,
                            steps: [
                                'ä¸ŠåŠèº«ã¨ä¸‹åŠèº«ã®é‡å¿ƒä½ç½®ã‚’æ„è­˜ã—ã¾ã™',
                                'è‚©ã¨è…°ã®ãƒ©ã‚¤ãƒ³ã‚’å¹³è¡Œã«ä¿ã¡ã¾ã™',
                                'é‡å¿ƒã‚’è¶³è£ã®ä¸­å¤®ã«ç½®ãã‚ˆã†èª¿æ•´ã—ã¾ã™'
                            ]
                        };
                    }
                    return null;
                    
                case 'headPosition':
                    if (scores.headData) {
                        const data = scores.headData;
                        return {
                            current: `${data.currentValue}${data.unit}`,
                            ideal: `ä¸¡è‚©ã®ä¸­å¤®`,
                            gap: `${data.currentValue}${data.unit}`,
                            steps: [
                                'ä¸¡è‚©ã®ãƒ©ã‚¤ãƒ³ã‚’ç¢ºèªã—ã¾ã™',
                                'é ­ã‚’å·¦å³ã®è‚©ã®ä¸­å¤®ã«ä½ç½®ã•ã›ã¾ã™',
                                'é¡ã‚’è»½ãå¼•ã„ã¦è‡ªç„¶ãªé ­ã®ä½ç½®ã‚’ä¿ã¡ã¾ã™'
                            ]
                        };
                    }
                    return null;
                    
                case 'forwardTilt':
                    if (viewType === 'back' && scores.forwardTiltData) {
                        const data = scores.forwardTiltData;
                        const currentStatus = data.currentValue < data.idealValue ? 'æµ…ã™ãã‚‹' : 'æ·±ã™ãã‚‹';
                        const adjustment = data.currentValue < data.idealValue ? 'æ·±ã' : 'æµ…ã';
                        return {
                            current: currentStatus,
                            ideal: 'é©åˆ‡ãªè§’åº¦',
                            gap: 'è¦èª¿æ•´',
                            steps: [
                                'è‚¡é–¢ç¯€ã‹ã‚‰å‰å‚¾ã™ã‚‹æ„è­˜ã‚’æŒã¡ã¾ã™',
                                `å‰å‚¾è§’åº¦ã‚’${adjustment}èª¿æ•´ã—ã¾ã™`,
                                'èƒŒç­‹ã‚’çœŸã£ç›´ãã«ä¿ã¡ãªãŒã‚‰èª¿æ•´ã—ã¾ã™'
                            ]
                        };
                    }
                    return null;
                    
                case 'handPosition':
                    if (viewType === 'back' && scores.handPositionData) {
                        const data = scores.handPositionData;
                        return {
                            current: `ä½“ã‹ã‚‰${data.currentValue}${data.unit}`,
                            ideal: `ä½“ã‹ã‚‰${data.idealValue}${data.unit}`,
                            gap: `${Math.abs(data.currentValue - data.idealValue)}${data.unit}`,
                            steps: [
                                'è…•ã‚’è‡ªç„¶ã«å‚ã‚‰ã—ãŸä½ç½®ã‚’ç¢ºèªã—ã¾ã™',
                                `æ‰‹ã®ä½ç½®ã‚’ä½“ã«${data.currentValue > data.idealValue ? 'ã‚ˆã‚Šè¿‘ã' : 'ã‚ˆã‚Šé ã'}èª¿æ•´ã—ã¾ã™`,
                                'è‚©ã®åŠ›ã‚’æŠœã„ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸæ‰‹ã®ä½ç½®ã‚’ä¿ã¡ã¾ã™'
                            ]
                        };
                    }
                    return null;
                    
                default:
                    return null;
            }
        }

        // è¦–è¦šçš„æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateVisualComparison(key, scores, clubType) {
            const viewType = document.getElementById('viewSelect').value;
            
            switch(key) {
                case 'bodyAlignment':
                    if (viewType === 'back' && scores.bodyAlignmentData) {
                        const data = scores.bodyAlignmentData;
                        return {
                            title: 'ä½“ã®å‘ãã®æ¯”è¼ƒ',
                            beforeValue: `${data.currentValue}${data.unit}`,
                            afterValue: 'å¹³è¡Œã«æ•´åˆ—',
                            beforeDescription: 'è‚©ãƒ»è…°ãƒ»ã‹ã‹ã¨ã®ã‚ºãƒ¬',
                            afterDescription: 'ç†æƒ³ã®ä½“ã®å‘ã',
                            improvement: 'ä½“ã®ãƒ©ã‚¤ãƒ³ã‚’æƒãˆã‚‹ã“ã¨ã§æ–¹å‘æ€§ãŒå‘ä¸Š'
                        };
                    }
                    return null;
                    
                case 'forwardTilt':
                    if (viewType === 'back' && scores.forwardTiltData) {
                        const data = scores.forwardTiltData;
                        const currentStatus = data.currentValue < data.idealValue ? 'æµ…ã™ãã‚‹å‰å‚¾' : 'æ·±ã™ãã‚‹å‰å‚¾';
                        const adjustment = data.currentValue < data.idealValue ? 'ã‚ˆã‚Šæ·±ãå‰å‚¾' : 'ã‚ˆã‚Šæµ…ãå‰å‚¾';
                        return {
                            title: 'å‰å‚¾è§’åº¦ã®æ¯”è¼ƒ',
                            beforeValue: currentStatus,
                            afterValue: 'é©åˆ‡ãªå‰å‚¾è§’åº¦',
                            beforeDescription: 'ç¾åœ¨ã®å‰å‚¾çŠ¶æ…‹',
                            afterDescription: 'ç†æƒ³ã®å‰å‚¾è§’åº¦',
                            improvement: `${adjustment}ã™ã‚‹ã“ã¨ã§å®‰å®šæ€§ãŒå‘ä¸Š`
                        };
                    }
                    return null;
                    
                case 'ballPosition':
                    if (scores.ballPositionData) {
                        const data = scores.ballPositionData;
                        const positionNames = {
                            'Driver': 'å·¦è¶³ã‹ã‹ã¨ä½ç½®',
                            'FairwayWood': 'å·¦è¶³ã‹ã‹ã¨å†…å´ã‚ˆã‚Šå°‘ã—å³',
                            'Utility': 'ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦',
                            '3Iron': 'ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦',
                            '4Iron': 'ä¸­å¤®',
                            '5Iron': 'ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³',
                            '6Iron': 'ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³',
                            '7Iron': 'ä¸­å¤®ã‚ˆã‚Šå³',
                            '8Iron': 'ä¸­å¤®ã‚ˆã‚Šå³',
                            '9Iron': 'å³è¶³ã‚ˆã‚Š',
                            'PW': 'å³è¶³ã‚ˆã‚Š',
                            'SW': 'å³è¶³å¯„ã‚Š'
                        };
                        
                        const idealPos = positionNames[clubType] || 'é©åˆ‡ãªä½ç½®';
                        const currentPos = data.isLeftOfIdeal ? 'ç†æƒ³ä½ç½®ã‚ˆã‚Šå·¦' : 'ç†æƒ³ä½ç½®ã‚ˆã‚Šå³';
                        const deviation = Math.round(data.deviation * 100 * 10) / 10;
                        
                        return {
                            title: 'ãƒœãƒ¼ãƒ«ä½ç½®ã®æ¯”è¼ƒ',
                            beforeValue: currentPos,
                            afterValue: idealPos,
                            beforeDescription: 'ç¾åœ¨ã®ãƒœãƒ¼ãƒ«ä½ç½®',
                            afterDescription: 'ç†æƒ³ã®ãƒœãƒ¼ãƒ«ä½ç½®',
                            improvement: `ç´„${deviation}cmã®èª¿æ•´ã§å¤§å¹…æ”¹å–„`
                        };
                    }
                    return null;
                    
                case 'stance':
                    if (scores.stanceStatus) {
                        const status = scores.stanceStatus;
                        const idealDesc = clubType === 'Driver' ? 'è‚©å¹…ã‚ˆã‚Šå°‘ã—åºƒã‚' : 'è‚©å¹…ç¨‹åº¦';
                        
                        let currentDesc = '';
                        let improvement = '';
                        
                        switch(status) {
                            case 'slightly_narrow':
                            case 'narrow':
                            case 'too_narrow':
                            case 'much_too_narrow':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šç‹­ã„ã‚¹ã‚¿ãƒ³ã‚¹';
                                improvement = 'ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åºƒã’ã‚‹ã“ã¨ã§å®‰å®šæ€§å‘ä¸Š';
                                break;
                            case 'slightly_wide':
                            case 'wide':
                            case 'too_wide':
                            case 'much_too_wide':
                                currentDesc = 'ç†æƒ³ã‚ˆã‚Šåºƒã„ã‚¹ã‚¿ãƒ³ã‚¹';
                                improvement = 'ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç‹­ã‚ã‚‹ã“ã¨ã§ãƒãƒ©ãƒ³ã‚¹æ”¹å–„';
                                break;
                            default:
                                return null;
                        }
                        
                        return {
                            title: 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã®æ¯”è¼ƒ',
                            beforeValue: currentDesc,
                            afterValue: idealDesc,
                            beforeDescription: 'ç¾åœ¨ã®ã‚¹ã‚¿ãƒ³ã‚¹',
                            afterDescription: 'ç†æƒ³ã®ã‚¹ã‚¿ãƒ³ã‚¹',
                            improvement: improvement
                        };
                    }
                    return null;
                    
                case 'handPosition':
                    if (viewType === 'back' && scores.handPositionData) {
                        const data = scores.handPositionData;
                        const adjustment = data.currentValue > data.idealValue ? 'ä½“ã«è¿‘ã¥ã‘ã‚‹' : 'ä½“ã‹ã‚‰é›¢ã™';
                        
                        return {
                            title: 'æ‰‹ã®ä½ç½®ã®æ¯”è¼ƒ',
                            beforeValue: `ä½“ã‹ã‚‰${data.currentValue}cm`,
                            afterValue: `ä½“ã‹ã‚‰${data.idealValue}cm`,
                            beforeDescription: 'ç¾åœ¨ã®æ‰‹ã®ä½ç½®',
                            afterDescription: 'ç†æƒ³ã®æ‰‹ã®ä½ç½®',
                            improvement: `æ‰‹ã‚’${adjustment}ã“ã¨ã§ã‚¹ã‚¤ãƒ³ã‚°ãƒ—ãƒ¬ãƒ¼ãƒ³ãŒæ”¹å–„`
                        };
                    }
                    return null;
                    
                default:
                    return null;
            }
        }

        // è¦–è¦šçš„æ¯”è¼ƒHTMLç”Ÿæˆ
        function generateVisualComparisonHTML(visualData) {
            if (!visualData) return '';
            
            return `
                <div class="visual-comparison">
                    <div style="font-weight: bold; color: #495057; margin-bottom: 10px; display: flex; align-items: center;">
                        <span style="margin-right: 8px;">ğŸ‘€</span>
                        ${visualData.title}
                    </div>
                    <div class="before-after-container">
                        <div class="comparison-side comparison-before">
                            <div class="comparison-label-visual label-before">æ”¹å–„å‰</div>
                            <div class="angle-display angle-before">${visualData.beforeValue}</div>
                            <div style="font-size: 0.9em; color: #666;">${visualData.beforeDescription}</div>
                            <div class="visual-indicator">
                                <span style="color: #dc3545; font-size: 1.5em;">âš ï¸</span>
                            </div>
                        </div>
                        <div class="comparison-side comparison-after">
                            <div class="comparison-label-visual label-after">æ”¹å–„å¾Œ</div>
                            <div class="angle-display angle-after">${visualData.afterValue}</div>
                            <div style="font-size: 0.9em; color: #666;">${visualData.afterDescription}</div>
                            <div class="visual-indicator">
                                <span style="color: #28a745; font-size: 1.5em;">âœ…</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px; padding: 10px; background: rgba(40, 167, 69, 0.1); border-radius: 5px; font-weight: bold; color: #28a745;">
                        ğŸ’¡ ${visualData.improvement}
                    </div>
                </div>
            `;
        }

        // è©³ç´°æ¯”è¼ƒHTMLç”Ÿæˆ
        function generateDetailedComparisonHTML(comparisonData) {
            if (!comparisonData) return '';
            
            return `
                <div class="detailed-comparison">
                    <div style="font-weight: bold; color: #495057; margin-bottom: 10px; display: flex; align-items: center;">
                        <span style="margin-right: 8px;">ğŸ“Š</span>
                        è©³ç´°åˆ†æ
                    </div>
                    <div class="comparison-row">
                        <div class="comparison-label">é …ç›®</div>
                        <div class="comparison-current">ç¾çŠ¶</div>
                        <div class="comparison-ideal">ç†æƒ³</div>
                        <div class="comparison-gap">å·®ç•°</div>
                    </div>
                    <div class="comparison-row">
                        <div class="comparison-label">ä½ç½®/è§’åº¦</div>
                        <div class="comparison-current">${comparisonData.current}</div>
                        <div class="comparison-ideal">${comparisonData.ideal}</div>
                        <div class="comparison-gap">${comparisonData.gap}</div>
                    </div>
                    <div class="improvement-steps">
                        <div style="font-weight: bold; color: #495057; margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="margin-right: 8px;">ğŸ¯</span>
                            æ”¹å–„ã‚¹ãƒ†ãƒƒãƒ—
                        </div>
                        ${comparisonData.steps.map((step, index) => `
                            <div class="improvement-step">
                                <div class="step-number">${index + 1}</div>
                                <div>${step}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // çµæœè¡¨ç¤ºï¼ˆã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’çµ±åˆï¼‰
        function displayResults(scores) {
            const scoreFeedbackGrid = document.getElementById('scoreFeedbackGrid');
            scoreFeedbackGrid.innerHTML = '';
            const viewType = document.getElementById('viewSelect').value;

            // è¦–ç‚¹åˆ¥ã«è¡¨ç¤ºé …ç›®ã‚’å¤‰æ›´
            let scoreItems;
            if (viewType === 'front') {
                scoreItems = [
                    { key: 'total', label: 'ç·åˆã‚¹ã‚³ã‚¢' },
                    { key: 'ballPosition', label: 'ãƒœãƒ¼ãƒ«ä½ç½®' },
                    { key: 'stance', label: 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…' },
                    { key: 'weight', label: 'é‡å¿ƒé…åˆ†' },
                    { key: 'balance', label: 'ãƒãƒ©ãƒ³ã‚¹' },
                    { key: 'headPosition', label: 'é ­ã®ä½ç½®' }
                ];
            } else {
                scoreItems = [
                    { key: 'total', label: 'ç·åˆã‚¹ã‚³ã‚¢' },
                    { key: 'bodyAlignment', label: 'ä½“ã®å‘ã' },
                    { key: 'forwardTilt', label: 'å‰å‚¾è§’åº¦' },
                    { key: 'handPosition', label: 'æ‰‹ã®ä½ç½®' },
                    { key: 'frontBackWeight', label: 'å‰å¾Œã®é‡å¿ƒ' },
                    { key: 'spinalCurve', label: 'èƒŒç­‹ã®æ›²ãŒã‚Š' }
                ];
            }

            const advice = generateAdvice(scores);
            const clubType = document.getElementById('clubSelect').value;

            scoreItems.forEach(item => {
                if (scores[item.key] !== undefined) {
                    const scoreValue = scores[item.key];
                    const scoreClass = getScoreClass(scoreValue);
                    
                    // ç‚¹æ•°ã«é–¢ã‚ã‚‰ãšã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã®ã¿è¡¨ç¤º
                    
                    const scoreElement = document.createElement('div');
                    scoreElement.className = `score-feedback-item ${scoreClass}`;
                    scoreElement.innerHTML = `
                        <div class="score-header">
                            <div class="score-title">${item.label}</div>
                            <div class="score-value">${scoreValue}ç‚¹</div>
                        </div>
                        <div class="advice-text">${advice[item.key]}</div>
                    `;
                    scoreFeedbackGrid.appendChild(scoreElement);
                }
            });
        }

        // ã‚¹ã‚³ã‚¢ã‚¯ãƒ©ã‚¹åˆ¤å®š
        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 80) return 'score-good';
            if (score >= 70) return 'score-average';
            return 'score-poor';
        }

        // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆä½œæˆï¼ˆè¦–ç‚¹åˆ¥ï¼‰
        function createRadarChart(scores) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const viewType = document.getElementById('viewSelect').value;
            
            if (radarChartInstance) {
                radarChartInstance.destroy();
            }

            let labels, scoreData, idealData;
            
            if (viewType === 'front') {
                labels = ['ãƒœãƒ¼ãƒ«ä½ç½®', 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…', 'é‡å¿ƒé…åˆ†', 'ãƒãƒ©ãƒ³ã‚¹', 'é ­ã®ä½ç½®'];
                scoreData = [
                    scores.ballPosition,
                    scores.stance,
                    scores.weight,
                    scores.balance,
                    scores.headPosition
                ];
                idealData = [100, 100, 100, 100, 100];
            } else {
                labels = ['ä½“ã®å‘ã', 'å‰å‚¾è§’åº¦', 'æ‰‹ã®ä½ç½®', 'å‰å¾Œã®é‡å¿ƒ', 'èƒŒç­‹ã®æ›²ãŒã‚Š'];
                scoreData = [
                    scores.bodyAlignment,
                    scores.forwardTilt,
                    scores.handPosition,
                    scores.frontBackWeight,
                    scores.spinalCurve
                ];
                idealData = [100, 100, 100, 100, 100];
            }

            const data = {
                labels: labels,
                datasets: [{
                    label: 'ã‚ãªãŸã®ã‚¹ã‚³ã‚¢',
                    data: scoreData,
                    backgroundColor: 'rgba(102, 126, 234, 0.3)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(102, 126, 234, 1)',
                    pointHoverRadius: 8
                }, {
                    label: 'ç†æƒ³å€¤',
                    data: idealData,
                    backgroundColor: 'rgba(40, 167, 69, 0.15)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(40, 167, 69, 1)',
                    pointHoverRadius: 7
                }]
            };

            // ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³åˆ¤å®š
            const isMobile = window.innerWidth <= 768;
            
            const config = {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: isMobile ? {
                            top: 40,
                            bottom: 40,
                            left: 25,
                            right: 25
                        } : {
                            top: 50,
                            bottom: 50,
                            left: 50,
                            right: 50
                        }
                    },
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            pointLabels: {
                                font: {
                                    size: isMobile ? 12 : 14,
                                    weight: 'bold'
                                },
                                color: '#333',
                                padding: isMobile ? 15 : 20
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#333',
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: `ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹åˆ†æ - ${viewType === 'front' ? 'æ­£é¢è¦–ç‚¹' : 'å¾Œæ–¹è¦–ç‚¹'}`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333',
                            padding: 20
                        }
                    }
                }
            };

            radarChartInstance = new Chart(ctx, config);
        }

        // ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function getStanceAdvice(stanceStatus, clubType) {
            // ç†æƒ³ã®è¡¨ç¾ã‚’åˆ†ã‹ã‚Šã‚„ã™ã
            const idealDescription = clubType === 'Driver' ? 
                'è‚©å¹…ã‚ˆã‚Šã‚‚å°‘ã—åºƒã‚' :
                'è‚©å¹…ç¨‹åº¦';
                
            switch(stanceStatus) {
                case 'slightly_narrow':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚å°‘ã—ç‹­ã‚ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'narrow':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚ç‹­ã„ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'too_narrow':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚ã‹ãªã‚Šç‹­ã„ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'much_too_narrow':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚éå¸¸ã«ç‹­ã™ãã¾ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'slightly_wide':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚å°‘ã—åºƒã‚ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'wide':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚åºƒã„ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'too_wide':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚ã‹ãªã‚Šåºƒã„ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'much_too_wide':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚éå¸¸ã«åºƒã™ãã¾ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                default:
                    return `ç†æƒ³ï¼š${idealDescription}`;
            }
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function getBallPositionAdvice(score, ballPositionData) {
            if (score >= 80) {
                return 'ãƒœãƒ¼ãƒ«ä½ç½®ã¯é©åˆ‡ã§ã™ã€‚ã“ã®ä½ç½®ã‚’æ„è­˜ã—ã¦ã‚¢ãƒ‰ãƒ¬ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚';
            }
            
            if (!ballPositionData) {
                return 'ãƒœãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚';
            }
            
            const { clubType, isLeftOfIdeal } = ballPositionData;
            
            // ã‚¯ãƒ©ãƒ–åˆ¥ã®ç†æƒ³ä½ç½®ã®èª¬æ˜
            const idealDescription = getIdealBallPositionDescription(clubType);
            
            // ç¾åœ¨ä½ç½®ãŒç†æƒ³ä½ç½®ã‚ˆã‚Šã‚‚å·¦ã«ã‚ã‚‹ã‹å³ã«ã‚ã‚‹ã‹
            const direction = isLeftOfIdeal ? 'å³å¯„ã‚Š' : 'å·¦å¯„ã‚Š';
            const currentStatus = isLeftOfIdeal ? 'ç†æƒ³ã‚ˆã‚Šã‚‚å·¦' : 'ç†æƒ³ã‚ˆã‚Šã‚‚å³';
            
            return `ç¾çŠ¶ã¯${currentStatus}ã«ã‚ã‚Šã¾ã™ã€‚\nğŸŒï¸â€â™‚ï¸ ç†æƒ³ï¼š${idealDescription}\nğŸ’¡ ${direction}ã«èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚`;
        }
        
        // ç†æƒ³ãƒœãƒ¼ãƒ«ä½ç½®ã®èª¬æ˜
        function getIdealBallPositionDescription(clubType) {
            switch(clubType) {
                case 'Driver':
                    return 'å·¦è¶³ã‹ã‹ã¨ä½ç½®';
                case 'FairwayWood':
                    return 'å·¦è¶³ã‹ã‹ã¨å†…å´ã‚ˆã‚Šå°‘ã—å³';
                case 'Utility':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦';
                case '3Iron':
                case '4Iron':
                case '5Iron':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦';
                case '6Iron':
                case '7Iron':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®';
                case '8Iron':
                case '9Iron':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³';
                case 'Wedge':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®ã‚ˆã‚Šå³';
                default:
                    return 'ã‚¯ãƒ©ãƒ–ã«å¿œã˜ãŸé©åˆ‡ãªä½ç½®';
            }
        }

        // ç·åˆã‚¹ã‚³ã‚¢ã®å…·ä½“çš„ãªã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
        function generateTotalScoreAdvice(scores, viewType) {
            // è‰¯ã„é …ç›®ã¨æ”¹å–„ãŒå¿…è¦ãªé …ç›®ã‚’åˆ†é¡
            const goodItems = [];
            const poorItems = [];
            
            if (viewType === 'front') {
                const items = [
                    { key: 'ballPosition', name: 'ãƒœãƒ¼ãƒ«ä½ç½®' },
                    { key: 'stance', name: 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…' },
                    { key: 'weight', name: 'é‡å¿ƒé…åˆ†' },
                    { key: 'balance', name: 'ãƒãƒ©ãƒ³ã‚¹' },
                    { key: 'headPosition', name: 'é ­ã®ä½ç½®' }
                ];
                items.forEach(item => {
                    if (scores[item.key] >= 75) {
                        goodItems.push(item.name);
                    } else if (scores[item.key] < 70) {
                        poorItems.push(item.name);
                    }
                });
            } else {
                const items = [
                    { key: 'bodyAlignment', name: 'ä½“ã®å‘ã' },
                    { key: 'forwardTilt', name: 'å‰å‚¾è§’åº¦' },
                    { key: 'handPosition', name: 'æ‰‹ã®ä½ç½®' },
                    { key: 'frontBackWeight', name: 'å‰å¾Œã®é‡å¿ƒ' },
                    { key: 'spinalCurve', name: 'èƒŒç­‹ã®æ›²ãŒã‚Š' }
                ];
                items.forEach(item => {
                    if (scores[item.key] >= 75) {
                        goodItems.push(item.name);
                    } else if (scores[item.key] < 70) {
                        poorItems.push(item.name);
                    }
                });
            }
            
            const totalScore = scores.total;
            let advice = '';
            
            if (totalScore >= 90) {
                advice = 'ğŸ† ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãªã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ï¼';
                if (goodItems.length > 0) {
                    advice += `ç‰¹ã«ã€${goodItems.join('ãƒ»')}ã€‘ãŒå„ªç§€ã§ã€ãƒ—ãƒ­ãƒ¬ãƒ™ãƒ«ã®å®‰å®šã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–ã‚Œã¦ã„ã¾ã™ã€‚`;
                }
                advice += 'ã“ã®ç´ æ™´ã‚‰ã—ã„å§¿å‹¢ã‚’ç¶­æŒã—ã¦ã‚¹ã‚¤ãƒ³ã‚°ã—ã¾ã—ã‚‡ã†ã€‚ãã£ã¨è‰¯ã„ã‚¹ã‚³ã‚¢ãŒæœŸå¾…ã§ãã¾ã™ã€‚';
            } else if (totalScore >= 85) {
                advice = 'âœ¨ éå¸¸ã«è‰¯ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ï¼';
                if (goodItems.length > 0) {
                    advice += `ã€${goodItems.join('ãƒ»')}ã€‘ãŒç‰¹ã«è‰¯å¥½ã§ã€ã»ã¼ç†æƒ³çš„ãªå§¿å‹¢ãŒå–ã‚Œã¦ã„ã¾ã™ã€‚`;
                }
                if (poorItems.length > 0) {
                    advice += `ã€${poorItems.join('ãƒ»')}ã€‘ã‚’å¾®èª¿æ•´ã™ã‚‹ã“ã¨ã§ã€ã•ã‚‰ã«å®‰å®šã—ãŸã‚·ãƒ§ãƒƒãƒˆãŒæ‰“ã¦ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚`;
                }
            } else if (totalScore >= 75) {
                advice = 'ğŸ‘ è‰¯ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚';
                if (goodItems.length > 0) {
                    advice += `ã€${goodItems.join('ãƒ»')}ã€‘ã¯è‰¯å¥½ãªçŠ¶æ…‹ã§ã™ã€‚`;
                }
                if (poorItems.length > 0) {
                    advice += `ã€${poorItems.join('ãƒ»')}ã€‘ã‚’é‡ç‚¹çš„ã«æ”¹å–„ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šè‰¯ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãªã‚Šã¾ã™ã€‚`;
                }
                advice += 'ç¶™ç¶šçš„ãªç·´ç¿’ã§ç¢ºå®Ÿã«ä¸Šé”ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚';
            } else if (totalScore >= 65) {
                advice = 'âš ï¸ ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚';
                if (goodItems.length > 0) {
                    advice += `ã€${goodItems.join('ãƒ»')}ã€‘ã¯è‰¯ã„çŠ¶æ…‹ã‚’ã‚­ãƒ¼ãƒ—ã§ãã¦ã„ã¾ã™ã€‚`;
                }
                if (poorItems.length > 0) {
                    advice += `ç‰¹ã«ã€${poorItems.join('ãƒ»')}ã€‘ã®è¦‹ç›´ã—ãŒé‡è¦ã§ã™ã€‚`;
                }
                advice += 'åŸºæœ¬ã«ç«‹ã¡è¿”ã£ã¦ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚';
            } else if (totalScore >= 50) {
                advice = 'ğŸ“š ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åŸºæœ¬ã‹ã‚‰è¦‹ç›´ã—ã¾ã—ã‚‡ã†ã€‚';
                if (goodItems.length > 0) {
                    advice += `ã€${goodItems.join('ãƒ»')}ã€‘ã¯è‰¯ã„å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚`;
                }
                if (poorItems.length > 0) {
                    advice += `ã€${poorItems.join('ãƒ»')}ã€‘ã‚’ä¸­å¿ƒã«åŸºæœ¬çš„ãªã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¦ç´ ã‚’ç¢ºèªã—ã€æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†ã€‚`;
                }
            } else {
                advice = 'ğŸ”„ ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¹æœ¬ã‹ã‚‰è¦‹ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚';
                if (poorItems.length > 0) {
                    advice += `ç‰¹ã«ã€${poorItems.join('ãƒ»')}ã€‘ã®å¤§å¹…ãªæ”¹å–„ãŒå¿…è¦ã§ã™ã€‚`;
                }
                advice += 'ãƒ—ãƒ­ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’å—ã‘ã‚‹ã‹ã€åŸºæœ¬çš„ãªæ•™æã‚’å‚è€ƒã«ã—ã¦ã€æ­£ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¿’å¾—ã—ã¾ã—ã‚‡ã†ã€‚ç¶™ç¶šçš„ãªç·´ç¿’ãŒé‡è¦ã§ã™ã€‚';
            }
            
            return advice;
        }

        // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function generateAdvice(scores) {
            const clubType = document.getElementById('clubSelect').value;
            const viewType = document.getElementById('viewSelect').value;
            
            let advice = {
                total: generateTotalScoreAdvice(scores, viewType),
                
                spine: scores.spine >= 80 ? 
                    'è„Šæ¤ã®ç›´ç·šæ€§ã¯è‰¯å¥½ã§ã™ã€‚ã“ã®å§¿å‹¢ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                    'æ­£é¢ã‹ã‚‰è¦‹ã¦ã€è‚©ã¨è…°ã®ä¸­å¿ƒãŒä¸€ç›´ç·šã«ãªã‚‹ã‚ˆã†æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚å·¦å³ã®å‚¾ãã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚',
                
                shoulder: scores.shoulder >= 80 ? 
                    'è‚©ã®ä½ç½®ã¯é©åˆ‡ã§ã™ã€‚ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸçŠ¶æ…‹ã‚’ä¿ã¡ã¾ã—ã‚‡ã†ã€‚' :
                    'ä¸¡è‚©ã®é«˜ã•ã‚’æƒãˆã¦ãã ã•ã„ã€‚æ­£é¢ã‹ã‚‰è¦‹ã¦æ°´å¹³ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚',
                
                knee: scores.knee >= 80 ? 
                    'è†ã®ä½ç½®ã¯è‰¯å¥½ã§ã™ã€‚ã“ã®å®‰å®šã—ãŸã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                    'è†ãŒè‚¡é–¢ç¯€ã®çœŸä¸‹ã«æ¥ã‚‹ã‚ˆã†èª¿æ•´ã—ã€ä¸¡è†ã®é«˜ã•ã‚’æƒãˆã¾ã—ã‚‡ã†ã€‚',
                
                ballPosition: getBallPositionAdvice(scores.ballPosition, scores.ballPositionData),
                
                stance: scores.stance >= 80 ? 
                    (clubType === 'Driver' ? 
                        'ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã¯é©åˆ‡ã§ã™ã€‚ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯è‚©å¹…ã‚ˆã‚Šã‚‚å°‘ã—åºƒã„ãã‚‰ã„ãŒç†æƒ³ã§ã™ã€‚' :
                        'ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã¯é©åˆ‡ã§ã™ã€‚è‚©å¹…ãŒç†æƒ³çš„ã§ã™ã€‚') :
                    getStanceAdvice(scores.stanceStatus, clubType),
                
                weight: scores.weight >= 80 ? 
                    'é‡å¿ƒé…åˆ†ã¯é©åˆ‡ã§ã™ã€‚ã“ã®æ„Ÿè¦šã‚’è¦šãˆã¦ãŠãã¾ã—ã‚‡ã†ã€‚' :
                    (function() {
                        if (scores.weightData) {
                            const data = scores.weightData;
                            let advice = `ç¾çŠ¶ã¯${data.currentBalance}ã§ã™ã€‚`;
                            
                            if (data.status.includes('left')) {
                                advice += 'å·¦è¶³ã¸ã®é‡å¿ƒã‚’æ¸›ã‚‰ã—ã€å³è¶³ã«ã‚‚ã†å°‘ã—ä½“é‡ã‚’ã‹ã‘ã¾ã—ã‚‡ã†ã€‚';
                            } else if (data.status.includes('right')) {
                                advice += 'å³è¶³ã¸ã®é‡å¿ƒã‚’æ¸›ã‚‰ã—ã€å·¦è¶³ã«ã‚‚ã†å°‘ã—ä½“é‡ã‚’ã‹ã‘ã¾ã—ã‚‡ã†ã€‚';
                            }
                            
                            advice += `\nğŸ“ ç†æƒ³ã®é…åˆ†ï¼š${data.idealBalance}`;
                            return advice;
                        }
                        return clubType === 'Driver' ? 
                            'é‡å¿ƒã‚’ã‚‚ã†å°‘ã—å³è¶³ã«ç§»ã—ã¾ã—ã‚‡ã†ï¼ˆ6:4ã®é…åˆ†ï¼‰ã€‚ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§ã¯å³é‡å¿ƒãŒç†æƒ³ã§ã™ã€‚' :
                            'é‡å¿ƒã‚’å·¦å³å‡ç­‰ã«é…åˆ†ã—ã¾ã—ã‚‡ã†ï¼ˆ5:5ã®é…åˆ†ï¼‰ã€‚ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚';
                    })(),
                
                balance: scores.balance >= 80 ? 
                    'ãƒãƒ©ãƒ³ã‚¹ã¯è‰¯å¥½ã§ã™ã€‚ã“ã®å®‰å®šã—ãŸå§¿å‹¢ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                    (function() {
                        let advice = 'ç¾çŠ¶ã¯ä¸ŠåŠèº«ã¨ä¸‹åŠèº«ã®ãƒãƒ©ãƒ³ã‚¹ãŒå´©ã‚Œã¦ã„ã¾ã™ã€‚';
                        advice += 'è‚©ã¨è…°ã®ãƒ©ã‚¤ãƒ³ã‚’å¹³è¡Œã«ä¿ã¡ã€é‡å¿ƒã‚’ä¸­å¤®ã«ç½®ãã‚ˆã†èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚';
                        advice += '\nğŸ“ ç†æƒ³ã®å½¢ï¼šä¸ŠåŠèº«ã¨ä¸‹åŠèº«ã®ä¸­å¿ƒè»¸ãŒä¸€ç›´ç·š';
                        return advice;
                    })(),
                
                headPosition: scores.headPosition >= 80 ? 
                    'é ­ã®ä½ç½®ã¯é©åˆ‡ã§ã™ã€‚ã“ã®çŠ¶æ…‹ã‚’ä¿ã¡ã¾ã—ã‚‡ã†ã€‚' :
                    (function() {
                        let advice = 'ç¾çŠ¶ã¯é ­ãŒå·¦å³ã®ã©ã¡ã‚‰ã‹ã«å‚¾ã„ã¦ã„ã¾ã™ã€‚';
                        advice += 'é ­ã‚’ä¸¡è‚©ã®ä¸­å¤®ã«ä½ç½®ã•ã›ã€å·¦å³ã«å‚¾ã‹ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚';
                        advice += '\nğŸ“ ç†æƒ³ã®å½¢ï¼šé ­ãŒä¸¡è‚©ã®çœŸã‚“ä¸­ã«ä½ç½®ã—ã€é¦–ç­‹ãŒè‡ªç„¶ã«ä¼¸ã³ãŸçŠ¶æ…‹';
                        return advice;
                    })()
            };
            
            if (viewType === 'back') {
                advice = {
                    ...advice,
                    bodyAlignment: scores.bodyAlignment >= 80 ? 
                        'ä½“ã®å‘ãã¯è‰¯å¥½ã§ã™ã€‚è‚©ã€è…°ã€ã‹ã‹ã¨ãŒé©åˆ‡ã«æƒã£ã¦ã„ã¾ã™ã€‚' :
                        (function() {
                            let advice = 'ç¾çŠ¶ã¯è‚©ã€è…°ã€ã‹ã‹ã¨ã®ãƒ©ã‚¤ãƒ³ãŒç›®æ¨™æ–¹å‘ã«å¯¾ã—ã¦ã‚ºãƒ¬ã¦ã„ã¾ã™ã€‚';
                            advice += 'ä½“å…¨ä½“ã‚’ç›®æ¨™æ–¹å‘ã«å¹³è¡Œã«å‘ã‘ã‚‹ã‚ˆã†èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚';
                            advice += '\nğŸ“ ç†æƒ³ã®å½¢ï¼šè‚©ãƒ»è…°ãƒ»ã‹ã‹ã¨ã®ãƒ©ã‚¤ãƒ³ãŒç›®æ¨™æ–¹å‘ã¨å¹³è¡Œã§ä¸€ç›´ç·š';
                            return advice;
                        })(),
                    
                    forwardTilt: scores.forwardTilt >= 80 ? 
                        'å‰å‚¾è§’åº¦ã¯é©åˆ‡ã§ã™ã€‚ã“ã®è§’åº¦ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                        (function() {
                            if (scores.forwardTiltData) {
                                const data = scores.forwardTiltData;
                                const current = data.currentValue;
                                const ideal = data.idealValue;
                                let advice = '';
                                
                                if (current < ideal) {
                                    advice = 'ç¾åœ¨ã®å‰å‚¾è§’åº¦ãŒæµ…ã™ãã¾ã™ã€‚ã‚‚ã£ã¨æ·±ãå‰å‚¾ã—ã¾ã—ã‚‡ã†ã€‚';
                                } else {
                                    advice = 'ç¾åœ¨ã®å‰å‚¾è§’åº¦ãŒæ·±ã™ãã¾ã™ã€‚å‰å‚¾ã‚’æµ…ãã—ã¾ã—ã‚‡ã†ã€‚';
                                }
                                advice += 'è‚¡é–¢ç¯€ã‹ã‚‰å‰å‚¾ã—ã€èƒŒç­‹ã¯ã¾ã£ã™ãä¿ã¡ã¾ã™ã€‚';
                                return advice;
                            }
                            return 'å‰å‚¾è§’åº¦ã‚’èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚è‚¡é–¢ç¯€ã‹ã‚‰å‰å‚¾ã—ã€èƒŒç­‹ã¯ã¾ã£ã™ãä¿ã¡ã¾ã™ã€‚';
                        })(),
                    
                    handPosition: scores.handPosition >= 80 ? 
                        'æ‰‹ã®ä½ç½®ã¯é©åˆ‡ã§ã™ã€‚ã“ã®ä½ç½®ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                        (function() {
                            if (scores.handPositionData) {
                                const data = scores.handPositionData;
                                const current = data.currentValue;
                                const ideal = data.idealValue;
                                let advice = '';
                                let currentStatus = '';
                                let idealPosition = '';
                                
                                if (clubType === 'Driver') {
                                    idealPosition = 'è‚©ã®çœŸä¸‹ã‚ˆã‚Šå°‘ã—å‰ï¼ˆä½“ã‹ã‚‰é›¢ã‚Œã‚‹ï¼‰';
                                } else {
                                    idealPosition = 'è‚©ã®çœŸä¸‹ï¼ˆä½“ã¨ã®è·é›¢ã¯æ‹³ï¼‘ï¼ï¼•ï½ï¼’å€‹ãã‚‰ã„ï¼‰';
                                }
                                
                                if (current > ideal) {
                                    currentStatus = 'ä½“ã‹ã‚‰é ã™ãã‚‹ä½ç½®';
                                    advice = `ç¾åœ¨æ‰‹ãŒ${currentStatus}ã«ã‚ã‚Šã¾ã™ã€‚ã‚‚ã†å°‘ã—ä½“ã«è¿‘ã¥ã‘ã¾ã—ã‚‡ã†ã€‚`;
                                } else {
                                    currentStatus = 'ä½“ã«è¿‘ã™ãã‚‹ä½ç½®';
                                    advice = `ç¾åœ¨æ‰‹ãŒ${currentStatus}ã«ã‚ã‚Šã¾ã™ã€‚ã‚‚ã†å°‘ã—ä½“ã‹ã‚‰é›¢ã—ã¾ã—ã‚‡ã†ã€‚`;
                                }
                                advice += `\nğŸ“ ç†æƒ³ã®ä½ç½®ï¼š${idealPosition}`;
                                return advice;
                            }
                            return clubType === 'Driver' ? 
                                'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®å ´åˆã€æ‰‹ã¯è‚©ã®çœŸä¸‹ã‚ˆã‚Šå°‘ã—å‰ï¼ˆä½“ã‹ã‚‰é›¢ã‚Œã‚‹ï¼‰ã«ä½ç½®ã—ã¾ã—ã‚‡ã†ã€‚' :
                                'æ‰‹ã¯è‚©ã®çœŸä¸‹ã«ä½ç½®ã—ã€ä½“ã¨ã®è·é›¢ã¯æ‹³ï¼‘ï¼ï¼•ï½ï¼’å€‹ãã‚‰ã„ã«ã—ã¾ã—ã‚‡ã†ã€‚';
                        })(),
                    
                    frontBackWeight: scores.frontBackWeight >= 80 ? 
                        'å‰å¾Œã®é‡å¿ƒã¯é©åˆ‡ã§ã™ã€‚ã“ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                        (function() {
                            let advice = 'ç¾çŠ¶ã¯å‰å¾Œã®é‡å¿ƒãƒãƒ©ãƒ³ã‚¹ãŒå´©ã‚Œã¦ã„ã¾ã™ã€‚';
                            advice += 'ã‹ã‹ã¨é‡å¿ƒã«ãªã‚Šã™ããªã„ã‚ˆã†ã€é‡å¿ƒã‚’ãƒœãƒ¼ãƒ«å´ï¼ˆã¤ã¾å…ˆå´ï¼‰ã«ã‚„ã‚„ç§»ã—ã¾ã—ã‚‡ã†ã€‚';
                            advice += '\nğŸ“ ç†æƒ³ã®å½¢ï¼šé‡å¿ƒãŒè¶³è£ã®ä¸­å¤®ã‹ã‚‰ã‚„ã‚„å‰å´ï¼ˆãƒœãƒ¼ãƒ«å´ï¼‰ã«ä½ç½®';
                            return advice;
                        })(),
                    
                    spinalCurve: scores.spinalCurve >= 80 ? 
                        'èƒŒç­‹ã®æ›²ãŒã‚Šå…·åˆã¯è‰¯å¥½ã§ã™ã€‚è‡ªç„¶ãªï¼³å­—ã‚«ãƒ¼ãƒ–ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                        (function() {
                            if (scores.spinalCurveData && scores.spinalCurveData.description) {
                                const data = scores.spinalCurveData;
                                let advice = `ç¾åœ¨${data.description}ã®çŠ¶æ…‹ã§ã™ã€‚`;
                                
                                if (data.description.includes('çŒ«èƒŒ')) {
                                    advice += 'èƒ¸ã‚’å¼µã‚Šã€è‚©ç”²éª¨ã‚’å¯„ã›ã¦èƒŒç­‹ã‚’ä¼¸ã°ã—ã¾ã—ã‚‡ã†ã€‚';
                                } else if (data.description.includes('åã‚Š')) {
                                    advice += 'è…°ã®åã‚Šã‚’æŠ‘ãˆã€ãŠè…¹ã«è»½ãåŠ›ã‚’å…¥ã‚Œã¦è‡ªç„¶ãªå§¿å‹¢ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚';
                                } else {
                                    advice += 'èƒŒç­‹ã®è‡ªç„¶ãªï¼³å­—ã‚«ãƒ¼ãƒ–ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚';
                                }
                                return advice;
                            }
                            return 'èƒŒç­‹ã®è‡ªç„¶ãªï¼³å­—ã‚«ãƒ¼ãƒ–ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚çŒ«èƒŒã‚„åã‚Šè…¹ã«ãªã‚‰ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚';
                        })()
                };
            }
            
            return advice;
        }

        // è¨ºæ–­é–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ¢ãƒã‚¤ãƒ«æ¤œå‡ºã¨UIèª¿æ•´
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                document.getElementById('mobileButtons').style.display = 'flex';
                // ãƒ¡ã‚¤ãƒ³ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–
                const uploadArea = document.querySelector('.upload-area');
                uploadArea.onclick = null;
                uploadArea.style.cursor = 'default';
            }
            
            // ã‚«ãƒ¡ãƒ©ã¨ã‚®ãƒ£ãƒ©ãƒªãƒ¼å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
            document.getElementById('cameraInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            document.getElementById('galleryInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleImageUpload(e.target.files[0]);
                }
            });
            
            // UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å³åº§ã«æœ‰åŠ¹åŒ–
            document.getElementById('viewSelect').disabled = false;
            document.getElementById('clubSelect').disabled = false;
            document.getElementById('startDiagnosis').disabled = false;
            
            // MediaPipeã¯éåŒæœŸã§åˆæœŸåŒ–ï¼ˆUIãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
       
