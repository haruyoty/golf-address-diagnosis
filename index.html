<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ« - ãƒ¢ãƒã‚¤ãƒ«ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .image-container {
            position: relative;
            margin: 15px 0;
            text-align: center;
        }
        
        #uploadedImage {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        #imageCanvas {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
            cursor: crosshair;
        }
        
        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .control-group select,
        .control-group button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .control-group button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .control-group button:hover {
            opacity: 0.9;
        }
        
        .control-group button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .result-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .file-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .mobile-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .mobile-buttons button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        
        .camera-btn {
            background: #667eea;
        }
        
        .gallery-btn {
            background: #764ba2;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.info {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid #007bff;
            color: #007bff;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            color: #28a745;
        }
        
        .status.warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒï¸ ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
            <p>ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œç‰ˆ - ç°¡å˜è¨ºæ–­</p>
        </div>

        <div class="upload-section">
            <h3>ğŸ“¸ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            
            <!-- é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼ˆPCãƒ»ãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ -->
            <input type="file" id="imageInput" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
            
            <!-- ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ãƒœã‚¿ãƒ³ -->
            <div class="mobile-buttons">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(event)">
                <input type="file" id="galleryInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <button class="camera-btn" onclick="triggerCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
                <button class="gallery-btn" onclick="triggerGallery()">ğŸ–¼ï¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‹ã‚‰é¸æŠ</button>
            </div>
            
            <!-- ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ -->
            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px;">
                <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                <button onclick="testFileInput()" style="font-size: 12px; padding: 5px 10px;">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ†ã‚¹ãƒˆ</button>
                <button onclick="showDebugInfo()" style="font-size: 12px; padding: 5px 10px;">ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±è¡¨ç¤º</button>
            </div>
            
            <div class="image-container" id="imageContainer" style="display: none;">
                <img id="uploadedImage" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ">
                <canvas id="imageCanvas"></canvas>
            </div>
            
            <div id="status" class="status info">
                ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="clubSelect">ã‚¯ãƒ©ãƒ–ã®ç¨®é¡:</label>
                <select id="clubSelect">
                    <option value="driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
                    <option value="iron">ã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="wedge">ã‚¦ã‚§ãƒƒã‚¸</option>
                </select>
            </div>

            <div class="control-group">
                <label for="viewSelect">æ’®å½±è¦–ç‚¹:</label>
                <select id="viewSelect">
                    <option value="front">æ­£é¢è¦–ç‚¹</option>
                    <option value="back">å¾Œæ–¹è¦–ç‚¹</option>
                </select>
            </div>

            <div class="control-group">
                <button id="diagnoseBtn" onclick="startDiagnosis()" disabled>è¨ºæ–­é–‹å§‹</button>
            </div>
        </div>

        <div id="resultSection" class="result-section">
            <h3>è¨ºæ–­çµæœ</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let uploadedImage = null;
        let ballPosition = null;
        let canvasContext = null;
        
        // ã‚«ãƒ¡ãƒ©ãƒ»ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒœã‚¿ãƒ³é–¢æ•°
        function triggerCamera() {
            console.log('ã‚«ãƒ¡ãƒ©ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
            document.getElementById('cameraInput').click();
        }
        
        function triggerGallery() {
            console.log('ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
            document.getElementById('galleryInput').click();
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            console.log('handleImageUploadå‘¼ã³å‡ºã—:', event.target.id, file ? file.name : 'ãƒ•ã‚¡ã‚¤ãƒ«ãªã—');
            
            if (!file) {
                updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                return;
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ãƒã‚§ãƒƒã‚¯
            if (!file.type.startsWith('image/')) {
                updateStatus('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            updateStatus('ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');
            
            const reader = new FileReader();
            reader.onerror = function() {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
            };
            
            reader.onload = function(e) {
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
                const img = document.getElementById('uploadedImage');
                
                img.onerror = function() {
                    console.error('ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                    updateStatus('ç”»åƒã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                };
                
                img.onload = function() {
                    console.log('ç”»åƒè¡¨ç¤ºæˆåŠŸ:', img.naturalWidth, 'x', img.naturalHeight);
                    uploadedImage = img;
                    setupCanvas();
                    updateStatus('ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„', 'info');
                    document.getElementById('imageContainer').style.display = 'block';
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        function setupCanvas() {
            const img = document.getElementById('uploadedImage');
            const canvas = document.getElementById('imageCanvas');
            const container = document.getElementById('imageContainer');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’ç”»åƒã®è¡¨ç¤ºã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
            const imgRect = img.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            canvas.width = img.offsetWidth;
            canvas.height = img.offsetHeight;
            canvas.style.width = img.offsetWidth + 'px';
            canvas.style.height = img.offsetHeight + 'px';
            
            canvasContext = canvas.getContext('2d');
            
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('touchstart', handleCanvasTouch, { passive: false });
            
            console.log('ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®šå®Œäº†:', canvas.width, 'x', canvas.height);
        }
        
        function handleCanvasClick(event) {
            handlePositionInput(event, 'click');
        }
        
        function handleCanvasTouch(event) {
            event.preventDefault();
            handlePositionInput(event, 'touch');
        }
        
        function handlePositionInput(event, type) {
            const canvas = document.getElementById('imageCanvas');
            const rect = canvas.getBoundingClientRect();
            
            let clientX, clientY;
            if (type === 'touch' && event.touches.length > 0) {
                clientX = event.touches[0].clientX;
                clientY = event.touches[0].clientY;
            } else {
                clientX = event.clientX;
                clientY = event.clientY;
            }
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            // æ­£è¦åŒ–åº§æ¨™ï¼ˆ0-1ã®ç¯„å›²ï¼‰
            const normalizedX = x / rect.width;
            const normalizedY = y / rect.height;
            
            ballPosition = { x: normalizedX, y: normalizedY };
            
            // ãƒœãƒ¼ãƒ«ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’æç”»
            drawBallMarker(x, y);
            updateStatus('ãƒœãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®šã—ã¾ã—ãŸã€‚è¨ºæ–­ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'success');
            document.getElementById('diagnoseBtn').disabled = false;
            
            console.log('ãƒœãƒ¼ãƒ«ä½ç½®è¨­å®š:', ballPosition);
        }
        
        function drawBallMarker(x, y) {
            if (!canvasContext) return;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
            canvasContext.clearRect(0, 0, canvasContext.canvas.width, canvasContext.canvas.height);
            
            // ãƒœãƒ¼ãƒ«ãƒãƒ¼ã‚«ãƒ¼ã‚’æç”»
            canvasContext.fillStyle = 'rgba(255, 255, 0, 0.8)';
            canvasContext.beginPath();
            canvasContext.arc(x, y, 15, 0, 2 * Math.PI);
            canvasContext.fill();
            
            canvasContext.strokeStyle = '#ff6b00';
            canvasContext.lineWidth = 3;
            canvasContext.stroke();
            
            // ãƒ†ã‚­ã‚¹ãƒˆ
            canvasContext.fillStyle = '#000';
            canvasContext.font = 'bold 12px Arial';
            canvasContext.textAlign = 'center';
            canvasContext.fillText('âšª', x, y - 20);
        }
        
        function startDiagnosis() {
            if (!ballPosition) {
                alert('ãƒœãƒ¼ãƒ«ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            updateStatus('è¨ºæ–­ã‚’å®Ÿè¡Œä¸­...', 'info');
            document.getElementById('diagnoseBtn').disabled = true;
            
            // ç°¡å˜ãªè¨ºæ–­å®Ÿè¡Œï¼ˆé…å»¶ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
            setTimeout(() => {
                performSimpleDiagnosis();
            }, 1500);
        }
        
        function performSimpleDiagnosis() {
            const clubType = document.getElementById('clubSelect').value;
            const viewType = document.getElementById('viewSelect').value;
            
            // ç°¡æ˜“ã‚¹ã‚³ã‚¢è¨ˆç®—
            const score = calculateBallPositionScore(ballPosition.x, clubType);
            
            displayResults(score, clubType, viewType);
            updateStatus('è¨ºæ–­å®Œäº†ï¼', 'success');
            document.getElementById('diagnoseBtn').disabled = false;
        }
        
        function calculateBallPositionScore(x, clubType) {
            // ã‚¯ãƒ©ãƒ–ã‚¿ã‚¤ãƒ—åˆ¥ç†æƒ³ä½ç½®
            const idealPositions = {
                'driver': 0.35,   // å·¦å¯„ã‚Š
                'iron': 0.5,      // ä¸­å¤®
                'wedge': 0.6      // å³å¯„ã‚Š
            };
            
            const ideal = idealPositions[clubType] || 0.5;
            const deviation = Math.abs(x - ideal);
            
            let score;
            if (deviation < 0.05) score = 95;
            else if (deviation < 0.1) score = 85;
            else if (deviation < 0.15) score = 75;
            else if (deviation < 0.2) score = 65;
            else score = 50;
            
            return score;
        }
        
        function displayResults(score, clubType, viewType) {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            let advice = '';
            if (score >= 85) {
                advice = 'âœ… å„ªç§€ã§ã™ï¼ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ã§ã™ã€‚';
            } else if (score >= 70) {
                advice = 'ğŸ‘ è‰¯å¥½ã§ã™ã€‚å°‘ã—èª¿æ•´ã™ã‚‹ã“ã¨ã§ã•ã‚‰ã«å‘ä¸Šã§ãã¾ã™ã€‚';
            } else {
                advice = 'ğŸ“ æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚ãƒœãƒ¼ãƒ«ä½ç½®ã‚’è¦‹ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
            }
            
            resultContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #667eea;">ç·åˆã‚¹ã‚³ã‚¢: ${score}ç‚¹</h2>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4>ğŸ“Š ãƒœãƒ¼ãƒ«ä½ç½®è©•ä¾¡</h4>
                    <p><strong>ã‚¯ãƒ©ãƒ–:</strong> ${getClubName(clubType)}</p>
                    <p><strong>è¦–ç‚¹:</strong> ${getViewName(viewType)}</p>
                    <p><strong>ã‚¹ã‚³ã‚¢:</strong> ${score}ç‚¹</p>
                </div>
                
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px;">
                    <h4>ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h4>
                    <p>${advice}</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">
                        â€» ã“ã®è¨ºæ–­ã¯ç°¡æ˜“ç‰ˆã§ã™ã€‚ã‚ˆã‚Šè©³ç´°ãªåˆ†æã«ã¤ã„ã¦ã¯ã€PCç‰ˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
                    </p>
                </div>
            `;
            
            resultSection.style.display = 'block';
        }
        
        function getClubName(clubType) {
            const names = {
                'driver': 'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼',
                'iron': 'ã‚¢ã‚¤ã‚¢ãƒ³',
                'wedge': 'ã‚¦ã‚§ãƒƒã‚¸'
            };
            return names[clubType] || clubType;
        }
        
        function getViewName(viewType) {
            const names = {
                'front': 'æ­£é¢è¦–ç‚¹',
                'back': 'å¾Œæ–¹è¦–ç‚¹'
            };
            return names[viewType] || viewType;
        }
        
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        function testFileInput() {
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒ†ã‚¹ãƒˆ');
            const mainInput = document.getElementById('imageInput');
            const cameraInput = document.getElementById('cameraInput');
            const galleryInput = document.getElementById('galleryInput');
            
            console.log('ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›:', mainInput ? 'OK' : 'NG');
            console.log('ã‚«ãƒ¡ãƒ©å…¥åŠ›:', cameraInput ? 'OK' : 'NG');
            console.log('ã‚®ãƒ£ãƒ©ãƒªãƒ¼å…¥åŠ›:', galleryInput ? 'OK' : 'NG');
            
            updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ : ' + 
                (mainInput && cameraInput && galleryInput ? 'å…¨ã¦æ­£å¸¸' : 'ã‚¨ãƒ©ãƒ¼ã‚ã‚Š'), 'info');
        }
        
        function showDebugInfo() {
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const info = `
                ãƒ‡ãƒã‚¤ã‚¹: ${isMobile ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'PC'}
                UserAgent: ${navigator.userAgent}
                ãƒ•ã‚¡ã‚¤ãƒ«API: ${window.File ? 'ã‚µãƒãƒ¼ãƒˆ' : 'éã‚µãƒãƒ¼ãƒˆ'}
                FileReader: ${window.FileReader ? 'ã‚µãƒãƒ¼ãƒˆ' : 'éã‚µãƒãƒ¼ãƒˆ'}
                Canvas: ${document.createElement('canvas').getContext ? 'ã‚µãƒãƒ¼ãƒˆ' : 'éã‚µãƒãƒ¼ãƒˆ'}
            `;
            
            console.log(info);
            alert(info);
        }
        
        // åˆæœŸåŒ–
        console.log('ãƒ¢ãƒã‚¤ãƒ«è¨ºæ–­ãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†');
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        console.log('ãƒ‡ãƒã‚¤ã‚¹:', isMobile ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'PC');
        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ:', navigator.userAgent);
        console.log('ãƒ•ã‚¡ã‚¤ãƒ«API:', window.File ? 'ã‚µãƒãƒ¼ãƒˆ' : 'éã‚µãƒãƒ¼ãƒˆ');
        
        // è‡ªå‹•ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        window.addEventListener('load', function() {
            setTimeout(() => {
                updateStatus('ãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº† - ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„', 'info');
            }, 1000);
        });
    </script>
</body>
</html>
