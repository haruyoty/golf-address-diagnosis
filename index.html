<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ゴルフアドレス診断ツール - モバイル版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .image-container {
            position: relative;
            margin: 15px 0;
            text-align: center;
        }
        
        #uploadedImage {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        #imageCanvas {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
            cursor: crosshair;
        }
        
        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .control-group select,
        .control-group button {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .control-group button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .control-group button:hover {
            opacity: 0.9;
        }
        
        .control-group button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .result-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .file-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .mobile-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .mobile-buttons button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        
        .camera-btn {
            background: #667eea;
        }
        
        .gallery-btn {
            background: #764ba2;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.info {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid #007bff;
            color: #007bff;
        }
        
        .status.success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            color: #28a745;
        }
        
        .status.warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid #ffc107;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏌️ ゴルフアドレス診断ツール</h1>
            <p>モバイル対応版 - 簡単診断</p>
        </div>

        <div class="upload-section">
            <h3>📸 画像をアップロード</h3>
            
            <!-- 通常のファイル入力（PC・デバッグ用） -->
            <input type="file" id="imageInput" class="file-input" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" onchange="handleImageUpload(event)">
            
            <!-- モバイル専用ボタン -->
            <div class="mobile-buttons">
                <input type="file" id="cameraInput" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" capture="environment" style="display: none;" onchange="handleImageUpload(event)">
                <input type="file" id="galleryInput" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" style="display: none;" onchange="handleImageUpload(event)">
                <button class="camera-btn" onclick="triggerCamera()">📷 カメラで撮影</button>
                <button class="gallery-btn" onclick="triggerGallery()">🖼️ ギャラリーから選択</button>
            </div>
            
            <!-- テスト用デバッグボタン -->
            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px;">
                <strong>デバッグ情報:</strong><br>
                <button onclick="testFileInput()" style="font-size: 12px; padding: 5px 10px;">ファイル選択テスト</button>
                <button onclick="showDebugInfo()" style="font-size: 12px; padding: 5px 10px;">デバイス情報表示</button>
            </div>
            
            <div class="image-container" id="imageContainer" style="display: none;">
                <img id="uploadedImage" alt="アップロード画像">
                <canvas id="imageCanvas"></canvas>
            </div>
            
            <div id="status" class="status info">
                画像をアップロードしてください
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="clubSelect">クラブの種類:</label>
                <select id="clubSelect">
                    <option value="driver">ドライバー</option>
                    <option value="iron">アイアン</option>
                    <option value="wedge">ウェッジ</option>
                </select>
            </div>

            <div class="control-group">
                <label for="viewSelect">撮影視点:</label>
                <select id="viewSelect">
                    <option value="front">正面視点</option>
                    <option value="back">後方視点</option>
                </select>
            </div>

            <div class="control-group">
                <button id="diagnoseBtn" onclick="startDiagnosis()" disabled>診断開始</button>
            </div>
        </div>

        <div id="resultSection" class="result-section">
            <h3>診断結果</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let uploadedImage = null;
        let ballPosition = null;
        let canvasContext = null;
        
        // カメラ・ギャラリーボタン関数
        function triggerCamera() {
            console.log('カメラボタンクリック');
            document.getElementById('cameraInput').click();
        }
        
        function triggerGallery() {
            console.log('ギャラリーボタンクリック');
            document.getElementById('galleryInput').click();
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            console.log('handleImageUpload呼び出し:', event.target.id, file ? file.name : 'ファイルなし');
            
            if (!file) {
                updateStatus('ファイルが選択されませんでした', 'warning');
                return;
            }
            
            // ファイルタイプチェック
            if (!file.type.startsWith('image/')) {
                updateStatus('画像ファイルを選択してください', 'warning');
                return;
            }
            
            updateStatus('画像を読み込み中...', 'info');
            
            const reader = new FileReader();
            reader.onerror = function() {
                console.error('ファイル読み込みエラー');
                updateStatus('ファイルの読み込みに失敗しました', 'warning');
            };
            
            reader.onload = function(e) {
                console.log('ファイル読み込み完了');
                const img = document.getElementById('uploadedImage');
                
                img.onerror = function() {
                    console.error('画像読み込みエラー');
                    updateStatus('画像の表示に失敗しました', 'warning');
                };
                
                img.onload = function() {
                    console.log('画像表示成功:', img.naturalWidth, 'x', img.naturalHeight);
                    uploadedImage = img;
                    
                    // 画像表示を待ってからキャンバス設定
                    setTimeout(() => {
                        setupCanvas();
                        updateStatus('✅ 画像読み込み完了！下の画像でボール位置をタップしてください', 'success');
                        document.getElementById('imageContainer').style.display = 'block';
                    }, 300);
                };
                
                img.src = e.target.result;
            };
            
            reader.readAsDataURL(file);
        }
        
        function setupCanvas() {
            try {
                const img = document.getElementById('uploadedImage');
                const canvas = document.getElementById('imageCanvas');
                const container = document.getElementById('imageContainer');
                
                if (!img || !canvas || !container) {
                    console.error('必要な要素が見つかりません:', {img: !!img, canvas: !!canvas, container: !!container});
                    return;
                }
                
                // 画像の実際の表示サイズを取得（遅延後に再取得）
                setTimeout(() => {
                    const imgRect = img.getBoundingClientRect();
                    const displayWidth = img.offsetWidth || imgRect.width;
                    const displayHeight = img.offsetHeight || imgRect.height;
                    
                    console.log('画像表示サイズ:', displayWidth, 'x', displayHeight);
                    console.log('画像実サイズ:', img.naturalWidth, 'x', img.naturalHeight);
                    
                    if (displayWidth === 0 || displayHeight === 0) {
                        console.error('画像サイズが0です。再試行します...');
                        setTimeout(setupCanvas, 500);
                        return;
                    }
                    
                    // キャンバスサイズを画像表示サイズに設定
                    canvas.width = displayWidth;
                    canvas.height = displayHeight;
                    canvas.style.width = displayWidth + 'px';
                    canvas.style.height = displayHeight + 'px';
                    canvas.style.position = 'absolute';
                    canvas.style.top = '0';
                    canvas.style.left = '0';
                    canvas.style.pointerEvents = 'auto';
                    canvas.style.cursor = 'crosshair';
                    canvas.style.zIndex = '10';
                    
                    // コンテナを相対位置に設定
                    container.style.position = 'relative';
                    container.style.display = 'inline-block';
                    
                    canvasContext = canvas.getContext('2d');
                    
                    // イベントリスナーをクリア（重複防止）
                    canvas.removeEventListener('click', handleCanvasClick);
                    canvas.removeEventListener('touchstart', handleCanvasTouch);
                    
                    // 新しいイベントリスナーを追加
                    canvas.addEventListener('click', handleCanvasClick);
                    canvas.addEventListener('touchstart', handleCanvasTouch, { passive: false });
                    
                    console.log('キャンバス設定完了:', canvas.width, 'x', canvas.height);
                    
                    // 初期ガイドを描画
                    drawInitialGuide();
                    
                }, 100);
                
            } catch (error) {
                console.error('キャンバス設定エラー:', error);
                updateStatus('キャンバス設定に失敗しました', 'warning');
            }
        }
        
        // 初期ガイド描画
        function drawInitialGuide() {
            if (!canvasContext) return;
            
            const canvas = canvasContext.canvas;
            canvasContext.clearRect(0, 0, canvas.width, canvas.height);
            
            // 半透明の背景
            canvasContext.fillStyle = 'rgba(0, 0, 0, 0.1)';
            canvasContext.fillRect(0, 0, canvas.width, canvas.height);
            
            // 中央にガイドメッセージ
            canvasContext.fillStyle = 'rgba(255, 255, 255, 0.9)';
            canvasContext.fillRect(10, 10, canvas.width - 20, 60);
            
            canvasContext.fillStyle = '#333';
            canvasContext.font = 'bold 16px Arial';
            canvasContext.textAlign = 'center';
            canvasContext.fillText('⚪ ボール位置をタップ', canvas.width / 2, 35);
            canvasContext.font = '14px Arial';
            canvasContext.fillText('（足元付近のボールの位置）', canvas.width / 2, 55);
        }
        
        function handleCanvasClick(event) {
            handlePositionInput(event, 'click');
        }
        
        function handleCanvasTouch(event) {
            event.preventDefault();
            handlePositionInput(event, 'touch');
        }
        
        function handlePositionInput(event, type) {
            try {
                const canvas = document.getElementById('imageCanvas');
                const rect = canvas.getBoundingClientRect();
                
                let clientX, clientY;
                if (type === 'touch' && event.touches.length > 0) {
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                console.log('クリック座標:', {x, y, rectWidth: rect.width, rectHeight: rect.height});
                
                // 範囲チェック
                if (x < 0 || y < 0 || x > rect.width || y > rect.height) {
                    console.warn('クリック位置が範囲外です');
                    updateStatus('画像の範囲内をタップしてください', 'warning');
                    return;
                }
                
                // 正規化座標（0-1の範囲）
                const normalizedX = x / rect.width;
                const normalizedY = y / rect.height;
                
                ballPosition = { x: normalizedX, y: normalizedY };
                
                // ボール位置マーカーを描画
                drawBallMarker(x, y);
                updateStatus('✅ ボール位置を設定しました！診断ボタンを押してください', 'success');
                document.getElementById('diagnoseBtn').disabled = false;
                
                console.log('ボール位置設定成功:', ballPosition);
                
            } catch (error) {
                console.error('位置入力エラー:', error);
                updateStatus('位置の設定に失敗しました', 'warning');
            }
        }
        
        function drawBallMarker(x, y) {
            if (!canvasContext) {
                console.error('Canvas context not available');
                return;
            }
            
            try {
                const canvas = canvasContext.canvas;
                
                // キャンバスをクリア
                canvasContext.clearRect(0, 0, canvas.width, canvas.height);
                
                // 背景を半透明に
                canvasContext.fillStyle = 'rgba(0, 0, 0, 0.1)';
                canvasContext.fillRect(0, 0, canvas.width, canvas.height);
                
                // ボールマーカーを描画（大きめに）
                const markerSize = 20;
                
                // 外側の円（白）
                canvasContext.fillStyle = 'rgba(255, 255, 255, 0.9)';
                canvasContext.beginPath();
                canvasContext.arc(x, y, markerSize + 3, 0, 2 * Math.PI);
                canvasContext.fill();
                
                // 内側の円（黄色）
                canvasContext.fillStyle = 'rgba(255, 215, 0, 0.9)';
                canvasContext.beginPath();
                canvasContext.arc(x, y, markerSize, 0, 2 * Math.PI);
                canvasContext.fill();
                
                // 境界線
                canvasContext.strokeStyle = '#FF4500';
                canvasContext.lineWidth = 3;
                canvasContext.stroke();
                
                // 中心点
                canvasContext.fillStyle = '#FF4500';
                canvasContext.beginPath();
                canvasContext.arc(x, y, 3, 0, 2 * Math.PI);
                canvasContext.fill();
                
                // ラベル
                canvasContext.fillStyle = '#000';
                canvasContext.font = 'bold 14px Arial';
                canvasContext.textAlign = 'center';
                canvasContext.fillText('⚪ BALL', x, y - 30);
                
                console.log('ボールマーカー描画完了:', {x, y});
                
            } catch (error) {
                console.error('マーカー描画エラー:', error);
            }
        }
        
        function startDiagnosis() {
            if (!ballPosition) {
                alert('ボール位置を選択してください');
                return;
            }
            
            updateStatus('診断を実行中...', 'info');
            document.getElementById('diagnoseBtn').disabled = true;
            
            // 簡単な診断実行（遅延をシミュレート）
            setTimeout(() => {
                performSimpleDiagnosis();
            }, 1500);
        }
        
        function performSimpleDiagnosis() {
            const clubType = document.getElementById('clubSelect').value;
            const viewType = document.getElementById('viewSelect').value;
            
            // 簡易スコア計算
            const score = calculateBallPositionScore(ballPosition.x, clubType);
            
            displayResults(score, clubType, viewType);
            updateStatus('診断完了！', 'success');
            document.getElementById('diagnoseBtn').disabled = false;
        }
        
        function calculateBallPositionScore(x, clubType) {
            // クラブタイプ別理想位置
            const idealPositions = {
                'driver': 0.35,   // 左寄り
                'iron': 0.5,      // 中央
                'wedge': 0.6      // 右寄り
            };
            
            const ideal = idealPositions[clubType] || 0.5;
            const deviation = Math.abs(x - ideal);
            
            let score;
            if (deviation < 0.05) score = 95;
            else if (deviation < 0.1) score = 85;
            else if (deviation < 0.15) score = 75;
            else if (deviation < 0.2) score = 65;
            else score = 50;
            
            return score;
        }
        
        function displayResults(score, clubType, viewType) {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            let advice = '';
            if (score >= 85) {
                advice = '✅ 優秀です！理想的なボール位置です。';
            } else if (score >= 70) {
                advice = '👍 良好です。少し調整することでさらに向上できます。';
            } else {
                advice = '📝 改善の余地があります。ボール位置を見直してみましょう。';
            }
            
            resultContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #667eea;">総合スコア: ${score}点</h2>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4>📊 ボール位置評価</h4>
                    <p><strong>クラブ:</strong> ${getClubName(clubType)}</p>
                    <p><strong>視点:</strong> ${getViewName(viewType)}</p>
                    <p><strong>スコア:</strong> ${score}点</p>
                </div>
                
                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px;">
                    <h4>💡 アドバイス</h4>
                    <p>${advice}</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">
                        ※ この診断は簡易版です。より詳細な分析については、PC版をご利用ください。
                    </p>
                </div>
            `;
            
            resultSection.style.display = 'block';
        }
        
        function getClubName(clubType) {
            const names = {
                'driver': 'ドライバー',
                'iron': 'アイアン',
                'wedge': 'ウェッジ'
            };
            return names[clubType] || clubType;
        }
        
        function getViewName(viewType) {
            const names = {
                'front': '正面視点',
                'back': '後方視点'
            };
            return names[viewType] || viewType;
        }
        
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }
        
        // デバッグ機能
        function testFileInput() {
            console.log('ファイル入力テスト');
            const mainInput = document.getElementById('imageInput');
            const cameraInput = document.getElementById('cameraInput');
            const galleryInput = document.getElementById('galleryInput');
            
            console.log('メインファイル入力:', mainInput ? 'OK' : 'NG');
            console.log('カメラ入力:', cameraInput ? 'OK' : 'NG');
            console.log('ギャラリー入力:', galleryInput ? 'OK' : 'NG');
            
            updateStatus('ファイル入力要素: ' + 
                (mainInput && cameraInput && galleryInput ? '全て正常' : 'エラーあり'), 'info');
        }
        
        function showDebugInfo() {
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const info = `
                デバイス: ${isMobile ? 'モバイル' : 'PC'}
                UserAgent: ${navigator.userAgent}
                ファイルAPI: ${window.File ? 'サポート' : '非サポート'}
                FileReader: ${window.FileReader ? 'サポート' : '非サポート'}
                Canvas: ${document.createElement('canvas').getContext ? 'サポート' : '非サポート'}
            `;
            
            console.log(info);
            alert(info);
        }
        
        // 初期化
        console.log('モバイル診断ツール初期化完了');
        
        // デバッグ情報
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        console.log('デバイス:', isMobile ? 'モバイル' : 'PC');
        console.log('ユーザーエージェント:', navigator.userAgent);
        console.log('ファイルAPI:', window.File ? 'サポート' : '非サポート');
        
        // 自動デバッグ情報表示
        window.addEventListener('load', function() {
            setTimeout(() => {
                updateStatus('ツール準備完了 - 画像をアップロードしてください', 'info');
            }, 1000);
        });
    </script>
</body>
</html>
