<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ゴルフアドレス診断ツール - 完全版</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J7QD0MNVWG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J7QD0MNVWG');
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .upload-section {
            text-align: center;
            margin: 30px 0;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
        }

        .btn:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4c93);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .controls {
            text-align: center;
            margin: 30px 0;
        }

        .control-group {
            display: inline-block;
            margin: 0 15px;
            vertical-align: middle;
        }

        select {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .analysis-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 95%;
                padding: 10px;
                margin: 0 auto;
            }
            
            .analysis-container {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
                margin: 0;
            }
            
            .container {
                max-width: 100%;
                padding: 2px;
                margin: 0;
                width: 100%;
                box-sizing: border-box;
            }
            
            .main-content {
                padding: 10px;
                margin: 2px;
                border-radius: 10px;
            }
            
            .image-section, .analysis-section {
                padding: 10px;
                margin: 5px 0;
            }
            
            .header {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.6em;
                margin-bottom: 5px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
                margin: 5px;
            }
            
            .control-group {
                margin: 0 5px;
            }
            
            select {
                padding: 8px 10px;
                font-size: 14px;
            }
            
            /* モバイル専用：詳細コメント表示確保（強化版） */
            .feedback-text {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                line-height: 1.8 !important;
                font-size: 15px !important;
                margin-top: 12px !important;
                margin-bottom: 12px !important;
                padding: 10px !important;
                white-space: normal !important;
                word-wrap: break-word !important;
                color: #333 !important;
                background-color: rgba(255, 255, 255, 0.9) !important;
                border-radius: 8px !important;
                border-left: 4px solid #007bff !important;
            }
            
            .feedback-text strong {
                display: inline !important;
                font-weight: bold !important;
                color: #0056b3 !important;
                font-size: 16px !important;
            }
            
            .feedback-text br {
                display: block !important;
                content: "";
                margin: 8px 0 !important;
                height: 8px !important;
            }
            
            /* スコア表示項目の強制表示 */
            .score-item {
                display: block !important;
                margin-bottom: 15px !important;
                padding: 15px !important;
                background: #f8f9fa !important;
                border-radius: 10px !important;
            }
            
            /* モバイル専用：総合スコア表示の強化 */
            .score-item[style*="linear-gradient"] {
                background: linear-gradient(45deg, #9C27B0, #673AB7) !important; /* 美しい紫色 */
                border: 5px solid #FFFFFF !important;
                box-shadow: 0 15px 35px rgba(0,0,0,0.5) !important;
                margin: 20px 0 !important;
                padding: 25px !important;
            }
            
            .score-item[style*="linear-gradient"] h4 {
                color: #FFFFFF !important;
                font-size: 2em !important;
                text-shadow: 3px 3px 6px rgba(0,0,0,0.8) !important;
                margin-bottom: 20px !important;
            }
            
            .score-item[style*="linear-gradient"] .score-display {
                color: #FFFFFF !important;
                font-size: 4em !important;
                font-weight: 900 !important;
                text-shadow: 5px 5px 10px rgba(0,0,0,0.9) !important;
                margin: 30px 0 !important;
            }
            
            .score-item[style*="linear-gradient"] .feedback-text {
                color: #FFFFFF !important;
                font-size: 1.5em !important;
                background: rgba(0,0,0,0.3) !important;
                border: 2px solid #FFFFFF !important;
                padding: 20px !important;
                margin-top: 25px !important;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.8) !important;
            }
            
            /* 写真表示の強制 */
            img[src*="野山けいじ.png"], img[src*="noyama-keiji.png"] {
                display: block !important;
                width: auto !important;
                max-width: 100% !important;
                height: auto !important;
            }
        }

        .image-section, .analysis-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        .image-container {
            position: relative;
            text-align: center;
        }
        
        .image-wrapper {
            position: relative;
            display: inline-block;
            border: 3px solid #007bff;
            border-radius: 10px;
        }
        
        .image-wrapper img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 7px;
        }
        
        #poseCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            border: 0;
            background: transparent; /* モバイルで線が見えない問題対策: 透明に */
            z-index: 9999;           /* 常に前面 */
            pointer-events: auto;    /* フロント視点でのクリック有効 */
            /* モバイル対応：タッチ無効化とcanvas最適化 */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            /* canvas描画最適化 */
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .ball-instruction {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            border: 3px solid #ff4757;
            border-radius: 12px;
            padding: 18px;
            margin: 15px 0;
            font-weight: bold;
            font-size: 1.2em;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 4px 15px rgba(255, 75, 87, 0.3);
            text-align: center;
            animation: pulse-bright 2s infinite;
        }
        
        @keyframes pulse-bright {
            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 75, 87, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 6px 20px rgba(255, 75, 87, 0.5); }
            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 75, 87, 0.3); }
        }

        .radar-container {
            position: relative;
            height: 300px;
        }

        .score-feedback-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .score-item {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .score-item h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .score-display {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .score-90plus { color: #28a745; }
        .score-80plus { color: #ffc107; }
        .score-70plus { color: #fd7e14; }
        .score-below70 { color: #dc3545; }

        .feedback-text {
            color: #666;
            line-height: 1.6;
            margin-top: 10px;
        }

        .current-status {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 3px solid #007bff;
        }

        .ideal-status {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 3px solid #28a745;
        }

        .hidden {
            display: none;
        }

        .social-share {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .social-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="background: rgba(255, 255, 255, 0.15); border-radius: 15px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(10px);">
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                    <a href="https://noyamagolf.com/" target="_blank" style="display: block;">
                        <img src="./noyama-keiji .png" alt="野山佳治プロ" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; object-fit: cover; cursor: pointer; transition: transform 0.2s ease; background-color: #f0f0f0;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    </a>
                    <div style="text-align: center;">
                        <div style="font-size: 1.2em; font-weight: bold; color: #FFD700;">ティーチングプロ</div>
                        <a href="https://noyamagolf.com/" target="_blank" style="text-decoration: none; color: white; transition: color 0.2s ease;" onmouseover="this.style.color='#FFD700'" onmouseout="this.style.color='white'">
                            <div style="font-size: 1.5em; font-weight: bold;">野山佳治 監修</div>
                        </a>
                    </div>
                </div>
            </div>
            <h1>🏌️ ゴルフアドレス診断ツール</h1>
            <p>AI姿勢分析＆レーダーチャート診断</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <button class="btn" onclick="selectImage()">📸 ギャラリーから選択</button>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>📹 撮影視点：</label>
                    <select id="viewSelect" onchange="handleViewChange()">
                        <option value="front">正面撮影（ボール位置設定必要）</option>
                        <option value="rear">後方撮影</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>🏌️ 使用クラブ：</label>
                    <select id="clubSelect">
                        <option value="driver">ドライバー</option>
                        <option value="fairway">フェアウェイウッド</option>
                        <option value="utility">ユーティリティー</option>
                        <option value="iron4">4番アイアン</option>
                        <option value="iron5">5番アイアン</option>
                        <option value="iron6">6番アイアン</option>
                        <option value="iron7">7番アイアン</option>
                        <option value="iron8">8番アイアン</option>
                        <option value="iron9">9番アイアン</option>
                        <option value="wedge">ウェッジ</option>
                    </select>
                </div>
                <button id="diagnosisBtn" class="btn" onclick="startDiagnosis()" disabled>
                    画像をアップロードしてください
                </button>
            </div>
        </div>

        <div id="analysisResults" class="hidden">
            <div class="analysis-container">
                <div class="image-section">
                    <h3>📊 姿勢分析結果</h3>
                    <div class="image-container">
                        <div class="image-wrapper">
                            <img id="uploadedImage" alt="アップロード画像">
                            <canvas id="poseCanvas"></canvas>
                        </div>
                        <div class="ball-instruction" id="ballInstruction" style="display: none;">
                            🏌️‍♂️ 画像上でボールの位置をタップ（またはクリック）してください
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>📈 レーダーチャート</h3>
                    <div class="radar-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="score-feedback-grid" id="scoreFeedbackGrid">
                <!-- 詳細スコアとコメント表示 -->
            </div>

            <div class="social-share">
                <h3>📤 結果をシェア</h3>
                <div class="social-buttons">
                    <button onclick="shareToTwitter()" style="background: #1DA1F2; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer;">
                        🐦 Twitter
                    </button>
                    <button onclick="shareToFacebook()" style="background: #4267B2; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer;">
                        📘 Facebook
                    </button>
                    <button onclick="shareToInstagram()" style="background: #E4405F; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer;">
                        📷 Instagram
                    </button>
                </div>
            </div>
        </div>

        <!-- 野山佳治レッスン案内 -->
        <div style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 40px; margin-top: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #667eea; font-size: 2.5em; margin-bottom: 15px;">🏌️ レッスンのご案内</h2>
                <div style="display: flex; align-items: center; justify-content: center; gap: 30px; flex-wrap: wrap;">
                    <a href="https://noyamagolf.com/" target="_blank" style="display: block;">
                        <img src="./noyama-keiji .png" alt="野山佳治プロ" style="width: 150px; height: 150px; border-radius: 50%; border: 5px solid #667eea; object-fit: cover; box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.2s ease; background-color: #f0f0f0;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    </a>
                    <div style="text-align: left; max-width: 500px;">
                        <a href="https://noyamagolf.com/" target="_blank" style="text-decoration: none; color: #333; transition: color 0.2s ease;" onmouseover="this.style.color='#667eea'" onmouseout="this.style.color='#333'">
                            <h3 style="color: inherit; font-size: 1.8em; margin-bottom: 10px;">野山佳治ティーチングプロ</h3>
                        </a>
                        <div style="color: #666; font-size: 1.1em; line-height: 1.6;">
                            <p>🏆 PGA公認ティーチングプロ</p>
                            <p>📚 ゴルフ指導歴20年以上</p>
                            <p>🎯 初心者から上級者まで対応</p>
                            <p>💪 スコアUPのコツをお伝えします</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 30px;">
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; border-left: 4px solid #667eea;">
                    <h4 style="color: #333; font-size: 1.4em; margin-bottom: 15px;">🏌️ ラウンドレッスン</h4>
                    <div style="color: #666; line-height: 1.6; margin-bottom: 20px;">
                        <p>実戦形式でのレッスン</p>
                        <p>コースマネジメントを学べる</p>
                        <p>本格的なゴルフ技術向上</p>
                    </div>
                    <a href="https://noyamagolf.com/?p=47" target="_blank" style="display: inline-block; background: #667eea; color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: bold;">詳細・お申込み</a>
                </div>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; border-left: 4px solid #28a745;">
                    <h4 style="color: #333; font-size: 1.4em; margin-bottom: 15px;">💻 オンラインレッスン</h4>
                    <div style="color: #666; line-height: 1.6; margin-bottom: 20px;">
                        <p>自宅から受けられるレッスン</p>
                        <p>スイング動画分析</p>
                        <p>個別アドバイス</p>
                    </div>
                    <a href="https://noyamagolf.com/?p=49" target="_blank" style="display: inline-block; background: #28a745; color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: bold;">詳細・お申込み</a>
                </div>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; border-left: 4px solid #fd7e14;">
                    <h4 style="color: #333; font-size: 1.4em; margin-bottom: 15px;">👨‍🏫 マンツーマンレッスン</h4>
                    <div style="color: #666; line-height: 1.6; margin-bottom: 20px;">
                        <p>完全個別指導</p>
                        <p>短期集中でスキルアップ</p>
                        <p>あなたに合わせたカリキュラム</p>
                    </div>
                    <a href="https://noyamagolf.com/?p=45" target="_blank" style="display: inline-block; background: #fd7e14; color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: bold;">詳細・お申込み</a>
                </div>
            </div>
            
            <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                <p style="color: #666; font-size: 1.1em; margin: 0;">
                    詳しくはホームページをご覧ください：
                    <a href="https://noyamagolf.com/" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">https://noyamagolf.com/</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let pose;
        let uploadedImage = null;
        let ballPosition = null;
        let currentResults = null;
        let diagnosisCompleted = false;
        let mediaPipeReady = false;
        let detailedAnalysisData = {}; // 詳細な分析データを保存

        // 互換: resetTransform ポリフィル（iOS Safari 等）
        function resetTransformSafe(ctx){
            if (ctx && typeof ctx.resetTransform === 'function') {
                try { ctx.resetTransform(); return; } catch(_) {}
            }
            if (ctx && typeof ctx.setTransform === 'function') {
                ctx.setTransform(1,0,0,1,0,0);
            }
        }

        // 画像選択機能
        function selectImage() {
            console.log('画像選択開始...');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = function(e) {
                console.log('ファイル選択:', e.target.files.length);
                if (e.target.files.length > 0) {
                    handleImageUpload(e.target.files[0]);
                }
            };
            
            input.click();
        }

        // 画像アップロード処理
        function handleImageUpload(file) {
            console.log('画像処理開始:', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('uploadedImage');
                img.src = e.target.result;
                
                img.onload = function() {
                    uploadedImage = img;
                    ballPosition = null;
                    currentResults = null;
                    console.log('✅ 画像読み込み完了');
                    
                    // 結果セクションを表示
                    document.getElementById('analysisResults').classList.remove('hidden');
                    
            // キャンバス設定
            setupCanvas();
                    
                    // MediaPipe処理を実行（すべての撮影視点で）
                    if (mediaPipeReady && pose) {
                        setTimeout(() => {
                            const viewType = document.getElementById('viewSelect').value;
                            console.log(`MediaPipe姿勢分析開始... 視点: ${viewType}`);
                            pose.send({image: img}).then(() => {
                                console.log(`MediaPipe処理完了 - 視点: ${viewType}`);
                            }).catch(error => {
                                console.error('MediaPipe処理エラー:', error);
                            });
                        }, 200);
                    } else {
                        console.warn('MediaPipe未準備 - スキップ');
                    }
                    
                    updateDiagnosisButton();
                };
            };
            reader.readAsDataURL(file);
        }

        // キャンバス設定
        function setupCanvas() {
            console.log('=== キャンバス設定開始 ===');
            
            const img = document.getElementById('uploadedImage');
            const canvas = document.getElementById('poseCanvas');
            
            if (!img || !canvas) {
                console.error('要素が見つかりません');
                return;
            }
            
            // キャンバスサイズを画像の表示サイズに合わせる（モバイル安定化）
            const setCanvasSize = () => {
                // モバイル安定化: CSSピクセル基準で描画（DPRスケール適用なし）
                const displayW = img.clientWidth;
                const displayH = img.clientHeight;
                if (!displayW || !displayH) return;
                canvas.style.width = displayW + 'px';
                canvas.style.height = displayH + 'px';
                canvas.width = Math.round(displayW);
                canvas.height = Math.round(displayH);
                const ctx = canvas.getContext('2d');
                if (ctx) {
                    if (typeof ctx.resetTransform === 'function') { try { ctx.resetTransform(); } catch(_) {} }
                    else if (typeof ctx.setTransform === 'function') { ctx.setTransform(1,0,0,1,0,0); }
                }
                // リサイズ後に直近の結果を描画（診断直後に消えるのを防止）
                try { redrawOverlay(); } catch(_) {}
            };
            setCanvasSize();
            window.addEventListener('resize', setCanvasSize, { passive: true });
            
            console.log('キャンバスサイズ設定完了');
            
            const viewType = document.getElementById('viewSelect').value;
            if (viewType === 'front') {
                // ボール位置クリック/タッチ/ポインタを有効化（スマホ対応）
                canvas.addEventListener('click', handleCanvasClick);
                canvas.addEventListener('pointerdown', (e) => {
                    // マウス/タッチ/ペンを統一処理
                    const fakeEvent = { clientX: e.clientX, clientY: e.clientY, preventDefault: ()=>{}, stopPropagation: ()=>{} };
                    handleCanvasClick(fakeEvent);
                    e.preventDefault();
                }, { passive: false });
                canvas.addEventListener('touchstart', (e) => {
                    // タッチをクリックに変換
                    if (e.touches && e.touches.length > 0) {
                        const touch = e.touches[0];
                        const fakeEvent = { clientX: touch.clientX, clientY: touch.clientY, preventDefault: ()=>{}, stopPropagation: ()=>{} };
                        handleCanvasClick(fakeEvent);
                    }
                    e.preventDefault();
                }, { passive: false });
                document.getElementById('ballInstruction').style.display = 'block';
                console.log('✅ ボール位置クリック有効化');
            } else {
                // ボール位置クリックを無効化（既存のクリックのみ解除）
                canvas.removeEventListener('click', handleCanvasClick);
                document.getElementById('ballInstruction').style.display = 'none';
                console.log('後方撮影 - ボール位置不要');
            }
        }

        // キャンバスクリック処理（大きなクリック領域対応）
        function handleCanvasClick(event) {
            console.log('🎯 キャンバスクリック検出!');
            
            if (event && typeof event.preventDefault === 'function') event.preventDefault();
            if (event && typeof event.stopPropagation === 'function') event.stopPropagation();
            
            const canvas = document.getElementById('poseCanvas');
            const rect = canvas.getBoundingClientRect();
            // 座標の取りこぼし防止（pointer/touch互換）
            const cx = (event.clientX ?? event.pageX ?? (event.touches && event.touches[0]?.clientX));
            const cy = (event.clientY ?? event.pageY ?? (event.touches && event.touches[0]?.clientY));
            const x = cx - rect.left;
            const y = cy - rect.top;
            
            console.log('クリック座標:', Math.round(x), Math.round(y));
            
            // デバイス対応：ボールクリック領域調整
            const isMobileClick = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            const clickRadius = isMobileClick ? 120 : 80; // スマホ120px、PC80px
            let ballDetected = false;
            
            // 既存のボール位置があれば、その近くをクリックしたかチェック
            if (ballPosition) {
                const ballX = ballPosition.x * canvas.clientWidth;
                const ballY = ballPosition.y * canvas.clientHeight;
                const distance = Math.sqrt(Math.pow(x - ballX, 2) + Math.pow(y - ballY, 2));
                
                if (distance <= clickRadius) {
                    console.log('既存ボール位置の近くをクリック (距離:', Math.round(distance), 'px)');
                    ballDetected = true;
                }
            }
            
            // ボールが検出されるか、ボール位置が未設定の場合は新しい位置を設定
            if (ballDetected || !ballPosition) {
                // 正規化座標に変換
                ballPosition = {
                    x: x / canvas.clientWidth,
                    y: y / canvas.clientHeight
                };
                
                console.log('ボール位置設定:', Math.round(ballPosition.x * 100) + '%, ' + Math.round(ballPosition.y * 100) + '%');
            } else {
                console.log('ボールから遠い位置をクリック - 無視');
                return;
            }
            
            // MediaPipeの結果があれば再描画してから赤い丸を描画
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            // すべてデバイスピクセル座標で描画するため、変換をリセット
            resetTransformSafe(ctx);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // MediaPipeの姿勢ランドマークを再描画
            if (currentResults && currentResults.poseLandmarks) {
                try {
                    // 完全書き直し：モバイル対応MediaPipe描画
                    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
                    console.log('🔍 MediaPipe描画開始 - モバイル:', isMobile, 'ウィンドウ幅:', window.innerWidth);
                    console.log('🔍 Canvas詳細:', {
                        width: canvas.width,
                        height: canvas.height,
                        clientWidth: canvas.clientWidth, 
                        clientHeight: canvas.clientHeight,
                        landmarks: currentResults.poseLandmarks.length
                    });
                    
                    // canvasの状態を完全リセット（iOS対応）
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    resetTransformSafe(ctx);
                    
                    // スマホ用：必ず描画される確実な方法
                    if (isMobile) {
                        console.log('📱 スマホ専用描画開始');
                        
                        // 基本設定
                        ctx.strokeStyle = '#00FFFF';
                        ctx.lineWidth = 3; // 初期から細く
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        ctx.fillStyle = '#FF0000';
                        
                        // 体の主要な線を強制描画（MediaPipeに依存しない）
                        const landmarks = currentResults.poseLandmarks;
                        
                        // 肩の線（11-12）
                        if (landmarks[11] && landmarks[12]) {
                            const x1 = landmarks[11].x * canvas.width;
                            const y1 = landmarks[11].y * canvas.height;
                            const x2 = landmarks[12].x * canvas.width;
                            const y2 = landmarks[12].y * canvas.height;
                            
                            ctx.beginPath();
                            ctx.moveTo(x1, y1);
                            ctx.lineTo(x2, y2);
                            ctx.stroke();
                            
                            // 肩の点も描画
                            ctx.beginPath();
                            ctx.arc(x1, y1, (window.innerWidth < 768) ? 1 : 4, 0, 2 * Math.PI);
                            ctx.fill();
                            ctx.beginPath();
                            ctx.arc(x2, y2, (window.innerWidth < 768) ? 1 : 4, 0, 2 * Math.PI);
                            ctx.fill();
                        }
                        
                        // 腰の線（23-24）
                        if (landmarks[23] && landmarks[24]) {
                            const x1 = landmarks[23].x * canvas.width;
                            const y1 = landmarks[23].y * canvas.height;
                            const x2 = landmarks[24].x * canvas.width;
                            const y2 = landmarks[24].y * canvas.height;
                            
                            ctx.beginPath();
                            ctx.moveTo(x1, y1);
                            ctx.lineTo(x2, y2);
                            ctx.stroke();
                            
                            // 腰の点も描画
                            ctx.beginPath();
                            ctx.arc(x1, y1, (window.innerWidth < 768) ? 1 : 4, 0, 2 * Math.PI);
                            ctx.fill();
                            ctx.beginPath();
                            ctx.arc(x2, y2, (window.innerWidth < 768) ? 1 : 4, 0, 2 * Math.PI);
                            ctx.fill();
                        }
                        
                        // 体の中心線（肩から腰）
                        if (landmarks[11] && landmarks[23]) {
                            ctx.beginPath();
                            ctx.moveTo(landmarks[11].x * canvas.width, landmarks[11].y * canvas.height);
                            ctx.lineTo(landmarks[23].x * canvas.width, landmarks[23].y * canvas.height);
                            ctx.stroke();
                        }
                        
                        if (landmarks[12] && landmarks[24]) {
                            ctx.beginPath();
                            ctx.moveTo(landmarks[12].x * canvas.width, landmarks[12].y * canvas.height);
                            ctx.lineTo(landmarks[24].x * canvas.width, landmarks[24].y * canvas.height);
                            ctx.stroke();
                        }

                        // 頭部：肩の中点→鼻、耳〜耳、目〜目 のラインを描画
                        if (landmarks[11] && landmarks[12] && landmarks[0]) {
                            const sx = (landmarks[11].x + landmarks[12].x) / 2 * canvas.width;
                            const sy = (landmarks[11].y + landmarks[12].y) / 2 * canvas.height;
                            const nx = landmarks[0].x * canvas.width;
                            const ny = landmarks[0].y * canvas.height;
                            ctx.beginPath();
                            ctx.moveTo(sx, sy);
                            ctx.lineTo(nx, ny);
                            ctx.stroke();
                        }
                        if (landmarks[7] && landmarks[8]) { // 耳
                            ctx.beginPath();
                            ctx.moveTo(landmarks[7].x * canvas.width, landmarks[7].y * canvas.height);
                            ctx.lineTo(landmarks[8].x * canvas.width, landmarks[8].y * canvas.height);
                            ctx.stroke();
                        }
                        if (landmarks[2] && landmarks[5]) { // 目（左目中央〜右目中央）
                            ctx.beginPath();
                            ctx.moveTo(landmarks[2].x * canvas.width, landmarks[2].y * canvas.height);
                            ctx.lineTo(landmarks[5].x * canvas.width, landmarks[5].y * canvas.height);
                            ctx.stroke();
                        }
                        
                        console.log('📱 スマホ専用描画完了 - 強制MediaPipe線描画');
                    }
                    
                    // モバイルでは確実に見える太い線で描画
                    ctx.save(); // 設定を保存
                    
                    // 超強力モバイル線設定（絶対に見える）
                    if (isMobile || window.innerWidth < 768) {
                        // スマホ・タブレット用：明るい線（細め）
                        ctx.strokeStyle = '#00FFFF'; // シアン色（最も目立つ）
                        ctx.lineWidth = 1; // スマホは1pxに
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 0;
                    } else {
                        // PC用：さらに太めの線
                        ctx.strokeStyle = '#00FF00';
                        ctx.lineWidth = 3;
                    }
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.globalAlpha = 1.0;
                    
                    // 重要な骨格線を手動で描画（確実に表示）
                    const keyConnections = [
                        // 上半身の主要線
                        [11, 12], // 左右肩
                        [11, 13], [13, 15], // 左腕
                        [12, 14], [14, 16], // 右腕
                        [11, 23], [12, 24], // 肩から腰
                        [23, 24], // 腰の横線
                        // 下半身の主要線
                        [23, 25], [25, 27], // 左脚
                        [24, 26], [26, 28]  // 右脚
                    ];
                    
                    const isAndroid = /Android/i.test(navigator.userAgent);
                    const visThreshold = ((isAndroid || isMobile || window.innerWidth < 768) && document.getElementById('viewSelect').value === 'front') ? 0.2 : 0.5;
                    let linesDrawn = 0;
                    keyConnections.forEach(([startIdx, endIdx]) => {
                        const startPoint = currentResults.poseLandmarks[startIdx];
                        const endPoint = currentResults.poseLandmarks[endIdx];
                        
                        if (startPoint && endPoint &&
                            (startPoint.visibility === undefined || startPoint.visibility >= visThreshold) &&
                            (endPoint.visibility === undefined || endPoint.visibility >= visThreshold)) {
                            const startX = startPoint.x * canvas.width;
                            const startY = startPoint.y * canvas.height;
                            const endX = endPoint.x * canvas.width;
                            const endY = endPoint.y * canvas.height;
                            
                            ctx.beginPath();
                            ctx.moveTo(startX, startY);
                            ctx.lineTo(endX, endY);
                            ctx.stroke();
                            linesDrawn++;
                        }
                    });
                    
                    // 重要なポイントを巨大で目立つ円で描画
                    if (isMobile || window.innerWidth < 768) {
                        ctx.fillStyle = '#FF00FF'; // マゼンタ色（最も目立つ）
                        ctx.shadowColor = '#FFFF00'; // 黄色い影
                        ctx.shadowBlur = 30;
                    } else {
                        ctx.fillStyle = '#FF0000';
                        ctx.shadowColor = 'transparent'; // PC用：影なし
                        ctx.shadowBlur = 0;
                    }
                    const keyPoints = [11, 12, 13, 14, 15, 16, 23, 24, 25, 26, 27, 28];
                    let pointsDrawn = 0;
                    
                    keyPoints.forEach(index => {
                        const point = currentResults.poseLandmarks[index];
                        if (point && (point.visibility === undefined || point.visibility >= visThreshold)) {
                            const x = point.x * canvas.width;
                            const y = point.y * canvas.height;
                            
                            ctx.beginPath();
                            const radius = (isMobile || window.innerWidth < 768) ? 1 : 4; // スマホ1px、PC4px
                            ctx.arc(x, y, radius, 0, 2 * Math.PI);
                            ctx.fill();
                            pointsDrawn++;
                        }
                    });

                    // Android/モバイル正面でラインが無ければ可視性無視で強制描画
                    if (linesDrawn === 0 && document.getElementById('viewSelect').value === 'front' && (isAndroid || isMobile || window.innerWidth < 768)) {
                        console.log('📱 正面フォールバック: 可視性を無視して主要ラインを強制描画');
                        ctx.save();
                        ctx.strokeStyle = '#00FFFF';
                        ctx.lineWidth = 3;
                        keyConnections.forEach(([a,b]) => {
                            const A = currentResults.poseLandmarks[a];
                            const B = currentResults.poseLandmarks[b];
                            if (A && B) {
                                ctx.beginPath();
                                ctx.moveTo(A.x * canvas.width, A.y * canvas.height);
                                ctx.lineTo(B.x * canvas.width, B.y * canvas.height);
                                ctx.stroke();
                                linesDrawn++;
                            }
                        });
                        ctx.restore();
                    }
                    
                    ctx.restore(); // 設定を復元
                    
                    console.log('✅ MediaPipe描画完了 - 描画線数:', linesDrawn, '描画点数:', pointsDrawn, 'モバイル:', isMobile);
                    
                    // スマホ用：さらに確実な補助線描画
                    if (isMobile || window.innerWidth < 768) {
                        console.log('📱 スマホ用補助線描画開始');
                        ctx.strokeStyle = '#FFFF00'; // 黄色（補助線）
                        ctx.lineWidth = 2; // 細い補助線
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        
                        // 重要な体の軸を強調描画
                        if (currentResults.poseLandmarks[11] && currentResults.poseLandmarks[23]) {
                            // 左肩から左腰への線
                            ctx.beginPath();
                            ctx.moveTo(currentResults.poseLandmarks[11].x * canvas.width, currentResults.poseLandmarks[11].y * canvas.height);
                            ctx.lineTo(currentResults.poseLandmarks[23].x * canvas.width, currentResults.poseLandmarks[23].y * canvas.height);
                            ctx.stroke();
                        }
                        
                        if (currentResults.poseLandmarks[12] && currentResults.poseLandmarks[24]) {
                            // 右肩から右腰への線
                            ctx.beginPath();
                            ctx.moveTo(currentResults.poseLandmarks[12].x * canvas.width, currentResults.poseLandmarks[12].y * canvas.height);
                            ctx.lineTo(currentResults.poseLandmarks[24].x * canvas.width, currentResults.poseLandmarks[24].y * canvas.height);
                            ctx.stroke();
                        }
                        
                        console.log('📱 スマホ用補助線描画完了');
                    }
                    
                    // モバイルで線が見えない場合の緊急措置（強化版）
                    if ((isMobile || isAndroid) && linesDrawn === 0) {
                        console.log('⚠️ 緊急措置: 強制線描画実行');
                        ctx.strokeStyle = '#FF0000'; // 赤色で強制描画
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        
                        // 大きな赤いX印を描画
                        ctx.beginPath();
                        ctx.moveTo(50, 50);
                        ctx.lineTo(canvas.width - 50, canvas.height - 50);
                        ctx.moveTo(canvas.width - 50, 50);
                        ctx.lineTo(50, canvas.height - 50);
                        ctx.stroke();
                        
                        // 中央に大きな円も描画
                        ctx.fillStyle = '#FF0000';
                        ctx.beginPath();
                        ctx.arc(canvas.width/2, canvas.height/2, 4, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        console.log('🔴 緊急赤線・円描画完了');
                    }
                    
                    // モバイルの場合、常に追加の目印を描画
                    if (isMobile) {
                        ctx.fillStyle = '#00FFFF'; // シアン色
                        ctx.fillRect(10, 10, 50, 30); // 左上に四角
                        ctx.fillRect(canvas.width - 60, 10, 50, 30); // 右上に四角
                        console.log('🔵 モバイル目印描画完了');
                    }
                } catch (error) {
                    console.error('MediaPipe再描画エラー:', error);
                }
            }
            
            // ボール位置の赤い丸を描画（デバイス対応サイズ）
            const isMobileBall = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            const ballRadius = isMobileBall ? 8 : 10; // スマホ8px、PC10px（少し大きく）

            // CSS座標 -> デバイスピクセル座標へ変換して描画
            const scaleX = canvas.width / canvas.clientWidth;
            const scaleY = canvas.height / canvas.clientHeight;
            const actualX = x * scaleX;
            const actualY = y * scaleY;
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(actualX, actualY, ballRadius, 0, 2 * Math.PI);
            ctx.fill();
            // 安定のため、次フレームでも重ね描き
            setTimeout(() => { try { redrawOverlay(); } catch(_) {} }, 0);
            
            // 指示を非表示
            document.getElementById('ballInstruction').style.display = 'none';
            
            console.log('✅ ボール位置設定完了');
            updateDiagnosisButton();
        }

        // 撮影視点変更処理
        function handleViewChange() {
            const viewType = document.getElementById('viewSelect').value;
            console.log('撮影視点変更:', viewType);
            if (uploadedImage) {
                ballPosition = null; // リセット
                setupCanvas();
                
                // 後方撮影の場合、MediaPipe処理を再実行
                if (viewType === 'rear' && mediaPipeReady && pose) {
                    setTimeout(() => {
                        console.log('後方撮影：MediaPipe処理を再実行');
                        pose.send({image: uploadedImage}).then(() => {
                            console.log('後方撮影：MediaPipe処理完了');
                        }).catch(error => {
                            console.error('後方撮影：MediaPipe処理エラー:', error);
                        });
                    }, 300);
                }
                
                updateDiagnosisButton();
            }
        }

        // 診断ボタンの状態更新
        function updateDiagnosisButton() {
            const btn = document.getElementById('diagnosisBtn');
            const viewType = document.getElementById('viewSelect').value;
            
            console.log('診断ボタン更新:', {
                image: !!uploadedImage,
                viewType: viewType,
                ballPosition: !!ballPosition
            });
            
            if (!uploadedImage) {
                btn.disabled = true;
                btn.textContent = '画像をアップロードしてください';
            } else if (viewType === 'front' && !ballPosition) {
                btn.disabled = true;
                btn.textContent = 'ボール位置をタップしてください';
            } else {
                btn.disabled = false;
                btn.textContent = '🔍 診断開始';
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                console.log('✅ 診断ボタン有効化');
            }
        }

        // 診断開始
        function startDiagnosis() {
            console.log('診断開始...');
            const btn = document.getElementById('diagnosisBtn');
            btn.textContent = '診断中...';
            btn.disabled = true;
            
            setTimeout(() => {
                performDiagnosis();
            }, 1000);
        }

        // 診断実行
function performDiagnosis() {
            console.log('診断実行中...');
            
            const viewType = document.getElementById('viewSelect').value;
            let scores;
            
            if (mediaPipeReady && currentResults && currentResults.poseLandmarks) {
                console.log('MediaPipe結果を使用して詳細分析実行');
                scores = performMediaPipeAnalysis(currentResults.poseLandmarks, viewType);
            } else {
                console.log('フォールバック分析実行');
                scores = performFallbackAnalysis(viewType);
            }
            
            console.log('診断完了:', scores);
            
    // 結果表示
    displayDetailedResults(scores);
    createRadarChart(scores);

    // オーバーレイを再描画（診断後も頭部点・線が残るように）
    try {
      const canvas = document.getElementById('poseCanvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      if (currentResults && currentResults.poseLandmarks && canvas) {
        // クリアしてから現在のポーズを手動描画（色を診断前と統一）
        ctx.clearRect(0,0,canvas.width, canvas.height);
        const lm = currentResults.poseLandmarks;
        ctx.strokeStyle = '#00FF00';
        ctx.lineWidth = (window.innerWidth < 768) ? 1 : 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        const drawLine = (a,b)=>{ if(lm[a]&&lm[b]){ ctx.beginPath(); ctx.moveTo(lm[a].x*canvas.width, lm[a].y*canvas.height); ctx.lineTo(lm[b].x*canvas.width, lm[b].y*canvas.height); ctx.stroke(); } };
        // 主要ライン
        [[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]].forEach(p=>drawLine(p[0],p[1]));
        // 肩中点→腰中点
        if(lm[11]&&lm[12]&&lm[23]&&lm[24]){
          const sx=(lm[11].x+lm[12].x)/2*canvas.width, sy=(lm[11].y+lm[12].y)/2*canvas.height;
          const hx=(lm[23].x+lm[24].x)/2*canvas.width, hy=(lm[23].y+lm[24].y)/2*canvas.height;
          ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(hx,hy); ctx.stroke();
          if(lm[0]){ ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(lm[0].x*canvas.width, lm[0].y*canvas.height); ctx.stroke(); }
        }
        // 点（頭部含む）
        ctx.fillStyle = '#FF0000';
        const drawPt = (i,r=4)=>{ if(lm[i]){ ctx.beginPath(); ctx.arc(lm[i].x*canvas.width, lm[i].y*canvas.height, r, 0, 2*Math.PI); ctx.fill(); } };
        [0,1,2,3,4,5,7,8,9,10,11,12,13,14,15,16,23,24,25,26,27,28].forEach(i=>drawPt(i,4));

        // ボール丸も重ねて維持
        const viewType2 = document.getElementById('viewSelect').value;
        if (ballPosition && viewType2 === 'front'){
          ctx.fillStyle='red';
          const r = (window.innerWidth<768)?4:10;
          ctx.beginPath(); ctx.arc(ballPosition.x*canvas.width, ballPosition.y*canvas.height, r, 0, 2*Math.PI); ctx.fill();
        }
      }
    } catch(e) { console.warn('post-diagnosis overlay draw failed', e); }
            
    // ボタンを元に戻す
            const btn = document.getElementById('diagnosisBtn');
            btn.textContent = '🔍 診断開始';
            btn.disabled = false;
            btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
        }

        // MediaPipe分析
        function performMediaPipeAnalysis(landmarks, viewType) {
            console.log('MediaPipe分析開始 - ランドマーク数:', landmarks.length);
            
            let scores;
            
            if (viewType === 'front') {
                scores = {
                    ballPosition: ballPosition ? analyzeBallPositionWithPose(landmarks) : 85,
                    stance: analyzeStanceWidth(landmarks),
                    headPosition: analyzeHeadPosition(landmarks),
                    handPosition: analyzeHandPosition(landmarks),
                    weight: analyzeWeightDistribution(landmarks)
                };
            } else { // rear
                scores = {
                    forwardLean: analyzeForwardLeanFromLandmarks(landmarks),
                    handBodyDistance: analyzeHandBodyDistance(landmarks),
                    frontBackBalance: analyzeFrontBackBalance(landmarks),
                    bodyDirection: analyzeBodyDirection(landmarks),
                    backCurvature: analyzeBackCurvature(landmarks)
                };
            }
            
            return scores;
        }

        // フォールバック分析（スマホでも具体コメントが出るよう詳細データも生成）
        function performFallbackAnalysis(viewType) {
            console.log('フォールバック分析実行');
            const rnd = () => Math.floor(Math.random() * 25) + 75;
            let scores;

            if (viewType === 'front') {
                scores = {
                    ballPosition: ballPosition ? calculateBallPositionScore() : 85,
                    stance: rnd(),
                    headPosition: rnd(),
                    handPosition: rnd(),
                    weight: rnd()
                };

                // 具体的な現状を作るための簡易詳細データ（画像中心基準）
                const centerX = 0.5;
                if (ballPosition) {
                    const diff = (ballPosition.x - centerX);
                    detailedAnalysisData.ballPosition = {
                        currentPosition: ballPosition.x,
                        idealPosition: centerX,
                        difference: diff,
                        isLeftTooMuch: diff > 0.03,
                        isRightTooMuch: diff < -0.03
                    };
                }
                // スタンス幅（仮想）: スコアで方向性を決定
                const idealRatio = 1.2;
                const tooWide = scores.stance < 80; // 低スコアなら広すぎると仮定
                const ratio = idealRatio + (tooWide ? 0.2 : -0.1);
                detailedAnalysisData.stance = {
                    currentRatio: ratio,
                    idealRatio: idealRatio,
                    difference: ratio - idealRatio,
                    isTooWide: tooWide,
                    isTooNarrow: !tooWide
                };
                // 頭の位置（画像中心基準で方向を決定）
                if (ballPosition) {
                    const headDiff = (ballPosition.x - centerX); // 代用
                    detailedAnalysisData.headPosition = {
                        difference: headDiff,
                        isLeftTooMuch: headDiff > 0.03,
                        isRightTooMuch: headDiff < -0.03
                    };
                }
                // 手の位置（画像中心基準で方向を決定）
                if (ballPosition) {
                    const handDiff = (ballPosition.x - centerX) * 0.8;
                    detailedAnalysisData.handPosition = {
                        difference: handDiff,
                        isLeftTooMuch: handDiff > 0.03,
                        isRightTooMuch: handDiff < -0.03
                    };
                }
                // 体重配分（左右の方向性だけ決める）
                const wDiff = (ballPosition ? (ballPosition.x - centerX) : 0);
                detailedAnalysisData.weight = {
                    difference: wDiff,
                    isLeftHeavy: wDiff > 0.03,
                    isRightHeavy: wDiff < -0.03
                };
            } else { // rear
                scores = {
                    forwardLean: rnd(),
                    handBodyDistance: rnd(),
                    frontBackBalance: rnd(),
                    bodyDirection: rnd(),
                    backCurvature: rnd()
                };

                // 後方用の簡易詳細データ（クラブ理想値に対して過不足を作る）
                const club = document.getElementById('clubSelect')?.value || 'iron7';
                // 理想角度（垂直から体まで）: ドライバー30° → ウェッジ45°
                const idealAngles = { driver: 30, fairway: 33, utility: 35, iron7: 40, iron9: 42, wedge: 45 };
                const idealAngle = idealAngles[club] || 40;
                const currentAngle = idealAngle + (scores.forwardLean < 85 ? 6 : -4);
                detailedAnalysisData.forwardLean = {
                    currentAngle,
                    idealAngle,
                    isTooShallow: currentAngle < idealAngle,
                    isTooDeep: currentAngle > idealAngle
                };
                const idealDistance = 0.9;
                const relDist = idealDistance + (scores.handBodyDistance < 85 ? 0.08 : -0.05);
                detailedAnalysisData.handBodyDistance = {
                    currentDistance: relDist,
                    idealDistance,
                    isTooFar: relDist > idealDistance + 0.02,
                    isTooClose: relDist < idealDistance - 0.02,
                    distanceDiff: relDist - idealDistance
                };
                const balance = (scores.frontBackBalance < 85 ? 0.05 : -0.04);
                detailedAnalysisData.frontBackBalance = {
                    currentBalance: balance,
                    idealBalance: 0,
                    isTooForward: balance > 0.02,
                    isTooBackward: balance < -0.02,
                    difference: balance
                };
                // bodyDirection/backCurvature は汎用コメントでカバー
            }

            return scores;
        }

        // MediaPipe分析関数群
        function analyzeBallPositionWithPose(landmarks) {
            try {
                const leftAnkle = landmarks[28];  // 左足首（プレーヤー視点）
                const rightAnkle = landmarks[27]; // 右足首（プレーヤー視点）
                const stanceCenter = (leftAnkle.x + rightAnkle.x) / 2;
                
                const selectedClub = document.getElementById('clubSelect').value;
                const idealPosition = getIdealBallPosition(selectedClub);
                const idealX = stanceCenter + (idealPosition - 0.5) * 0.3; // 調整係数
                
                const ballDiff = ballPosition.x - idealX;
                
                // 詳細データを保存
                detailedAnalysisData.ballPosition = {
                    currentPosition: ballPosition.x,
                    idealPosition: idealX,
                    difference: ballDiff,
                    club: selectedClub,
                    idealPercentage: idealPosition * 100, // 理想値を%で表示
                    currentPercentage: (ballPosition.x - leftAnkle.x) / (rightAnkle.x - leftAnkle.x) * 100, // 実際の位置を%で
                    isLeftTooMuch: ballDiff > 0,  // プレーヤー視点で左に寄りすぎ
                    isRightTooMuch: ballDiff < 0  // プレーヤー視点で右に寄りすぎ
                };
                
                console.log('MediaPipeボール位置分析:', {
                    ballX: Math.round(ballPosition.x * 100) + '%',
                    stanceCenter: Math.round(stanceCenter * 100) + '%',
                    idealX: Math.round(idealX * 100) + '%',
                    diff: Math.round(ballDiff * 100) + '%'
                });
                
                if (Math.abs(ballDiff) < 0.03) return 92;
                if (Math.abs(ballDiff) < 0.06) return 85;
                if (Math.abs(ballDiff) < 0.1) return 75;
                return 68;
                
            } catch (error) {
                console.error('MediaPipeボール位置分析エラー:', error);
                return calculateBallPositionScore();
            }
        }

        function analyzeStanceWidth(landmarks) {
            try {
                const leftAnkle = landmarks[28];  // プレーヤーの左足首
                const rightAnkle = landmarks[27]; // プレーヤーの右足首
                const leftShoulder = landmarks[12];  // プレーヤーの左肩
                const rightShoulder = landmarks[11]; // プレーヤーの右肩
                
                const stanceWidth = Math.abs(rightAnkle.x - leftAnkle.x);
                const shoulderWidth = Math.abs(rightShoulder.x - leftShoulder.x);
                const ratio = stanceWidth / shoulderWidth;
                
                const selectedClub = document.getElementById('clubSelect').value;
                const idealRatio = getIdealStanceRatio(selectedClub);
                const ratioDiff = Math.abs(ratio - idealRatio);
                
                // 詳細データを保存
                detailedAnalysisData.stance = {
                    currentRatio: ratio,
                    idealRatio: idealRatio,
                    difference: ratio - idealRatio,
                    club: selectedClub,
                    isTooWide: ratio > idealRatio,
                    isTooNarrow: ratio < idealRatio,
                    stanceWidthPercent: Math.round(stanceWidth * 100),
                    shoulderWidthPercent: Math.round(shoulderWidth * 100)
                };
                
                console.log('MediaPipeスタンス分析:', {
                    ratio: ratio.toFixed(2),
                    idealRatio: idealRatio.toFixed(2),
                    club: selectedClub,
                    stanceWidth: Math.round(stanceWidth * 100) + '%',
                    shoulderWidth: Math.round(shoulderWidth * 100) + '%'
                });
                
                if (ratioDiff < 0.05) return 92;
                if (ratioDiff < 0.1) return 85;
                if (ratioDiff < 0.15) return 75;
                return 68;
                
            } catch (error) {
                console.error('MediaPipeスタンス分析エラー:', error);
                return 78;
            }
        }

        function analyzePostureFromLandmarks(landmarks) {
            try {
                const leftShoulder = landmarks[11];
                const rightShoulder = landmarks[12];
                const leftHip = landmarks[23];
                const rightHip = landmarks[24];
                
                const shoulderCenter = {
                    x: (leftShoulder.x + rightShoulder.x) / 2,
                    y: (leftShoulder.y + rightShoulder.y) / 2
                };
                const hipCenter = {
                    x: (leftHip.x + rightHip.x) / 2,
                    y: (leftHip.y + rightHip.y) / 2
                };
                
                const forwardLean = shoulderCenter.x - hipCenter.x;
                
                console.log('MediaPipe姿勢分析:', {
                    forwardLean: Math.round(forwardLean * 100) + '%'
                });
                
                const idealLean = 0.03;
                const leanDiff = Math.abs(forwardLean - idealLean);
                
                if (leanDiff < 0.02) return 92;
                if (leanDiff < 0.04) return 85;
                if (leanDiff < 0.06) return 75;
                return 68;
                
            } catch (error) {
                console.error('MediaPipe姿勢分析エラー:', error);
                return 82;
            }
        }

        function analyzeHandPosition(landmarks) {
            try {
                const leftWrist = landmarks[16];   // プレーヤーの左手首
                const rightWrist = landmarks[15];  // プレーヤーの右手首
                const leftAnkle = landmarks[28];   // プレーヤーの左足首
                const rightAnkle = landmarks[27];  // プレーヤーの右足首
                
                const handCenter = (leftWrist.x + rightWrist.x) / 2;
                const stanceCenter = (leftAnkle.x + rightAnkle.x) / 2;
                
                const selectedClub = document.getElementById('clubSelect').value;
                const idealHandOffset = getIdealHandPosition(selectedClub);
                const idealHandX = stanceCenter + idealHandOffset;
                const handDiff = handCenter - idealHandX;
                
                // 詳細データを保存（プレーヤー視点で左右を判定）
                detailedAnalysisData.handPosition = {
                    currentHandPosition: handCenter,
                    idealHandPosition: idealHandX,
                    stanceCenter: stanceCenter,
                    difference: handDiff,
                    club: selectedClub,
                    isLeftTooMuch: handDiff > 0,  // プレーヤー視点で左に寄りすぎ
                    isRightTooMuch: handDiff < 0, // プレーヤー視点で右に寄りすぎ
                    idealOffset: idealHandOffset
                };
                
                console.log('MediaPipe手位置分析 - 詳細:', {
                    '手の実際位置(handCenter)': Math.round(handCenter * 1000) / 10,
                    'スタンス中央(stanceCenter)': Math.round(stanceCenter * 1000) / 10,
                    '理想位置(idealHandX)': Math.round(idealHandX * 1000) / 10,
                    '理想オフセット': idealHandOffset,
                    '差分(handDiff)': Math.round(handDiff * 1000) / 10,
                    '手が右すぎる？': handDiff < 0,
                    '手が左すぎる？': handDiff > 0,
                    'クラブ': selectedClub
                });
                
                // プレーヤー視点で右すぎる場合（右腰の前など）は段階的に厳しく評価
                if (handDiff < -0.10) return 15; // プレーヤー視点で大きく右すぎる場合（右腰の前）
                if (handDiff < -0.06) return 25; // プレーヤー視点で右すぎる場合
                if (handDiff < -0.03) return 40; // プレーヤー視点でやや右すぎる場合
                
                // プレーヤー視点で左すぎる場合も段階的に評価
                if (handDiff > 0.15) return 20; // プレーヤー視点で大きく左すぎる場合
                if (handDiff > 0.10) return 30; // プレーヤー視点で左すぎる場合
                if (handDiff > 0.06) return 45; // プレーヤー視点でやや左すぎる場合
                
                // 左内ももあたり（理想的な位置）は高得点 - より寛容な基準
                if (Math.abs(handDiff) < 0.015) return 98; // 非常に理想的
                if (Math.abs(handDiff) < 0.03) return 95;  // 理想的
                if (Math.abs(handDiff) < 0.05) return 88;  // 良好
                if (Math.abs(handDiff) < 0.07) return 80;  // まあまあ
                return 60;
                
            } catch (error) {
                console.error('MediaPipe手位置分析エラー:', error);
                return 88;
            }
        }

        function analyzeWeightDistribution(landmarks) {
            try {
                const leftAnkle = landmarks[28];  // プレーヤーの左足首
                const rightAnkle = landmarks[27]; // プレーヤーの右足首
                const nose = landmarks[0];
                
                const stanceCenter = (leftAnkle.x + rightAnkle.x) / 2;
                const bodyCenter = nose.x;
                const balance = bodyCenter - stanceCenter; // 正の値：右足重心、負の値：左足重心
                
                const selectedClub = document.getElementById('clubSelect').value;
                const idealWeightBalance = getIdealWeightBalance(selectedClub);
                
                // 理想的な体重配分に基づく理想的な位置計算
                // 0.5 = 均等、0.6 = 6:4で右足重心
                let idealBodyPosition;
                if (idealWeightBalance === 0.6) {
                    idealBodyPosition = stanceCenter + 0.02; // 右に少しずれた位置
                } else {
                    idealBodyPosition = stanceCenter; // 中央
                }
                
                const positionDiff = Math.abs(bodyCenter - idealBodyPosition);
                
                // 詳細データを保存（プレーヤー視点で左右を判定）
                detailedAnalysisData.weight = {
                    currentBalance: balance,
                    bodyCenter: bodyCenter,
                    stanceCenter: stanceCenter,
                    idealBodyPosition: idealBodyPosition,
                    idealWeightBalance: idealWeightBalance,
                    club: selectedClub,
                    isRightHeavy: bodyCenter < idealBodyPosition,  // プレーヤー視点で右足重心
                    isLeftHeavy: bodyCenter > idealBodyPosition,   // プレーヤー視点で左足重心
                    difference: bodyCenter - idealBodyPosition
                };
                
                console.log('MediaPipe体重配分分析:', {
                    balance: Math.round(balance * 100) + '%',
                    bodyCenter: Math.round(bodyCenter * 100) + '%',
                    stanceCenter: Math.round(stanceCenter * 100) + '%',
                    idealBodyPosition: Math.round(idealBodyPosition * 100) + '%',
                    club: selectedClub,
                    idealBalance: (idealWeightBalance * 100) + '%右足重心'
                });
                
                if (positionDiff < 0.015) return 92;
                if (positionDiff < 0.03) return 85;
                if (positionDiff < 0.045) return 75;
                return 68;
                
            } catch (error) {
                console.error('MediaPipe体重配分分析エラー:', error);
                return 80;
            }
        }

        // 頭の位置分析（正面撮影用）
        function analyzeHeadPosition(landmarks) {
            try {
                const nose = landmarks[0];
                const leftAnkle = landmarks[28];  // プレーヤーの左足首
                const rightAnkle = landmarks[27]; // プレーヤーの右足首
                
                const stanceCenter = (leftAnkle.x + rightAnkle.x) / 2;
                const headPosition = nose.x;
                
                const selectedClub = document.getElementById('clubSelect').value;
                const idealHeadPosition = getIdealHeadPosition(selectedClub);
                
                // 理想的な頭の位置を計算
                const idealHeadX = stanceCenter + (idealHeadPosition - 0.5) * 0.1; // 微調整係数
                const headDiff = headPosition - idealHeadX; // 符号を保持
                
                // 詳細データを保存（プレーヤー視点で左右を判定）
                detailedAnalysisData.headPosition = {
                    currentHeadPosition: headPosition,
                    idealHeadPosition: idealHeadX,
                    stanceCenter: stanceCenter,
                    difference: headDiff,
                    club: selectedClub,
                    isLeftTooMuch: headDiff > 0,  // プレーヤー視点で左に寄りすぎ
                    isRightTooMuch: headDiff < 0, // プレーヤー視点で右に寄りすぎ
                    idealPositionPercent: idealHeadPosition * 100
                };
                
                console.log('MediaPipe頭位置分析:', {
                    headX: Math.round(headPosition * 100) + '%',
                    stanceCenter: Math.round(stanceCenter * 100) + '%',
                    idealHeadX: Math.round(idealHeadX * 100) + '%',
                    club: selectedClub,
                    diff: Math.round(headDiff * 100) + '%'
                });
                
                const absHeadDiff = Math.abs(headDiff);
                if (absHeadDiff < 0.02) return 92;
                if (absHeadDiff < 0.04) return 85;
                if (absHeadDiff < 0.06) return 75;
                return 68;
                
            } catch (error) {
                console.error('MediaPipe頭位置分析エラー:', error);
                return 85;
            }
        }

        // クラブ別の理想的なボール位置を取得
        function getIdealBallPosition(club) {
            const positions = {
                // ドライバー: 左足かかと内側
                'driver': 0.75,
                
                // フェアウェイウッド・ユーティリティ: ドライバーよりもボール1個右
                'fairway': 0.68,       // ドライバーよりボール1個右
                'utility': 0.68,       // ドライバーよりボール1個右
                
                // アイアン: クラブが短くなるに連れて徐々に右になる
                'iron4': 0.62,         // 4番アイアン
                'iron5': 0.58,         // 5番アイアン  
                'iron6': 0.54,         // 6番アイアン
                'iron7': 0.51,         // 7番アイアン
                
                // 8番アイアン～ウエッジ: 両足のセンター
                'iron8': 0.5,          // 8番アイアン: 両足のセンター
                'iron9': 0.5,          // 9番アイアン: 両足のセンター  
                'wedge': 0.5           // ウエッジ: 両足のセンター
            };
            return positions[club] || 0.5;
        }
        
        // クラブ別の理想的なスタンス幅比率を取得
        function getIdealStanceRatio(club) {
            const ratios = {
                'driver': 1.3,      // ドライバーは肩幅より少し広い
                'fairway': 1.2,     // フェアウェイウッド: 肩幅の1.2倍
                'utility': 1.15,    // ユーティリティ: 肩幅の1.15倍
                'iron4': 1.1,       // 4番アイアン: 肩幅の1.1倍
                'iron5': 1.1,       // 5番アイアン: 肩幅の1.1倍
                'iron6': 1.05,      // 6番アイアン: 肩幅の1.05倍
                'iron7': 1.05,      // 7番アイアン: 肩幅の1.05倍
                'iron8': 1.0,       // 8番アイアン: 肩幅と同じ
                'iron9': 1.0,       // 9番アイアン: 肩幅と同じ
                'wedge': 1.0        // ウェッジ: 肩幅と同じ
            };
            return ratios[club] || 1.1; // デフォルトは肩幅の1.1倍
        }
        
        // クラブ別の理想的な左右重心配分を取得（右足重心の割合）
        function getIdealWeightBalance(club) {
            if (club === 'driver') {
                return 0.6; // ドライバーは6:4で右足重心
            } else {
                return 0.5; // その他は左右均等
            }
        }
        
        // クラブ別の理想的な頭の位置を取得
        function getIdealHeadPosition(club) {
            if (club === 'driver') {
                return 0.52; // ドライバーは少し右
            } else {
                return 0.5; // その他はセンター（両足の中央）
            }
        }
        
        // クラブ別の理想的な前傾角度を取得（度）
        function getIdealForwardLean(club) {
            const angles = {
                'driver': 15,      // ドライバー: 浅めの前傾
                'fairway': 18,     // フェアウェイウッド
                'utility': 20,     // ユーティリティ
                'iron4': 22,       // 4番アイアン
                'iron5': 24,       // 5番アイアン
                'iron6': 26,       // 6番アイアン
                'iron7': 28,       // 7番アイアン
                'iron8': 30,       // 8番アイアン
                'iron9': 32,       // 9番アイアン
                'wedge': 35        // ウェッジ: 深めの前傾
            };
            return angles[club] || 25;
        }
        
        // クラブ別の理想的な手の位置を取得（スタンス中心からの相対位置）
        function getIdealHandPosition(club) {
            // 左股関節の少し右が理想的な手の位置（コメントでは左内ももと表現）
            // MediaPipeでは画面上で左が小さい値、右が大きい値
            // プレーヤー視点では左足が画面右側、右足が画面左側になる
            if (club === 'driver') {
                return 0.04; // スタンス中心より右に4%（プレーヤー視点で左股関節の少し右）
            } else {
                return 0.03; // スタンス中心より右に3%（プレーヤー視点で左股関節の少し右）
            }
        }
        
        // クラブ別の理想的な手の位置を取得（後方視点用）
        function getIdealHandPositionFromRear(club) {
            // ドライバーは肩の真下より少し前、その他は肩の真下
            if (club === 'driver') {
                return 0.03; // 肩の真下より前に3%（少し前）
            } else {
                return 0.0; // 肩の真下（0%のオフセット）
            }
        }
        
        // クラブ別の理想的な手と体の間隔を取得（後方視点用）
        function getIdealHandBodyDistance(club) {
            // ドライバーは拳3個分、その他は拳1.5-2個分
            if (club === 'driver') {
                return 0.09; // 体幅の9%程度（拳3個分）
            } else {
                return 0.05; // 体幅の5%程度（拳1.5-2個分）
            }
        }

        // 後方からの前傾角度分析
        function analyzeForwardLeanFromLandmarks(landmarks) {
            try {
                const leftShoulder = landmarks[12];  // プレーヤーの左肩
                const rightShoulder = landmarks[11]; // プレーヤーの右肩
                const leftHip = landmarks[24];       // プレーヤーの左腰
                const rightHip = landmarks[23];      // プレーヤーの右腰
                
                const shoulderCenter = {
                    x: (leftShoulder.x + rightShoulder.x) / 2,
                    y: (leftShoulder.y + rightShoulder.y) / 2
                };
                const hipCenter = {
                    x: (leftHip.x + rightHip.x) / 2,
                    y: (leftHip.y + rightHip.y) / 2
                };
                
                // 前傾角度を計算（垂直からの角度）
                const deltaY = shoulderCenter.y - hipCenter.y; // 上下の差（肩が腰より上にある）
                const deltaX = shoulderCenter.x - hipCenter.x; // 前後の差（符号を保持）
                const angle = Math.atan2(Math.abs(deltaX), Math.abs(deltaY)) * (180 / Math.PI);
                
                const selectedClub = document.getElementById('clubSelect').value;
                const idealAngle = getIdealForwardLean(selectedClub);
                const angleDiff = angle - idealAngle;
                
                // 詳細データを保存
                detailedAnalysisData.forwardLean = {
                    currentAngle: angle,
                    idealAngle: idealAngle,
                    difference: angleDiff,
                    club: selectedClub,
                    isTooShallow: angle < idealAngle,  // 角度が小さい = 浅すぎる
                    isTooDeep: angle > idealAngle,     // 角度が大きい = 深すぎる
                    absoluteDifference: Math.abs(angleDiff)
                };
                
                console.log('MediaPipe前傾角度分析:', {
                    angle: Math.round(angle) + '度',
                    idealAngle: idealAngle + '度',
                    club: selectedClub,
                    diff: Math.round(angleDiff) + '度'
                });
                
                const absAngleDiff = Math.abs(angleDiff);
                if (absAngleDiff < 3) return 92;  // 3度以内
                if (absAngleDiff < 5) return 85;  // 5度以内
                if (absAngleDiff < 8) return 75;  // 8度以内
                return 68;
                
            } catch (error) {
                console.error('MediaPipe前傾角度分析エラー:', error);
                return 80;
            }
        }

        // 後方からの手の位置分析（肩の真下基準）
        function analyzeHandBodyDistance(landmarks) {
            try {
                const leftWrist = landmarks[15];
                const rightWrist = landmarks[16];
                const leftShoulder = landmarks[11];
                const rightShoulder = landmarks[12];
                
                const handCenter = {
                    x: (leftWrist.x + rightWrist.x) / 2,
                    y: (leftWrist.y + rightWrist.y) / 2
                };
                const shoulderCenter = {
                    x: (leftShoulder.x + rightShoulder.x) / 2,
                    y: (leftShoulder.y + rightShoulder.y) / 2
                };
                
                const selectedClub = document.getElementById('clubSelect').value;
                
                // 肩の真下からの前後位置差を計算
                const forwardOffset = handCenter.x - shoulderCenter.x;
                const idealForwardOffset = getIdealHandPositionFromRear(selectedClub);
                const positionDiff = Math.abs(forwardOffset - idealForwardOffset);
                
                // 手と体の間隔（距離）を計算
                const bodyWidth = Math.abs(rightShoulder.x - leftShoulder.x);
                const handBodyDistance = Math.sqrt(
                    Math.pow(handCenter.x - shoulderCenter.x, 2) + 
                    Math.pow(handCenter.y - shoulderCenter.y, 2)
                );
                const relativeDistance = handBodyDistance / bodyWidth;
                const idealDistance = getIdealHandBodyDistance(selectedClub);
                const distanceDiff = Math.abs(relativeDistance - idealDistance);
                
                console.log('MediaPipe手の位置分析（後方）:', {
                    forwardOffset: Math.round(forwardOffset * 100) + '%',
                    idealForwardOffset: Math.round(idealForwardOffset * 100) + '%',
                    handBodyDistance: Math.round(relativeDistance * 100) + '%',
                    idealDistance: Math.round(idealDistance * 100) + '%',
                    club: selectedClub
                });
                
                // 詳細データを保存
                detailedAnalysisData.handBodyDistance = {
                    currentDistance: relativeDistance,
                    idealDistance: idealDistance,
                    forwardOffset: forwardOffset,
                    idealForwardOffset: idealForwardOffset,
                    club: selectedClub,
                    isTooClose: relativeDistance < (idealDistance - 0.02),
                    isTooFar: relativeDistance > (idealDistance + 0.02),
                    positionDiff: positionDiff,
                    distanceDiff: distanceDiff
                };
                
                // 位置と距離の両方を評価（平均スコア）
                let positionScore = 50;
                if (positionDiff < 0.01) positionScore = 92;
                else if (positionDiff < 0.02) positionScore = 85;
                else if (positionDiff < 0.03) positionScore = 75;
                else positionScore = 68;
                
                let distanceScore = 50;
                if (distanceDiff < 0.01) distanceScore = 92;
                else if (distanceDiff < 0.02) distanceScore = 85;
                else if (distanceDiff < 0.03) distanceScore = 75;
                else distanceScore = 68;
                
                return Math.round((positionScore + distanceScore) / 2);
                
            } catch (error) {
                console.error('MediaPipe手の位置分析エラー:', error);
                return 82;
            }
        }

        // 後方からの前後バランス分析
        function analyzeFrontBackBalance(landmarks) {
            try {
                const nose = landmarks[0];
                const leftAnkle = landmarks[28];  // プレーヤーの左足首
                const rightAnkle = landmarks[27]; // プレーヤーの右足首
                const leftToe = landmarks[30];    // プレーヤーの左つま先
                const rightToe = landmarks[29];   // プレーヤーの右つま先
                
                const ankleCenter = (leftAnkle.x + rightAnkle.x) / 2;
                const toeCenter = (leftToe.x + rightToe.x) / 2;
                const headPosition = nose.x;
                
                // 足全体の中心とつま先の関係を考慮
                const footLength = Math.abs(toeCenter - ankleCenter);
                const footCenter = ankleCenter + (footLength * 0.4); // つま先寄りの位置
                
                const balance = headPosition - footCenter;
                
                // 理想的なバランス（ややつま先寄り）
                const idealBalance = 0.0; // footCenter自体がややつま先寄りなので0が理想
                const balanceDiff = balance - idealBalance;
                
                // 詳細データを保存
                detailedAnalysisData.frontBackBalance = {
                    currentBalance: balance,
                    idealBalance: idealBalance,
                    difference: balanceDiff,
                    headPosition: headPosition,
                    footCenter: footCenter,
                    ankleCenter: ankleCenter,
                    isTooForward: balance > idealBalance, // つま先寄りすぎ
                    isTooBackward: balance < idealBalance, // かかと寄りすぎ
                    absoluteDifference: Math.abs(balanceDiff)
                };
                
                console.log('MediaPipe前後バランス分析:', {
                    headPosition: Math.round(headPosition * 100) + '%',
                    ankleCenter: Math.round(ankleCenter * 100) + '%',
                    footCenter: Math.round(footCenter * 100) + '%（ややつま先寄り）',
                    balance: Math.round(balance * 100) + '%',
                    idealBalance: '0%（ややつま先寄り基準）',
                    diff: Math.round(balanceDiff * 100) + '%'
                });
                
                const absBalanceDiff = Math.abs(balanceDiff);
                if (absBalanceDiff < 0.02) return 92;
                if (absBalanceDiff < 0.04) return 85;
                if (absBalanceDiff < 0.06) return 75;
                return 68;
                
            } catch (error) {
                console.error('MediaPipe前後バランス分析エラー:', error);
                return 85;
            }
        }

        // 後方からの体の向き分析（肩・腰・かかとライン平行）
        function analyzeBodyDirection(landmarks) {
            try {
                const leftShoulder = landmarks[11];
                const rightShoulder = landmarks[12];
                const leftHip = landmarks[23];
                const rightHip = landmarks[24];
                const leftHeel = landmarks[29]; // 左足後部
                const rightHeel = landmarks[30]; // 右足後部
                
                // 各ラインの角度を計算
                const shoulderAngle = Math.atan2(rightShoulder.y - leftShoulder.y, rightShoulder.x - leftShoulder.x);
                const hipAngle = Math.atan2(rightHip.y - leftHip.y, rightHip.x - leftHip.x);
                const heelAngle = Math.atan2(rightHeel.y - leftHeel.y, rightHeel.x - leftHeel.x);
                
                // 角度をラジアンから度に変換
                const shoulderDeg = shoulderAngle * (180 / Math.PI);
                const hipDeg = hipAngle * (180 / Math.PI);
                const heelDeg = heelAngle * (180 / Math.PI);
                
                // 各ライン間の角度差を計算
                const shoulderHipDiff = Math.abs(shoulderDeg - hipDeg);
                const shoulderHeelDiff = Math.abs(shoulderDeg - heelDeg);
                const hipHeelDiff = Math.abs(hipDeg - heelDeg);
                
                // 3つのラインの平行性を評価
                const maxAngleDiff = Math.max(shoulderHipDiff, shoulderHeelDiff, hipHeelDiff);
                const avgAngleDiff = (shoulderHipDiff + shoulderHeelDiff + hipHeelDiff) / 3;

                // オープン/クローズ判定（基準: 0度=スクエア、正=オープン、負=クローズ）
                const tol = 2; // 許容誤差（度）
                const stateOf = (deg) => deg > tol ? 'open' : (deg < -tol ? 'closed' : 'square');
                const shoulderState = stateOf(shoulderDeg);
                const hipState = stateOf(hipDeg);
                const heelState = stateOf(heelDeg);
                
                // 詳細データを保存
                detailedAnalysisData.bodyDirection = {
                    shoulderAngle: shoulderDeg,
                    hipAngle: hipDeg,
                    heelAngle: heelDeg,
                    shoulderHipDiff: shoulderHipDiff,
                    shoulderHeelDiff: shoulderHeelDiff,
                    hipHeelDiff: hipHeelDiff,
                    maxAngleDiff: maxAngleDiff,
                    avgAngleDiff: avgAngleDiff,
                    isShoulderMisaligned: shoulderHipDiff > 3 || shoulderHeelDiff > 3,
                    isHipMisaligned: shoulderHipDiff > 3 || hipHeelDiff > 3,
                    isHeelMisaligned: shoulderHeelDiff > 3 || hipHeelDiff > 3,
                    shoulderState,
                    hipState,
                    heelState
                };
                
                console.log('MediaPipe体の向き分析（3ライン平行）:', {
                    shoulderAngle: Math.round(shoulderDeg) + '度',
                    hipAngle: Math.round(hipDeg) + '度',
                    heelAngle: Math.round(heelDeg) + '度',
                    maxAngleDiff: Math.round(maxAngleDiff) + '度',
                    avgAngleDiff: Math.round(avgAngleDiff) + '度'
                });
                
                // 平行性の評価（角度差が小さいほど高スコア）
                if (maxAngleDiff < 3 && avgAngleDiff < 2) return 92;  // 3度以内の差で平行
                if (maxAngleDiff < 5 && avgAngleDiff < 3) return 85;  // 5度以内
                if (maxAngleDiff < 8 && avgAngleDiff < 5) return 75;  // 8度以内
                return 68;
                
            } catch (error) {
                console.error('MediaPipe体の向き分析エラー:', error);
                return 83;
            }
        }

        // 後方からの背中の曲がり具合分析
        function analyzeBackCurvature(landmarks) {
            try {
                const nose = landmarks[0];
                const leftShoulder = landmarks[11];
                const rightShoulder = landmarks[12];
                const leftHip = landmarks[23];
                const rightHip = landmarks[24];
                
                const shoulderCenter = {
                    x: (leftShoulder.x + rightShoulder.x) / 2,
                    y: (leftShoulder.y + rightShoulder.y) / 2
                };
                const hipCenter = {
                    x: (leftHip.x + rightHip.x) / 2,
                    y: (leftHip.y + rightHip.y) / 2
                };
                
                // 頭-肩-腰のライン分析
                const upperSpine = shoulderCenter.x - nose.x;
                const lowerSpine = hipCenter.x - shoulderCenter.x;
                const curvatureRatio = Math.abs(upperSpine - lowerSpine);
                
                // 反りすぎ（腰の反り）と丸すぎを判定
                const totalForwardLean = shoulderCenter.x - hipCenter.x;
                const spineAlignment = upperSpine + lowerSpine;
                
                // 詳細データを保存
                detailedAnalysisData.backCurvature = {
                    upperSpine: upperSpine,
                    lowerSpine: lowerSpine,
                    curvatureRatio: curvatureRatio,
                    totalForwardLean: totalForwardLean,
                    spineAlignment: spineAlignment,
                    isTooStraight: curvatureRatio < 0.01, // 真っすぐすぎ
                    isTooArched: upperSpine > 0 && lowerSpine < 0 && curvatureRatio > 0.05, // 反りすぎ
                    isTooRounded: upperSpine < 0 && lowerSpine > 0 && curvatureRatio > 0.05 // 丸すぎ
                };
                
                console.log('MediaPipe背中の曲がり具合分析:', {
                    upperSpine: Math.round(upperSpine * 100) + '%',
                    lowerSpine: Math.round(lowerSpine * 100) + '%',
                    curvatureRatio: Math.round(curvatureRatio * 100) + '%'
                });
                
                // 理想的な自然な湾曲
                if (curvatureRatio < 0.02) return 92;
                if (curvatureRatio < 0.04) return 85;
                if (curvatureRatio < 0.06) return 75;
                return 68;
                
            } catch (error) {
                console.error('MediaPipe背中の曲がり具合分析エラー:', error);
                return 84;
            }
        }

        // 基本的なボール位置スコア計算
        function calculateBallPositionScore() {
            if (!ballPosition) return 85;
            
            const x = ballPosition.x;
            const selectedClub = document.getElementById('clubSelect').value;
            const idealPosition = getIdealBallPosition(selectedClub);
            
            const diff = Math.abs(x - idealPosition);
            
            if (diff < 0.05) return 92; // 理想的
            if (diff < 0.1) return 85;  // 良好
            if (diff < 0.15) return 75; // やや不適切
            return 68; // 要改善
        }

        // 詳細なコメント生成関数（新バージョン）
        function generateDetailedComment(score, type, analysisKey) {
            if (score >= 90) {
                return `理想的な${type.replace(/🎯|🦵|👤|🤚|⚖️|🏃|📐|⬇️|📏|🧭|🔄/g, '')}です。現在の設定で優れた結果が出ています。`;
            }
            
            const data = detailedAnalysisData[analysisKey];
            if (!data) {
                return `${type.replace(/🎯|🦵|👤|🤚|⚖️|🏃|📐|⬇️|📏|🧭|🔄/g, '')}を改善する必要があります。`;
            }
            
            // ボール位置の詳細フィードバック
            if (analysisKey === 'ballPosition') {
                const clubNames = {
                    'driver': 'ドライバー',
                    'fairway': 'フェアウェイウッド', 
                    'utility': 'ユーティリティ',
                    'iron4': '4番アイアン',
                    'iron5': '5番アイアン', 
                    'iron6': '6番アイアン',
                    'iron7': '7番アイアン',
                    'iron8': '8番アイアン',
                    'iron9': '9番アイアン',
                    'wedge': 'ウェッジ'
                };
                
                const clubName = clubNames[data.club] || data.club;
                const idealDescription = getIdealPositionDescription(data.club);
                
                if (data.isLeftTooMuch) {
                    return `<strong>現状：</strong>ボールが左に寄りすぎています。<br>
                           <strong>理想：</strong>${clubName}の理想位置は${idealDescription}です。<br>
                           <strong>改善方法：</strong>ボールをもう少し右に移動させてください。約${Math.abs(Math.round(data.difference * 100))}%右に調整が必要です。`;
                } else if (data.isRightTooMuch) {
                    return `<strong>現状：</strong>ボールが右に寄りすぎています。<br>
                           <strong>理想：</strong>${clubName}の理想位置は${idealDescription}です。<br>
                           <strong>改善方法：</strong>ボールをもう少し左に移動させてください。約${Math.abs(Math.round(data.difference * 100))}%左に調整が必要です。`;
                }
            }
            
            // スタンス幅の詳細フィードバック
            if (analysisKey === 'stance') {
                const clubNames = {
                    'driver': 'ドライバー',
                    'fairway': 'フェアウェイウッド', 
                    'utility': 'ユーティリティ',
                    'iron4': '4番アイアン',
                    'iron5': '5番アイアン', 
                    'iron6': '6番アイアン',
                    'iron7': '7番アイアン',
                    'iron8': '8番アイアン',
                    'iron9': '9番アイアン',
                    'wedge': 'ウェッジ'
                };
                
                const clubName = clubNames[data.club] || data.club;
                const idealDescriptions = {
                    'driver': '肩幅より少し広い幅（1.3倍）',
                    'fairway': '肩幅の1.2倍程度',
                    'utility': '肩幅の1.15倍程度', 
                    'iron4': '肩幅の1.1倍程度',
                    'iron5': '肩幅の1.1倍程度',
                    'iron6': '肩幅の1.05倍程度',
                    'iron7': '肩幅の1.05倍程度',
                    'iron8': '肩幅と同じ程度',
                    'iron9': '肩幅と同じ程度',
                    'wedge': '肩幅と同じ程度'
                };
                const idealDescription = idealDescriptions[data.club] || '肩幅～1.2倍程度';
                
                if (data.isTooWide) {
                    return `<strong>現状：</strong>スタンス幅が広すぎます（現在：肩幅の${data.currentRatio.toFixed(1)}倍）。<br>
                           <strong>理想：</strong>${clubName}の理想は${idealDescription}です。<br>
                           <strong>改善方法：</strong>足をもう少し狭めて、機動性を向上させてください。`;
                } else if (data.isTooNarrow) {
                    return `<strong>現状：</strong>スタンス幅が狭すぎます（現在：肩幅の${data.currentRatio.toFixed(1)}倍）。<br>
                           <strong>理想：</strong>${clubName}の理想は${idealDescription}です。<br>
                           <strong>改善方法：</strong>足をもう少し広げて、安定感を向上させてください。`;
                }
            }
            
            // 体重配分の詳細フィードバック
            if (analysisKey === 'weight') {
                const clubNames = {
                    'driver': 'ドライバー',
                    'fairway': 'フェアウェイウッド', 
                    'utility': 'ユーティリティ',
                    'iron4': '4番アイアン',
                    'iron5': '5番アイアン', 
                    'iron6': '6番アイアン',
                    'iron7': '7番アイアン',
                    'iron8': '8番アイアン',
                    'iron9': '9番アイアン',
                    'wedge': 'ウェッジ'
                };
                
                const clubName = clubNames[data.club] || data.club;
                const idealDescription = data.club === 'driver' ? '6:4で右足重心' : '左右均等（5:5）';
                
                if (data.isRightHeavy) {
                    return `<strong>現状：</strong>右足に体重がかかりすぎています。<br>
                           <strong>理想：</strong>${clubName}の理想は${idealDescription}です。<br>
                           <strong>改善方法：</strong>左足により体重をかけてバランスを取ってください。`;
                } else if (data.isLeftHeavy) {
                    return `<strong>現状：</strong>左足に体重がかかりすぎています。<br>
                           <strong>理想：</strong>${clubName}の理想は${idealDescription}です。<br>
                           <strong>改善方法：</strong>右足により体重をかけてバランスを取ってください。`;
                }
            }
            
            // 頭の位置の詳細フィードバック
            if (analysisKey === 'headPosition') {
                const clubNames = {
                    'driver': 'ドライバー',
                    'fairway': 'フェアウェイウッド', 
                    'utility': 'ユーティリティ',
                    'iron4': '4番アイアン',
                    'iron5': '5番アイアン', 
                    'iron6': '6番アイアン',
                    'iron7': '7番アイアン',
                    'iron8': '8番アイアン',
                    'iron9': '9番アイアン',
                    'wedge': 'ウェッジ'
                };
                
                const clubName = clubNames[data.club] || data.club;
                const idealDescription = data.club === 'driver' ? '少し右（スタンス中央より右）' : 'センター（両足のほぼ中央）';
                
                if (data.isLeftTooMuch) {
                    return `<strong>現状：</strong>頭が左に寄りすぎています。<br>
                           <strong>理想：</strong>${clubName}の理想は${idealDescription}です。<br>
                           <strong>改善方法：</strong>頭をもう少し右に移動させてください。`;
                } else if (data.isRightTooMuch) {
                    return `<strong>現状：</strong>頭が右に寄りすぎています。<br>
                           <strong>理想：</strong>${clubName}の理想は${idealDescription}です。<br>
                           <strong>改善方法：</strong>頭をもう少し左に移動させてください。`;
                }
            }
            
            // 手の位置の詳細フィードバック（正面）
            if (analysisKey === 'handPosition') {
                if (data.isLeftTooMuch) {
                    return `<strong>現状：</strong>手が左に寄りすぎています。<br>
                           <strong>理想：</strong>左内ももあたりが理想です。<br>
                           <strong>改善方法：</strong>手をもう少し右に移動させてください。`;
                } else if (data.isRightTooMuch) {
                    return `<strong>現状：</strong>手が右に寄りすぎています。<br>
                           <strong>理想：</strong>左内ももあたりが理想です。<br>
                           <strong>改善方法：</strong>手をもう少し左に移動させてください。`;
                }
            }
            
            // 前傾角度の詳細フィードバック（後方）
            if (analysisKey === 'forwardLean') {
                const clubNames = {
                    'driver': 'ドライバー',
                    'fairway': 'フェアウェイウッド', 
                    'utility': 'ユーティリティ',
                    'iron4': '4番アイアン',
                    'iron5': '5番アイアン', 
                    'iron6': '6番アイアン',
                    'iron7': '7番アイアン',
                    'iron8': '8番アイアン',
                    'iron9': '9番アイアン',
                    'wedge': 'ウェッジ'
                };
                
                const clubName = clubNames[data.club] || data.club;
                
                if (data.isTooShallow) {
                    return `<strong>現状：</strong>前傾角度が浅すぎます。<br>
                           <strong>理想：</strong>${clubName}では適度な前傾角度が必要です。<br>
                           <strong>改善方法：</strong>股関節からもう少し深く前傾してください。`;
                } else if (data.isTooDeep) {
                    return `<strong>現状：</strong>前傾角度が深すぎます。<br>
                           <strong>理想：</strong>${clubName}では適度な前傾角度を保つことが大切です。<br>
                           <strong>改善方法：</strong>もう少し上体を起こしてください。`;
                }
            }
            
            // 手と体の距離の詳細フィードバック（後方）
            if (analysisKey === 'handBodyDistance') {
                const clubNames = {
                    'driver': 'ドライバー',
                    'fairway': 'フェアウェイウッド', 
                    'utility': 'ユーティリティ',
                    'iron4': '4番アイアン',
                    'iron5': '5番アイアン', 
                    'iron6': '6番アイアン',
                    'iron7': '7番アイアン',
                    'iron8': '8番アイアン',
                    'iron9': '9番アイアン',
                    'wedge': 'ウェッジ'
                };
                
                const clubName = clubNames[data.club] || data.club;
                const positionIdeal = data.club === 'driver' ? '肩の真下より少し前' : '肩の真下';
                const distanceIdeal = data.club === 'driver' ? '拳3個分' : '拳1.5～2個分';
                
                if (data.isTooClose) {
                    return `<strong>現状：</strong>手が体に近すぎて窮屈な構えになっています。<br>
                           <strong>理想：</strong>${clubName}の手は${positionIdeal}で、体との間隔は${distanceIdeal}です。<br>
                           <strong>改善方法：</strong>もう少し手を体から離し、腕に余裕を持たせてください。`;
                } else if (data.isTooFar) {
                    return `<strong>現状：</strong>手が体から離れすぎて不安定な構えになっています。<br>
                           <strong>理想：</strong>${clubName}の手は${positionIdeal}で、体との間隔は${distanceIdeal}です。<br>
                           <strong>改善方法：</strong>手をもう少し体に近づけて、安定した構えを作ってください。`;
                } else if (data.forwardOffset && Math.abs(data.forwardOffset) > 0.02) {
                    const offsetDesc = data.forwardOffset > 0 ? '前に出すぎ' : '後ろに下がりすぎ';
                    return `<strong>現状：</strong>手の前後位置がずれています（肩から${offsetDesc}）。<br>
                           <strong>理想：</strong>${clubName}の手は${positionIdeal}が理想です。<br>
                           <strong>改善方法：</strong>手の位置を${data.forwardOffset > 0 ? '少し後ろに' : '少し前に'}移動させてください。`;
                } else {
                    return `<strong>現状：</strong>手と体の距離バランスが不適切です。<br>
                           <strong>理想：</strong>体との間隔は${distanceIdeal}が理想です。<br>
                           <strong>改善方法：</strong>手と体の適切な距離を意識してください。`;
                }
            }
            
            // 前後バランスの詳細フィードバック（後方）
            if (analysisKey === 'frontBackBalance') {
                if (data.isTooForward) {
                    return `<strong>現状：</strong>重心がつま先寄りすぎています。<br>
                           <strong>理想：</strong>ややつま先寄りが理想です。<br>
                           <strong>改善方法：</strong>もう少し重心をかかと寄りに移動させてください。`;
                } else if (data.isTooBackward) {
                    return `<strong>現状：</strong>重心がかかと寄りすぎています。<br>
                           <strong>理想：</strong>ややつま先寄りが理想です。<br>
                           <strong>改善方法：</strong>もう少し重心をつま先寄りに移動させてください。`;
                }
            }
            
            // 体の向きの詳細フィードバック（後方）
            if (analysisKey === 'bodyDirection') {
                const problems = [];
                if (data.isShoulderMisaligned) problems.push('肩のライン');
                if (data.isHipMisaligned) problems.push('腰のライン');
                if (data.isHeelMisaligned) problems.push('かかとのライン');
                
                if (problems.length > 0) {
                    return `<strong>現状：</strong>${problems.join('、')}がずれています。<br>
                           <strong>理想：</strong>肩、腰、かかとのラインが平行でボールを打ち出したい方向に向いている状態です。<br>
                           <strong>改善方法：</strong>${problems.join('、')}を他のラインと平行になるように調整してください。`;
                } else {
                    return `<strong>現状：</strong>体の向きに軽微なずれがあります。<br>
                           <strong>理想：</strong>肩、腰、かかとのラインが完全に平行な状態です。<br>
                           <strong>改善方法：</strong>全体的な姿勢を微調整してください。`;
                }
            }
            
            // 背中の曲がり具合の詳細フィードバック（後方）
            if (analysisKey === 'backCurvature') {
                if (data.isTooArched) {
                    return `<strong>現状：</strong>腰が反りすぎて背中の曲がり具合が深すぎます。<br>
                           <strong>理想：</strong>適度に伸びた自然なS字カーブが理想です。<br>
                           <strong>改善方法：</strong>腰の反りを抑えて、もう少し背筋を伸ばしてください。`;
                } else if (data.isTooRounded) {
                    return `<strong>現状：</strong>背中が丸くなりすぎて猫背気味になっています。<br>
                           <strong>理想：</strong>適度に伸びた自然なS字カーブが理想です。<br>
                           <strong>改善方法：</strong>もう少し胸を張って背筋を伸ばしてください。`;
                } else if (data.isTooStraight) {
                    return `<strong>現状：</strong>背中が真っすぐすぎて自然な曲がりがありません。<br>
                           <strong>理想：</strong>自然なS字カーブを保つことが理想です。<br>
                           <strong>改善方法：</strong>自然な背中の曲がり具合を意識してください。`;
                } else {
                    return `<strong>現状：</strong>背中の曲がり具合が不安定です。<br>
                           <strong>理想：</strong>適度に伸びた自然なS字カーブが理想です。<br>
                           <strong>改善方法：</strong>背筋を伸ばし、自然な姿勢を心がけてください。`;
                }
            }
            
            // フォールバック：旧コメントシステムを使用
            return generateOldDetailedComment(score, type);
        }
        
        // 理想位置の説明を取得
        function getIdealPositionDescription(club) {
            const descriptions = {
                'driver': '左足かかと内側',
                'fairway': 'ドライバーよりもボール1個右',
                'utility': 'ドライバーよりもボール1個右',
                'iron4': 'センターより少し左',
                'iron5': 'センターより少し左',
                'iron6': 'センターより少し左', 
                'iron7': 'センターより少し左',
                'iron8': '両足のセンター',
                'iron9': '両足のセンター',
                'wedge': '両足のセンター'
            };
            return descriptions[club] || '適切な位置';
        }
        
        // 旧コメントシステム（削除予定）
        function generateOldDetailedComment(score, type) {
            const comments = {
                'ballPosition': {
                    excellent: '理想的なボール位置です。選択されたクラブに応じた適切な位置にボールが置かれています。',
                    good: '概ね良いボール位置ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>ボール位置が理想から大きくずれています。<br><strong>理想位置：</strong>ドライバーは左足かかと内側、アイアンは徐々に右に移動し、8番アイアン～ウェッジは両足センターが理想です。<br><strong>改善方法：</strong>ボールの位置を理想位置に調整してください。正しい位置に置くことで、クラブの性能を最大限に発揮できます。' :
                          '<strong>現状：</strong>ボール位置が理想から大きくずれています。<br><strong>理想位置：</strong>ドライバーは左足かかと内側、アイアンは徐々に右に移動し、8番アイアン～ウェッジは両足センターが理想です。<br><strong>改善方法：</strong>ボールの位置を理想位置に調整してください。正しい位置に置くことで、クラブの性能を最大限に発揮できます。'
                },
                'stance': {
                    excellent: '理想的なスタンス幅です。肩幅の1.2倍程度の適切な幅で安定感があります。',
                    good: '概ね良いスタンス幅ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>スタンス幅が狭すぎて不安定です。<br><strong>理想幅：</strong>肩幅の1.2倍程度が理想です。<br><strong>改善方法：</strong>足をもう少し広げて安定感を向上させてください。適切なスタンスでバランスの取れたスイングが可能になります。' :
                          '<strong>現状：</strong>スタンス幅が広すぎて動きが制限されます。<br><strong>理想幅：</strong>肩幅の1.2倍程度が理想です。<br><strong>改善方法：</strong>足をもう少し狭めて機動性を向上させてください。適切なスタンスでスムーズなスイングが可能になります。'
                },
                'posture': {
                    excellent: '理想的な前傾姿勢です。股関節から適切な角度で前傾しています。',
                    good: '概ね良い姿勢ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>前傾が浅すぎて理想から大きくずれています。<br><strong>理想：</strong>ドライバーは浅め、クラブが短いほど徐々に深く、ウェッジで最も深い前傾が理想です。<br><strong>改善方法：</strong>股関節からもう少し深く前傾してください。'
                          : '<strong>現状：</strong>前傾が深すぎて理想から大きくずれています。<br><strong>理想：</strong>ドライバーは浅め、クラブが短いほど徐々に深く、ウェッジで最も深い前傾が理想です。<br><strong>改善方法：</strong>もう少し上体を起こしてください。'
                },
                'handPosition': {
                    excellent: '理想的な手の位置です。体の中心線より少し左に適切に位置しています。',
                    good: '概ね良い手の位置ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>手が左に寄りすぎて理想位置からずれています。<br><strong>理想位置：</strong>体の中心線より少し左（左内もも付近）が理想です。<br><strong>改善方法：</strong>手をもう少し右に移動させてください。正しい手の位置により、スイングプレーンが安定します。' :
                          '<strong>現状：</strong>手が右に寄りすぎて理想位置からずれています。<br><strong>理想位置：</strong>体の中心線より少し左（左内もも付近）が理想です。<br><strong>改善方法：</strong>手をもう少し左に移動させてください。正しい手の位置により、スイングプレーンが安定します。'
                },
                'headPosition': {
                    excellent: '理想的な頭の位置です。適切なバランスの取れた位置にあります。',
                    good: '概ね良い頭の位置ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>頭が左に寄りすぎてバランスが崩れています。<br><strong>理想位置：</strong>スタンス中央より少し右（ボールの後方）が理想です。<br><strong>改善方法：</strong>頭をもう少し右に移動させてください。正しい頭の位置により、スイング軸が安定します。' :
                          '<strong>現状：</strong>頭が右に寄りすぎてバランスが崩れています。<br><strong>理想位置：</strong>スタンス中央（ボールの後方）が理想です。<br><strong>改善方法：</strong>頭をもう少し左に移動させてください。正しい頭の位置により、スイング軸が安定します。'
                },
                'weight': {
                    excellent: '理想的な体重配分です。両足に均等に体重が分散されています。',
                    good: '概ね良い体重配分ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>右足に体重がかかりすぎてバランスが崩れています。<br><strong>理想配分：</strong>両足に均等（50:50）が理想です。<br><strong>改善方法：</strong>左足により体重をかけてバランスを取ってください。正しい体重配分により、安定したスイングが可能になります。' :
                          '<strong>現状：</strong>左足に体重がかかりすぎてバランスが崩れています。<br><strong>理想配分：</strong>両足に均等（50:50）が理想です。<br><strong>改善方法：</strong>右足により体重をかけてバランスを取ってください。正しい体重配分により、安定したスイングが可能になります。'
                },
                'forwardLean': {
                    excellent: '理想的な前傾角度です。クラブに応じた適切な前傾姿勢が取れています。',
                    good: '概ね良い前傾角度ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>前傾が浅すぎて理想から大きくずれています。<br><strong>理想：</strong>ドライバーは浅め、クラブが短いほど徐々に深く、ウェッジで最も深い前傾が理想です。<br><strong>改善方法：</strong>股関節からもう少し深く前傾してください。'
                          : '<strong>現状：</strong>前傾が深すぎて理想から大きくずれています。<br><strong>理想：</strong>ドライバーは浅め、クラブが短いほど徐々に深く、ウェッジで最も深い前傾が理想です。<br><strong>改善方法：</strong>もう少し上体を起こしてください。'
                },
                'handBodyDistance': {
                    excellent: '理想的な手と体の距離です。適切な距離を保っています。',
                    good: '概ね良い手と体の距離ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>手が体に近すぎて窮屈になっています。<br><strong>理想距離：</strong>ドライバーは拳3個分、アイアンは拳1.5-2個分が理想です。<br><strong>改善方法：</strong>もう少し体から離してください。適切な距離により、スムーズなスイングが可能になります。' :
                          '<strong>現状：</strong>手が体から離れすぎて不安定です。<br><strong>理想距離：</strong>ドライバーは拳3個分、アイアンは拳1.5-2個分が理想です。<br><strong>改善方法：</strong>もう少し体に近づけてください。適切な距離により、コントロールが向上します。'
                },
                'frontBackBalance': {
                    excellent: '理想的な前後バランスです。重心が適切な位置にあります。',
                    good: '概ね良い前後バランスですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>重心が前（つま先）に寄りすぎています。<br><strong>理想位置：</strong>足の土踏まず上が理想です。<br><strong>改善方法：</strong>もう少し後ろ（かかと側）に体重をかけてください。適切な重心位置により、バランスの取れたスイングが可能になります。' :
                          '<strong>現状：</strong>重心が後ろ（かかと）に寄りすぎています。<br><strong>理想位置：</strong>足の土踏まず上が理想です。<br><strong>改善方法：</strong>もう少し前（つま先側）に体重をかけてください。適切な重心位置により、力強いスイングが可能になります。'
                },
                'bodyDirection': {
                    excellent: '理想的な体の向きです。肩と腰のラインが適切に揃っています。',
                    good: '概ね良い体の向きですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>体の向きに歪みがあり、肩・腰・足のラインが不揃いです。<br><strong>理想向き：</strong>肩、腰、足のラインが平行で、目標方向に向いている状態が理想です。<br><strong>改善方法：</strong>肩と腰のラインを揃えてください。正しい体の向きにより、狙った方向にボールが飛びます。' :
                          '<strong>現状：</strong>体の向きが不安定で、左右のバランスが崩れています。<br><strong>理想向き：</strong>肩、腰、足のラインが平行で、目標方向に向いている状態が理想です。<br><strong>改善方法：</strong>左右のバランスを整えてください。正しい体の向きにより、一貫したスイングが可能になります。'
                },
                'backCurvature': {
                    excellent: '理想的な背中の曲がり具合です。自然なS字カーブを保っています。',
                    good: '概ね良い背中の曲がり具合ですが、微調整でより安定します。',
                    poor: score < 75 ? '<strong>現状：</strong>背骨が過度に曲がって猫背になっています。<br><strong>理想姿勢：</strong>自然なS字カーブを保つことが理想です。<br><strong>改善方法：</strong>もう少し背筋を伸ばして胸を張ってください。正しい背骨の曲がり具合により、パワフルで安定したスイングが可能になります。' :
                          '<strong>現状：</strong>背骨が真っすぐすぎて自然な湾曲がありません。<br><strong>理想姿勢：</strong>自然なS字カーブを保つことが理想です。<br><strong>改善方法：</strong>自然な湾曲を意識して、リラックスした姿勢を取ってください。適切な背骨の曲がり具合により、スムーズなスイングが可能になります。'
                }
            };
            
            const key = type.includes('ボール') ? 'ballPosition' :
                       type.includes('スタンス') ? 'stance' :
                       type.includes('姿勢') ? 'posture' :
                       type.includes('頭') ? 'headPosition' :
                       type.includes('手の位置') ? 'handPosition' :
                       type.includes('手と体') ? 'handBodyDistance' :
                       type.includes('体重') ? 'weight' :
                       type.includes('前傾') ? 'forwardLean' :
                       type.includes('前後バランス') ? 'frontBackBalance' :
                       type.includes('体の向き') ? 'bodyDirection' :
                       type.includes('背骨') ? 'backCurvature' : 'ballPosition';
            
            const categoryComments = comments[key];
            
            if (score >= 90) return categoryComments.excellent;
            
            // 90点未満の場合は必ず詳細なコメントを生成（モバイル対応強化）
            if (score < 90) {
                console.log('🔍 詳細コメント生成開始（90点未満）:', score, type, key);
                console.log('📱 モバイル対応：詳細コメント必須生成');
                
                // 詳細コメント生成
                let detailedComment = generateDetailedLowScoreComment(score, type, key);
                console.log('📝 詳細コメント結果:', detailedComment);
                
                if (detailedComment) {
                    console.log('✅ 詳細コメント返却成功');
                    return detailedComment;
                }
                
                // フォールバック：強制的に詳細コメント生成（モバイル用）
                console.error('❌ 詳細コメント生成失敗 - 強制フォールバック実行');
                return generateMobileDetailedComment(score, type, key);
            }
            
            return categoryComments.poor || '改善が必要です。';
        }

        // モバイル専用詳細コメント生成（確実表示）
        function generateMobileDetailedComment(score, type, key) {
            console.log('🔥 モバイル専用フォールバック関数実行:', score, type, key);
            
            // 具体的な現状を取得
            let specificStatus = '問題が検出されました';
            if (detailedAnalysisData && detailedAnalysisData[key]) {
                const data = detailedAnalysisData[key];
                specificStatus = generateSpecificCurrentStatus(key, data, score);
            }
            
            // 具体的現状を使用した詳細コメント
            const mobileComments = {
                'ballPosition': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> クラブに適した位置に置くことが大切です<br><strong>改善方法:</strong> ボールの位置を調整してください`,
                'forwardLean': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 適切な前傾角度を保つことが重要です<br><strong>改善方法:</strong> 股関節から前傾し背筋を伸ばしてください`,
                'stance': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 肩幅～肩幅の1.2倍程度が理想です<br><strong>改善方法:</strong> 足の位置を調整してください`,
                'headPosition': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> ボールの真上が理想位置です<br><strong>改善方法:</strong> 頭の位置を調整してください`,
                'handPosition': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 左太ももの内側が理想です<br><strong>改善方法:</strong> 手の位置を調整してください`,
                'weight': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 左右均等が理想です<br><strong>改善方法:</strong> バランスを整えてください`,
                'handBodyDistance': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 適度な間隔を保つことが大切です<br><strong>改善方法:</strong> 手の位置を調整してください`,
                'frontBackBalance': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 拇指球寄りが理想です<br><strong>改善方法:</strong> 重心を調整してください`,
                'bodyDirection': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 目標方向と平行が理想です<br><strong>改善方法:</strong> 体の向きを調整してください`,
                'backCurvature': `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 自然なS字カーブが理想です<br><strong>改善方法:</strong> 姿勢を調整してください`
            };
            
            const comment = mobileComments[key] || `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 正しいフォームが重要です<br><strong>改善方法:</strong> 基本姿勢を見直してください`;
            console.log('📱 モバイル用コメント生成完了:', comment.substring(0, 30) + '...');
            return comment;
        }
        
        // 現在の状態を具体的に説明する関数
        function generateSpecificCurrentStatus(analysisKey, data, score) {
            console.log('🔎 具体的現状生成:', analysisKey, data);
            
            if (analysisKey === 'ballPosition') {
                const deviationPercent = Math.abs(Math.round(data.difference * 100));
                if (data.isLeftTooMuch) {
                    if (deviationPercent > 15) {
                        return `ボールが理想より左に${deviationPercent}%大きくズれています（非常に左寄り）`;
                    } else if (deviationPercent > 8) {
                        return `ボールが理想より左に${deviationPercent}%ズれています（明らかに左寄り）`;
                    } else {
                        return `ボールが理想より左に${deviationPercent}%少しズれています（やや左寄り）`;
                    }
                } else if (data.isRightTooMuch) {
                    if (deviationPercent > 15) {
                        return `ボールが理想より右に${deviationPercent}%大きくズれています（非常に右寄り）`;
                    } else if (deviationPercent > 8) {
                        return `ボールが理想より右に${deviationPercent}%ズれています（明らかに右寄り）`;
                    } else {
                        return `ボールが理想より右に${deviationPercent}%少しズれています（やや右寄り）`;
                    }
                }
            } else if (analysisKey === 'stance') {
                const currentRatio = data.currentRatio.toFixed(1);
                const idealRatio = data.idealRatio.toFixed(1);
                const ratioDeviation = Math.abs(data.currentRatio - data.idealRatio).toFixed(1);
                
                if (data.isTooWide) {
                    if (ratioDeviation > 0.3) {
                        return `スタンスが肩幅の${currentRatio}倍で非常に幅すぎます（理想${idealRatio}倍より${ratioDeviation}倍幅い）`;
                    } else if (ratioDeviation > 0.15) {
                        return `スタンスが肩幅の${currentRatio}倍で明らかに幅すぎます（理想${idealRatio}倍より${ratioDeviation}倍幅い）`;
                    } else {
                        return `スタンスが肩幅の${currentRatio}倍でやや幅すぎます（理想${idealRatio}倍より${ratioDeviation}倍幅い）`;
                    }
                } else if (data.isTooNarrow) {
                    if (ratioDeviation > 0.3) {
                        return `スタンスが肩幅の${currentRatio}倍で非常に狭すぎます（理想${idealRatio}倍より${ratioDeviation}倍狭い）`;
                    } else if (ratioDeviation > 0.15) {
                        return `スタンスが肩幅の${currentRatio}倍で明らかに狭すぎます（理想${idealRatio}倍より${ratioDeviation}倍狭い）`;
                    } else {
                        return `スタンスが肩幅の${currentRatio}倍でやや狭すぎます（理想${idealRatio}倍より${ratioDeviation}倍狭い）`;
                    }
                }
            } else if (analysisKey === 'handPosition') {
                const handDeviation = Math.abs(Math.round(data.difference * 100));
                if (data.isLeftTooMuch) {
                    if (handDeviation > 10) {
                        return `手が理想より左に${handDeviation}%大きくズれています（非常に左寄り）`;
                    } else if (handDeviation > 5) {
                        return `手が理想より左に${handDeviation}%ズれています（明らかに左寄り）`;
                    } else {
                        return `手が理想より左に${handDeviation}%少しズれています（やや左寄り）`;
                    }
                } else if (data.isRightTooMuch) {
                    if (handDeviation > 10) {
                        return `手が理想より右に${handDeviation}%大きくズれています（非常に右寄り）`;
                    } else if (handDeviation > 5) {
                        return `手が理想より右に${handDeviation}%ズれています（明らかに右寄り）`;
                    } else {
                        return `手が理想より右に${handDeviation}%少しズれています（やや右寄り）`;
                    }
                }
            } else if (analysisKey === 'headPosition') {
                // 数字は出さず方向のみを明示
                if (data.isLeftTooMuch) {
                    return '頭が左に寄りすぎています。ボールの真上〜やや後方を意識しましょう。';
                } else if (data.isRightTooMuch) {
                    return '頭が右に寄りすぎています。ボールの真上〜やや後方を意識しましょう。';
                }
            } else if (analysisKey === 'weight') {
                // 数字は出さず、左右の偏りを明示
                if (data.isRightHeavy) {
                    return '右重心に偏っています。左右均等になるように調整しましょう。';
                } else if (data.isLeftHeavy) {
                    return '左重心に偏っています。左右均等になるように調整しましょう。';
                }
            } else if (analysisKey === 'forwardLean' && data) {
                // 数字を出さずに定性的に表現
                if (data.isTooDeep) {
                    return '前傾が深すぎます。もう少し上体を起こし、股関節からの前傾を整えましょう。';
                } else if (data.isTooShallow) {
                    return '前傾が浅すぎます。股関節からもう少し深く前傾しましょう。';
                } else {
                    return '概ね適切です。背筋を伸ばし、股関節から自然な前傾を保ちましょう。';
                }
            } else if (analysisKey === 'handBodyDistance' && data) {
                // 数字は使わず、定性的コメントのみ
                if (data.isTooFar) {
                    return '手が体から遠すぎます。もう少し体に近づけ、腕に軽い余裕が出る位置にしましょう。';
                } else if (data.isTooClose) {
                    return '手が体に近すぎます。もう少し体から離して、腕に自然なゆとりを作りましょう。';
                } else {
                    return '概ね適切です。腕に軽い余裕を保ち、力みのないアドレスを意識しましょう。';
                }
            } else if (analysisKey === 'frontBackBalance' && data.currentBalance !== undefined) {
                // 数字なしの方向指示
                if (data.isTooForward) {
                    return 'つま先重心に寄りすぎています。拇指球〜土踏まずに重心を整えましょう。';
                } else if (data.isTooBackward) {
                    return 'かかと重心に寄りすぎています。拇指球〜土踏まずに重心を整えましょう。';
                }
            } else if (analysisKey === 'bodyDirection' && data && (data.shoulderState || data.hipState || data.heelState)) {
                // 肩・腰・かかとのオープン/クローズを明示（数値は出さない）
                const label = (s) => s === 'open' ? 'オープン' : (s === 'closed' ? 'クローズ' : 'スクエア');
                const parts = [];
                if (data.shoulderState) parts.push(`肩は${label(data.shoulderState)}`);
                if (data.hipState) parts.push(`腰は${label(data.hipState)}`);
                if (data.heelState) parts.push(`かかとは${label(data.heelState)}`);
                if (parts.length === 0) return '体の向きは概ねスクエアです。目標ラインと平行を維持しましょう。';
                return parts.join('、') + '。目標ラインと平行に整えましょう。';
            } else if (analysisKey === 'bodyDirection' && data.currentAngle !== undefined) {
                const angleDeviation = Math.abs(Math.round(data.currentAngle));
                if (data.isOpenToTarget) {
                    if (angleDeviation > 15) {
                        return `体が目標より非常に大きく開いています（${angleDeviation}°開いている）`;
                    } else if (angleDeviation > 8) {
                        return `体が目標より明らかに開いています（${angleDeviation}°開いている）`;
                    } else {
                        return `体が目標よりやや開いています（${angleDeviation}°開いている）`;
                    }
                } else if (data.isClosedToTarget) {
                    if (angleDeviation > 15) {
                        return `体が目標より非常に大きく閉じています（${angleDeviation}°閉じている）`;
                    } else if (angleDeviation > 8) {
                        return `体が目標より明らかに閉じています（${angleDeviation}°閉じている）`;
                    } else {
                        return `体が目標よりやや閉じています（${angleDeviation}°閉じている）`;
                    }
                }
            } else if (analysisKey === 'backCurvature' && data.curvatureRatio !== undefined) {
                const curvaturePercent = Math.round(data.curvatureRatio * 100);
                if (data.isTooArched) {
                    if (curvaturePercent > 8) {
                        return `背中が非常に大きく反りすぎています（反り度${curvaturePercent}%）`;
                    } else if (curvaturePercent > 5) {
                        return `背中が明らかに反りすぎています（反り度${curvaturePercent}%）`;
                    } else {
                        return `背中がやや反りすぎています（反り度${curvaturePercent}%）`;
                    }
                } else if (data.isTooRounded) {
                    if (curvaturePercent > 8) {
                        return `背中が非常に大きく丸まりすぎています（丸み度${curvaturePercent}%）`;
                    } else if (curvaturePercent > 5) {
                        return `背中が明らかに丸まりすぎています（丸み度${curvaturePercent}%）`;
                    } else {
                        return `背中がやや丸まりすぎています（丸み度${curvaturePercent}%）`;
                    }
                } else if (data.isTooStraight) {
                    return `背中が真っすぐすぎて自然な曲線がありません（曲線度${curvaturePercent}%）`;
                }
            }
            
            // その他のカテゴリのスコア別コメント
            if (score < 60) {
                return '非常に大きな問題があります';
            } else if (score < 70) {
                return '明らかな問題があります';
            } else if (score < 80) {
                return '改善が必要です';
            } else {
                return '軽微なズレがあります';
            }
        }

        // 90点以下の詳細コメント生成（モバイル対応）
        function generateDetailedLowScoreComment(score, type, key) {
            const clubSelect = document.getElementById('clubSelect');
            const selectedClub = clubSelect ? clubSelect.value : 'driver';
            
            const clubNames = {
                'driver': 'ドライバー',
                'fairway': 'フェアウェイウッド',
                'utility': 'ユーティリティ',
                'iron4': '4番アイアン',
                'iron5': '5番アイアン', 
                'iron6': '6番アイアン',
                'iron7': '7番アイアン',
                'iron8': '8番アイアン',
                'iron9': '9番アイアン',
                'wedge': 'ウェッジ'
            };
            
            const clubName = clubNames[selectedClub] || selectedClub;
            
            if (key === 'ballPosition') {
                const idealPositions = {
                    'driver': '左足かかと内側',
                    'fairway': 'ドライバーより1個右',
                    'utility': 'ドライバーより1個右',
                    'iron4': 'センターより少し左',
                    'iron5': 'センターより少し左',
                    'iron6': 'センターより少し左',
                    'iron7': 'センターより少し左',
                    'iron8': '両足センター',
                    'iron9': '両足センター',
                    'wedge': '両足センター'
                };
                
                return `<strong>現状：</strong>ボール位置が理想位置からずれています。<br>
                        <strong>理想：</strong>${clubName}は${idealPositions[selectedClub] || '適切な位置'}が理想です。<br>
                        <strong>改善方法：</strong>ボールの位置を理想位置に調整してください。正しい位置に置くことで、クラブの性能を最大限に発揮できます。`;
            }
            
            if (key === 'forwardLean') {
                const idealAngles = {
                    'driver': '15度',
                    'fairway': '18度',
                    'utility': '20度',
                    'iron4': '22度',
                    'iron5': '24度',
                    'iron6': '26度',
                    'iron7': '28度',
                    'iron8': '30度',
                    'iron9': '32度',
                    'wedge': '35度'
                };
                
                return `<strong>現状：</strong>前傾が理想から大きくずれています。<br>
                        <strong>理想：</strong>ドライバーは浅め、クラブが短いほど徐々に深く、ウェッジで最も深い前傾が理想です。<br>
                        <strong>改善方法：</strong>股関節から適切に前傾し、背筋をまっすぐに保ってください。`;
            }
            
            if (key === 'stance') {
                return `<strong>現状：</strong>スタンス幅が理想から大きくずれています。<br>
                        <strong>理想：</strong>肩幅の1.2倍程度が理想です。<br>
                        <strong>改善方法：</strong>足の位置を調整して適切なスタンス幅を作ってください。正しいスタンスにより、バランスの取れたスイングが可能になります。`;
            }
            
            if (key === 'headPosition') {
                return `<strong>現状：</strong>頭の位置が適正位置からずれています。<br>
                        <strong>理想：</strong>ボールの真上またはやや後方に頭を配置するのが理想です。<br>
                        <strong>改善方法：</strong>頭の位置をボールの真上に調整し、背骨をまっすぐに保ってください。正しい頭の位置によりバランスの取れたスイングが可能になります。`;
            }
            
            if (key === 'handPosition') {
                return `<strong>現状：</strong>手の位置が理想位置からずれています。<br>
                        <strong>理想：</strong>手は左太ももの内側に位置するのが理想です。<br>
                        <strong>改善方法：</strong>手の位置を左太ももの内側に調整し、自然なハンドファーストを作ってください。正しい手の位置により安定したインパクトが得られます。`;
            }
            
            if (key === 'weight') {
                return `<strong>現状：</strong>体重配分が理想から偏っています。<br>
                        <strong>理想：</strong>左右の足に均等に体重を配分するのが理想です。<br>
                        <strong>改善方法：</strong>両足にバランス良く体重をかけ、安定したスタンスを作ってください。正しい体重配分により安定したスイングが可能になります。`;
            }
            
            if (key === 'handBodyDistance') {
                return `<strong>現状：</strong>手と体の距離が適正範囲から外れています。<br>
                        <strong>理想：</strong>手と体の間に適度な間隔を保つのが理想です。<br>
                        <strong>改善方法：</strong>手を体から適度に離し、腕に余裕を持たせてください。正しい距離により自然なスイングプレーンが作れます。`;
            }
            
            if (key === 'frontBackBalance') {
                return `<strong>現状：</strong>前後の重心バランスが理想から偏っています。<br>
                        <strong>理想：</strong>やや拇指球寄りに重心を置くのが理想です。<br>
                        <strong>改善方法：</strong>重心を適切な位置に調整し、安定した構えを作ってください。正しいバランスによりパワフルなスイングが可能になります。`;
            }
            
            if (key === 'bodyDirection') {
                return `<strong>現状：</strong>体の向きが目標方向からずれています。<br>
                        <strong>理想：</strong>肩と腰のラインが目標と平行になるのが理想です。<br>
                        <strong>改善方法：</strong>肩と腰を目標ラインと平行に調整してください。正しい体の向きにより狙った方向への飛球が可能になります。`;
            }
            
            if (key === 'backCurvature') {
                return `<strong>現状：</strong>背中の曲がり具合が理想から外れています。<br>
                        <strong>理想：</strong>背骨を自然なS字カーブに保つのが理想です。<br>
                        <strong>改善方法：</strong>胸を張り、背筋をまっすぐに保ちながら股関節から前傾してください。正しい姿勢により効率的なスイングが可能になります。`;
            }
            
            return null;
        }

        // 詳細結果表示
        function displayDetailedResults(scores) {
            const grid = document.getElementById('scoreFeedbackGrid');
            const viewType = document.getElementById('viewSelect').value;
            
            // 視点に応じたスコア項目とラベルを動的に設定
            let scoreItems = [];
            let scoreValues = [];
            
            if (viewType === 'front') {
                scoreItems = [
                    {label: '🎯 ボール位置', value: scores.ballPosition},
                    {label: '🦵 スタンス幅', value: scores.stance},
                    {label: '👤 頭の位置', value: scores.headPosition},
                    {label: '🤚 手の位置', value: scores.handPosition},
                    {label: '⚖️ 体重配分', value: scores.weight}
                ];
            } else { // rear
                scoreItems = [
                    {label: '⬇️ 前傾角度', value: scores.forwardLean},
                    {label: '📏 手と体の距離', value: scores.handBodyDistance},
                    {label: '⚖️ 前後バランス', value: scores.frontBackBalance},
                    {label: '🧭 体の向き', value: scores.bodyDirection},
                    {label: '🔄 背中の曲がり具合', value: scores.backCurvature}
                ];
            }
            
            // 総合スコア計算
            const totalScore = Math.round(scoreItems.reduce((sum, item) => sum + item.value, 0) / scoreItems.length);
            
            console.log('詳細結果表示:', scores, '視点:', viewType);
            
            // MediaPipe使用時のステータス表示
            const analysisMethod = mediaPipeReady && currentResults && currentResults.poseLandmarks ? 
                'AI姿勢分析により高精度な診断を実行しました' : 
                '基本分析モードで診断を実行しました';
            
            // スコア項目のHTML生成（分析キーを含む）
            let scoreItemsHTML = '';
            if (viewType === 'front') {
                scoreItemsHTML = `
                    ${createDetailedScoreItem('🎯 ボール位置', scores.ballPosition, 'ballPosition')}
                    ${createDetailedScoreItem('🦵 スタンス幅', scores.stance, 'stance')}
                    ${createDetailedScoreItem('👤 頭の位置', scores.headPosition, 'headPosition')}
                    ${createDetailedScoreItem('🤚 手の位置', scores.handPosition, 'handPosition')}
                    ${createDetailedScoreItem('⚖️ 体重配分', scores.weight, 'weight')}
                `;
            } else { // rear
                scoreItemsHTML = `
                    ${createDetailedScoreItem('⬇️ 前傾角度', scores.forwardLean, 'forwardLean')}
                    ${createDetailedScoreItem('📏 手と体の距離', scores.handBodyDistance, 'handBodyDistance')}
                    ${createDetailedScoreItem('⚖️ 前後バランス', scores.frontBackBalance, 'frontBackBalance')}
                    ${createDetailedScoreItem('🧭 体の向き', scores.bodyDirection, 'bodyDirection')}
                    ${createDetailedScoreItem('🔄 背中の曲がり具合', scores.backCurvature, 'backCurvature')}
                `;
            }
            
            grid.innerHTML = `
                <div class="score-item" style="grid-column: 1 / -1; background: #e8f5e8; border-left: 4px solid #28a745;">
                    <p style="margin: 0; color: #155724; font-weight: bold;">📊 ${analysisMethod}</p>
                </div>
                ${scoreItemsHTML}
                <div class="score-item" style="grid-column: 1 / -1; text-align: center; background: linear-gradient(45deg, #2E86AB, #A23B72); color: white; border: 3px solid #ffffff; box-shadow: 0 8px 25px rgba(0,0,0,0.3);">
                    <h4 style="color: #FFFFFF; font-size: 1.6em; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">📊 総合スコア</h4>
                    <div class="score-display" style="color: #FFFFFF; font-size: 3.5em; font-weight: bold; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); margin: 20px 0;">${totalScore}点</div>
                    <div class="feedback-text" style="color: #FFFFFF; font-size: 1.3em; margin-top: 20px; line-height: 1.5; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                        ${generateOverallComment(totalScore)}
                    </div>
                </div>
            `;
        }
        
        // 総合コメント生成
        function generateOverallComment(totalScore) {
            if (totalScore >= 90) {
                return '素晴らしいアドレスです！プロレベルの構えができています。この調子で練習を続けてください。';
            } else if (totalScore >= 80) {
                return 'とても良いアドレスです。上記の微調整でさらに向上できます。';
            } else if (totalScore >= 70) {
                return '基本的な部分は良好です。上記の改善点を意識して練習してください。';
            } else {
                return '改善の余地があります。上記の具体的なアドバイスに従って基本的なアドレスを見直してください。';
            }
        }

        // 詳細スコアアイテム作成（モバイル対応強化）
        function createDetailedScoreItem(title, score, analysisKey) {
            console.log('🔄 createDetailedScoreItem実行:', title, score, analysisKey);
            
            const scoreClass = score >= 90 ? 'score-90plus' : 
                              score >= 80 ? 'score-80plus' : 
                              score >= 70 ? 'score-70plus' : 'score-below70';
            
            // 90点以下で確実に詳細コメントを生成（スマホ対応）
            let detailedFeedback = '';
            if (score < 90) {
                console.log('📱 90点未満検出 - 詳細コメント強制生成:', score);
                
                // 詳細分析データから具体的な現状を取得
                let specificStatus = '問題が検出されました';
                if (detailedAnalysisData && detailedAnalysisData[analysisKey]) {
                    const data = detailedAnalysisData[analysisKey];
                    specificStatus = generateSpecificCurrentStatus(analysisKey, data, score);
                }
                // なお具体文が得られない場合はカテゴリ別の方向指示を用意
                if (!specificStatus || specificStatus === '問題が検出されました') {
                    if (analysisKey === 'ballPosition') {
                        if (ballPosition) {
                            const dir = ballPosition.x < 0.5 ? '右' : '左';
                            specificStatus = `ボール位置がやや${dir}寄りです`;
                        } else {
                            specificStatus = 'ボール位置の設定が必要です（画像上でタップ）';
                        }
                    } else if (analysisKey === 'stance') {
                        specificStatus = score < 80 ? 'スタンスが広すぎます' : 'スタンスが狭すぎます';
                    } else if (analysisKey === 'headPosition') {
                        specificStatus = '頭の位置が中心からずれています（ボールの真上〜やや後方が理想）';
                    } else if (analysisKey === 'handPosition') {
                        specificStatus = '手の位置が適正からずれています（左太もも内側が目安）';
                    } else if (analysisKey === 'weight') {
                        specificStatus = score < 80 ? '左足に寄りすぎです' : '右足に寄りすぎです';
                    } else if (analysisKey === 'forwardLean') {
                        specificStatus = score < 80 ? '前傾が浅すぎます' : '前傾が深すぎます';
                    } else if (analysisKey === 'handBodyDistance') {
                        specificStatus = score < 80 ? '手が体から遠すぎます' : '手が体に近すぎます';
                    } else if (analysisKey === 'frontBackBalance') {
                        specificStatus = score < 80 ? '重心がつま先寄りです' : '重心がかかと寄りです';
                    } else if (analysisKey === 'bodyDirection') {
                        specificStatus = '体の向きが目標からずれています';
                    } else if (analysisKey === 'backCurvature') {
                        specificStatus = '背中のカーブが不自然です';
                    }
                }
                
                // 各カテゴリごとに具体的な現状を取得してコメントを生成
                const mobileDetailedComments = {};
                
                if (analysisKey === 'ballPosition') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> クラブに適した位置に配置することが重要です<br><strong>改善方法:</strong> ボールの位置を理想位置に調整してください`;
                } else if (analysisKey === 'stance') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 肩幅の1.2倍程度が理想的です<br><strong>改善方法:</strong> 足の位置を調整して適切なスタンス幅を作ってください`;
                } else if (analysisKey === 'headPosition') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> ボールの真上またはやや後方が理想です<br><strong>改善方法:</strong> 頭の位置をボールの真上に調整してください`;
                } else if (analysisKey === 'handPosition') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 左太ももの内側が理想的です<br><strong>改善方法:</strong> 手の位置を左太ももの内側に調整してください`;
                } else if (analysisKey === 'weight') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 左右の足に均等に配分することが大切です<br><strong>改善方法:</strong> 両足にバランスよく体重をかけてください`;
                } else if (analysisKey === 'forwardLean') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 適切な前傾角度を保つことが重要です<br><strong>改善方法:</strong> 股関節から前傾し、背筋をまっすぐに保ってください`;
                } else if (analysisKey === 'handBodyDistance') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 適度な間隔を保つことが大切です<br><strong>改善方法:</strong> 手を体から適度に離し、腕に余裕を持たせてください`;
                } else if (analysisKey === 'frontBackBalance') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> やや拇指球寄りに重心を置くのが理想です<br><strong>改善方法:</strong> 重心を適切な位置に調整してください`;
                } else if (analysisKey === 'bodyDirection') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 肩と腰のラインが目標と平行になることが大切です<br><strong>改善方法:</strong> 肩と腰を目標ラインと平行に調整してください`;
                } else if (analysisKey === 'backCurvature') {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 自然なS字カーブが理想です<br><strong>改善方法:</strong> 姿勢を調整してください`;
                } else {
                    mobileDetailedComments[analysisKey] = `<strong>現状:</strong> ${specificStatus}<br><strong>理想:</strong> 正しいフォームが重要です<br><strong>改善方法:</strong> 基本姿勢を見直してください`;
                }
                
                detailedFeedback = mobileDetailedComments[analysisKey] || '<strong>現状:</strong> 改善が必要です<br><strong>理想:</strong> 正しいフォームが重要です<br><strong>改善方法:</strong> 基本姿勢を見直してください';
                console.log('✅ モバイル詳細コメント生成完了:', detailedFeedback.substring(0, 30) + '...');
            } else {
                // 90点以上の場合
                detailedFeedback = `理想的な${title.replace(/🎯|🦵|👤|🤚|⚖️|⬇️|📏|🧭|🔄/g, '')}です。現在の設定で優れた結果が出ています。`;
                console.log('✅ 90点以上コメント生成完了');
            }
            
            return `
                <div class="score-item" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <h4>${title}</h4>
                    <div class="score-display ${scoreClass}">${score}点</div>
                    <div class="feedback-text" style="display: block !important; visibility: visible !important; opacity: 1 !important; line-height: 1.8 !important; font-size: 15px !important; margin-top: 12px !important; padding: 10px !important; background-color: rgba(255, 255, 255, 0.9) !important; border-radius: 8px !important; border-left: 4px solid #007bff !important; color: #333 !important;">${detailedFeedback}</div>
                </div>
            `;
        }

        // MediaPipe初期化（モバイル対応強化版）
        function initMediaPipe() {
            console.log('MediaPipe初期化開始...', {
                userAgent: navigator.userAgent,
                isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                windowWidth: window.innerWidth
            });

            return new Promise((resolve, reject) => {
                // モバイルデバイスの検出
                const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

                // MediaPipeライブラリの読み込み確認
                const checkLibraries = () => {
                    try {
                        return (typeof Pose !== 'undefined' &&
                                typeof drawConnectors !== 'undefined' &&
                                typeof drawLandmarks !== 'undefined' &&
                                typeof POSE_CONNECTIONS !== 'undefined');
                    } catch (e) {
                        console.warn('ライブラリ確認エラー:', e);
                        return false;
                    }
                };

                // モバイルの場合は待機時間を延長
                const maxAttempts = isMobile ? 100 : 50; // モバイル10秒、PC5秒
                let attempts = 0;

                const checkInterval = setInterval(() => {
                    attempts++;

                    if (checkLibraries()) {
                        clearInterval(checkInterval);

                        try {
                            pose = new Pose({
                                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
                            });

                            // モバイル用の軽量設定
                            const options = isMobile ? {
                                modelComplexity: 0, // モバイルは軽量モデル
                                smoothLandmarks: false, // スムージング無効
                                enableSegmentation: false, // セグメンテーション無効
                                minDetectionConfidence: 0.7, // 検出閾値高め
                                minTrackingConfidence: 0.7
                            } : {
                                modelComplexity: 1,
                                smoothLandmarks: true,
                                minDetectionConfidence: 0.5,
                                minTrackingConfidence: 0.5
                            };

                            console.log('MediaPipe設定:', options);
                            pose.setOptions(options);
                            pose.onResults(onPoseResults);

                            mediaPipeReady = true;
                            console.log('✅ MediaPipe初期化完了 - モバイル:', isMobile);
                            resolve(true);

                        } catch (error) {
                            console.error('MediaPipe初期化エラー:', error);
                            mediaPipeReady = false;
                            // モバイルでエラーの場合はフォールバックモード
                            if (isMobile) {
                                console.warn('モバイルフォールバックモード有効');
                            }
                            resolve(false);
                        }

                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.warn('MediaPipe初期化タイムアウト - 試行回数:', attempts);
                        mediaPipeReady = false;
                        resolve(false);
                    }

                    // 進捗表示（モバイル用）
                    if (attempts % 10 === 0) {
                        console.log(`MediaPipe初期化中... ${attempts}/${maxAttempts}`);
                    }
                }, 100);
            });
        }

        // MediaPipeの結果処理
        function onPoseResults(results) {
            console.log('MediaPipe結果取得:', results.poseLandmarks ? '成功' : '失敗');
            currentResults = results;
            
            const canvas = document.getElementById('poseCanvas');
            if (!canvas || !uploadedImage) return;
            
            const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const viewType = document.getElementById('viewSelect').value;
            console.log('現在の撮影視点:', viewType);
            
            // MediaPipeの姿勢ランドマークを描画（すべての視点で表示）
            if (results.poseLandmarks) {
                try {
                    // 完全書き直し：診断時モバイル対応MediaPipe描画
                    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
                    console.log('🔍 診断MediaPipe描画開始 - モバイル:', isMobile, '視点:', viewType, 'ウィンドウ幅:', window.innerWidth);
                    console.log('🔍 診断Canvas詳細:', {
                        width: canvas.width,
                        height: canvas.height,
                        clientWidth: canvas.clientWidth, 
                        clientHeight: canvas.clientHeight,
                        landmarks: results.poseLandmarks.length
                    });
                    
                    // canvasの状態を完全リセット（iOS対応）
                    // ここでは追加のスケールはかけず、デバイスピクセル座標で直接描画する
                    resetTransformSafe(ctx);
                    
                    // 常に手動で主要なポーズライン描画（座標系の不一致を回避）
                    {
                        console.log('🔄 MediaPipe公式メソッド未利用 - 手動描画開始');
                        
                        // フォールバック：手動で主要なポーズライン描画
                        const landmarks = results.poseLandmarks;
                        
                        // モバイル用の設定
                        ctx.strokeStyle = '#00FF00';
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        
                        // 肩の線（11-12）
                        if (landmarks[11] && landmarks[12]) {
                            ctx.beginPath();
                            ctx.moveTo(landmarks[11].x * canvas.width, landmarks[11].y * canvas.height);
                            ctx.lineTo(landmarks[12].x * canvas.width, landmarks[12].y * canvas.height);
                            ctx.stroke();
                        }
                        
                        // 腰の線（23-24）
                        if (landmarks[23] && landmarks[24]) {
                            ctx.beginPath();
                            ctx.moveTo(landmarks[23].x * canvas.width, landmarks[23].y * canvas.height);
                            ctx.lineTo(landmarks[24].x * canvas.width, landmarks[24].y * canvas.height);
                            ctx.stroke();
                        }
                        
                        // 体の中心線（肩の中点から腰の中点）
                        if (landmarks[11] && landmarks[12] && landmarks[23] && landmarks[24]) {
                            const shoulderCenterX = (landmarks[11].x + landmarks[12].x) / 2 * canvas.width;
                            const shoulderCenterY = (landmarks[11].y + landmarks[12].y) / 2 * canvas.height;
                            const hipCenterX = (landmarks[23].x + landmarks[24].x) / 2 * canvas.width;
                            const hipCenterY = (landmarks[23].y + landmarks[24].y) / 2 * canvas.height;
                            
                            ctx.beginPath();
                            ctx.moveTo(shoulderCenterX, shoulderCenterY);
                            ctx.lineTo(hipCenterX, hipCenterY);
                            ctx.stroke();
                        }
                        
                        // 足の線（27-28, 31-32）
                        if (landmarks[27] && landmarks[28]) {
                            ctx.beginPath();
                            ctx.moveTo(landmarks[27].x * canvas.width, landmarks[27].y * canvas.height);
                            ctx.lineTo(landmarks[28].x * canvas.width, landmarks[28].y * canvas.height);
                            ctx.stroke();
                        }
                        
                        // ランドマークポイントも描画（頭部を含む）
                        ctx.fillStyle = '#FF0000';
                        const radius = (window.innerWidth < 768) ? 2 : 4;

                        [0,1,2,3,4,5,7,8,9,10, 11,12,23,24,27,28].forEach(index => {
                            if (landmarks[index]) {
                                ctx.beginPath();
                                ctx.arc(
                                    landmarks[index].x * canvas.width,
                                    landmarks[index].y * canvas.height,
                                    radius,
                                    0,
                                    2 * Math.PI
                                );
                                ctx.fill();
                            }
                        });
                        
                        console.log('🔄 手動描画完了');
                    }
                    
                    // 仕上げの設定（既に手動描画済みのためここでは何もしない）
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.globalAlpha = 1.0;
                    
                    // 重要な骨格線を手動で描画（確実に表示）
                    const keyConnections = [
                        // 上半身の主要線
                        [11, 12], // 左右肩
                        [11, 13], [13, 15], // 左腕
                        [12, 14], [14, 16], // 右腕
                        [11, 23], [12, 24], // 肩から腰
                        [23, 24], // 腰の横線
                        // 下半身の主要線
                        [23, 25], [25, 27], // 左脚
                        [24, 26], [26, 28]  // 右脚
                    ];
                    
                    const isAndroid2 = /Android/i.test(navigator.userAgent);
                    const visThreshold2 = ((isAndroid2 || isMobile || window.innerWidth < 768) && viewType === 'front') ? 0.2 : 0.5;
                    let linesDrawn = 0;
                    keyConnections.forEach(([startIdx, endIdx]) => {
                        const startPoint = results.poseLandmarks[startIdx];
                        const endPoint = results.poseLandmarks[endIdx];
                        
                        if (startPoint && endPoint &&
                            (startPoint.visibility === undefined || startPoint.visibility >= visThreshold2) &&
                            (endPoint.visibility === undefined || endPoint.visibility >= visThreshold2)) {
                            const startX = startPoint.x * canvas.width;
                            const startY = startPoint.y * canvas.height;
                            const endX = endPoint.x * canvas.width;
                            const endY = endPoint.y * canvas.height;
                            
                            ctx.beginPath();
                            ctx.moveTo(startX, startY);
                            ctx.lineTo(endX, endY);
                            ctx.stroke();
                            linesDrawn++;
                        }
                    });
                    
                    // 重要なポイントを巨大で目立つ円で描画
                    if (isMobile || window.innerWidth < 768) {
                        ctx.fillStyle = '#FF00FF'; // マゼンタ色（最も目立つ）
                        ctx.shadowColor = '#FFFF00'; // 黄色い影
                        ctx.shadowBlur = 30;
                    } else {
                        ctx.fillStyle = '#FF0000';
                        ctx.shadowColor = 'transparent'; // PC用：影なし
                        ctx.shadowBlur = 0;
                    }
                    const keyPoints = [11, 12, 13, 14, 15, 16, 23, 24, 25, 26, 27, 28];
                    let pointsDrawn = 0;
                    
                    keyPoints.forEach(index => {
                        const point = results.poseLandmarks[index];
                        if (point && (point.visibility === undefined || point.visibility >= visThreshold2)) {
                            const x = point.x * canvas.width;
                            const y = point.y * canvas.height;
                            
                            ctx.beginPath();
                            const radius = (isMobile || window.innerWidth < 768) ? 1 : 4; // スマホ1px、PC4px
                            ctx.arc(x, y, radius, 0, 2 * Math.PI);
                            ctx.fill();
                            pointsDrawn++;
                        }
                    });

                    // Android/モバイル正面でラインが無ければ可視性無視で強制描画
                    if (linesDrawn === 0 && viewType === 'front' && (isAndroid2 || isMobile || window.innerWidth < 768)) {
                        console.log('📱 正面フォールバック(診断): 可視性を無視して主要ラインを強制描画');
                        ctx.save();
                        ctx.strokeStyle = '#00FFFF';
                        ctx.lineWidth = 3;
                        keyConnections.forEach(([a,b]) => {
                            const A = results.poseLandmarks[a];
                            const B = results.poseLandmarks[b];
                            if (A && B) {
                                ctx.beginPath();
                                ctx.moveTo(A.x * canvas.width, A.y * canvas.height);
                                ctx.lineTo(B.x * canvas.width, B.y * canvas.height);
                                ctx.stroke();
                                linesDrawn++;
                            }
                        });
                        ctx.restore();
                    }
                    // 頭部の点とラインを最後に必ず上描き（消失防止）
                    try {
                        const lm = results.poseLandmarks;
                        ctx.save();
                        ctx.strokeStyle = '#00FF00';
                        ctx.fillStyle = '#FF0000';
                        ctx.lineWidth = 2;
                        // 鼻
                        if (lm[0]) { ctx.beginPath(); ctx.arc(lm[0].x*canvas.width, lm[0].y*canvas.height, (window.innerWidth < 768) ? 1 : 4, 0, 2*Math.PI); ctx.fill(); }
                        // 目-目ライン
                        if (lm[2] && lm[5]) { ctx.beginPath(); ctx.moveTo(lm[2].x*canvas.width, lm[2].y*canvas.height); ctx.lineTo(lm[5].x*canvas.width, lm[5].y*canvas.height); ctx.stroke(); }
                        // 耳-耳ライン
                        if (lm[7] && lm[8]) { ctx.beginPath(); ctx.moveTo(lm[7].x*canvas.width, lm[7].y*canvas.height); ctx.lineTo(lm[8].x*canvas.width, lm[8].y*canvas.height); ctx.stroke(); }
                        // 肩中点→鼻
                        if (lm[11] && lm[12] && lm[0]) {
                            const cx = (lm[11].x + lm[12].x)/2 * canvas.width;
                            const cy = (lm[11].y + lm[12].y)/2 * canvas.height;
                            ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(lm[0].x*canvas.width, lm[0].y*canvas.height); ctx.stroke();
                        }
                        ctx.restore();
                    } catch(e) { console.warn('head overlay fail', e); }
                    
                    ctx.restore(); // 設定を復元
                    
                    console.log('✅ 診断MediaPipe描画完了 - 視点:', viewType, '描画線数:', linesDrawn, '描画点数:', pointsDrawn, 'モバイル:', isMobile);
                    
                    // モバイル/Androidで線が見えない場合の緊急措置
                    if ((isMobile || isAndroid2) && linesDrawn === 0) {
                        console.log('⚠️ 診断緊急措置: 強制線描画実行');
                        ctx.strokeStyle = '#FF0000'; // 赤色で強制描画
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.moveTo(100, 100);
                        ctx.lineTo(200, 200);
                        ctx.moveTo(200, 100);
                        ctx.lineTo(100, 200);
                        ctx.stroke();
                        console.log('🔴 診断緊急赤線描画完了');
                    }
                } catch (error) {
                    console.error('描画エラー:', error);
                }
            } else {
                console.log('MediaPipe線描画スキップ - ランドマークなし');
            }
            
            // ボール位置の赤い丸を再描画（正面撮影時のみ・デバイス対応サイズ）
            if (ballPosition && viewType === 'front') {
                const isMobileBallDiag = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
                const ballRadiusDiag = isMobileBallDiag ? 8 : 10; // スマホ8px、PC10px（少し大きく）

                // 正規化 -> デバイスピクセル座標で再描画
                ctx.fillStyle = 'red';
                ctx.beginPath();
                const drawX = ballPosition.x * canvas.width;
                const drawY = ballPosition.y * canvas.height;
                ctx.arc(drawX, drawY, ballRadiusDiag, 0, 2 * Math.PI);
                ctx.fill();
            }
        }

        // 直近の推定結果からオーバーレイを再描画（リサイズ後/診断後に使用）
        function redrawOverlay(){
            const canvas = document.getElementById('poseCanvas');
            if (!canvas || !currentResults || !currentResults.poseLandmarks) return;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const lm = currentResults.poseLandmarks;
                        ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = (window.innerWidth < 768) ? 1 : 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            const line=(a,b)=>{ if(lm[a]&&lm[b]){ ctx.beginPath(); ctx.moveTo(lm[a].x*canvas.width, lm[a].y*canvas.height); ctx.lineTo(lm[b].x*canvas.width, lm[b].y*canvas.height); ctx.stroke(); }}
            [[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]].forEach(p=>line(p[0],p[1]));
            if(lm[11]&&lm[12]&&lm[23]&&lm[24]){
                const sx=(lm[11].x+lm[12].x)/2*canvas.width, sy=(lm[11].y+lm[12].y)/2*canvas.height;
                const hx=(lm[23].x+lm[24].x)/2*canvas.width, hy=(lm[23].y+lm[24].y)/2*canvas.height;
                ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(hx,hy); ctx.stroke();
                if(lm[0]){ ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(lm[0].x*canvas.width, lm[0].y*canvas.height); ctx.stroke(); }
            }
                        ctx.fillStyle = '#FF0000';
            const dot=(i)=>{ if(lm[i]){ ctx.beginPath(); ctx.arc(lm[i].x*canvas.width, lm[i].y*canvas.height, (window.innerWidth<768)?1:4, 0, 2*Math.PI); ctx.fill(); }}
            [0,1,2,3,4,5,7,8,9,10,11,12,13,14,15,16,23,24,25,26,27,28].forEach(dot);
            const viewType = document.getElementById('viewSelect').value;
            if(ballPosition && viewType==='front'){
                ctx.fillStyle='red';
                const r=(window.innerWidth<768)?8:10;
                ctx.beginPath(); ctx.arc(ballPosition.x*canvas.width, ballPosition.y*canvas.height, r, 0, 2*Math.PI); ctx.fill();
            }
        }

        // フォールバックモード用の簡易診断
        function performFallbackAnalysis() {
            console.log('フォールバック診断実行');

            const viewType = document.getElementById('viewSelect').value;
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

            // 基本的なスコア（デフォルト値）
            const fallbackScores = {
                ballPosition: 70,
                stance: 75,
                posture: 70,
                armPosition: 65,
                weightDistribution: 70,
                headPosition: 75
            };

            // モバイル用のメッセージ
            const fallbackComments = {
                ballPosition: 'MediaPipe未対応：手動でボール位置を調整してください',
                stance: 'MediaPipe未対応：足幅を肩幅程度に保ちましょう',
                posture: 'MediaPipe未対応：背筋を伸ばし前傾を意識してください',
                armPosition: isMobile ? 'モバイル診断：腕は自然に垂らしましょう' : '腕の位置を確認してください',
                weightDistribution: 'MediaPipe未対応：体重を均等に分散させましょう',
                headPosition: 'MediaPipe未対応：頭は動かさず正面を向きましょう'
            };

            // フォールバック用の総合スコア表示
            const averageScore = Math.round(Object.values(fallbackScores).reduce((a, b) => a + b, 0) / Object.keys(fallbackScores).length);

            document.getElementById('overallScore').textContent = `総合スコア: ${averageScore}点（フォールバックモード）`;

            // 詳細コメント表示
            const detailsDiv = document.getElementById('analysisDetails');
            if (detailsDiv) {
                detailsDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px;">
                        <h4>📱 モバイル・フォールバックモード</h4>
                        <p>MediaPipeが利用できません。手動での調整をお試しください。</p>
                    </div>
                    ${Object.entries(fallbackComments).map(([key, comment]) =>
                        `<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px;">
                            <strong>${getJapaneseLabel(key)}:</strong> ${comment}
                        </div>`
                    ).join('')}
                `;
            }

            return fallbackScores;
        }

        // 日本語ラベル取得
        function getJapaneseLabel(key) {
            const labels = {
                ballPosition: 'ボール位置',
                stance: 'スタンス',
                posture: '姿勢',
                armPosition: '腕の位置',
                weightDistribution: '体重配分',
                headPosition: '頭の位置'
            };
            return labels[key] || key;
        }

        // 初期化（モバイル対応強化版）
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ページ読み込み完了 - 初期化開始');

            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
            console.log('デバイス情報:', { isMobile, userAgent: navigator.userAgent, windowWidth: window.innerWidth });

            // モバイル用の初期メッセージ表示
            if (isMobile) {
                const statusDiv = document.querySelector('.status-info');
                if (statusDiv) {
                    statusDiv.innerHTML += `
                        <div style="background: #e3f2fd; border: 1px solid #2196f3; padding: 8px; margin: 5px 0; border-radius: 4px; font-size: 12px;">
                            📱 モバイルデバイスを検出しました。MediaPipe初期化中...
                        </div>
                    `;
                }
            }

            // MediaPipe初期化（タイムアウト付き）
            try {
                const initTimeout = new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('初期化タイムアウト')), isMobile ? 15000 : 10000)
                );

                const initResult = await Promise.race([initMediaPipe(), initTimeout]);

                if (initResult) {
                    console.log('✅ MediaPipe初期化成功');
                    if (isMobile) {
                        const statusDiv = document.querySelector('.status-info');
                        if (statusDiv) {
                            statusDiv.innerHTML += `
                                <div style="background: #e8f5e8; border: 1px solid #4caf50; padding: 8px; margin: 5px 0; border-radius: 4px; font-size: 12px;">
                                    ✅ MediaPipe初期化完了（モバイル対応）
                                </div>
                            `;
                        }
                    }
                } else {
                    throw new Error('MediaPipe初期化失敗');
                }

            } catch (error) {
                console.warn('MediaPipe初期化失敗 - フォールバックモードで動作:', error.message);
                mediaPipeReady = false;

                // モバイル用のフォールバック通知
                const statusDiv = document.querySelector('.status-info');
                if (statusDiv) {
                    statusDiv.innerHTML += `
                        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 8px; margin: 5px 0; border-radius: 4px; font-size: 12px;">
                            ⚠️ MediaPipe未対応 - 手動調整モードで動作します
                        </div>
                    `;
                }
            }

            console.log('✅ アプリケーション準備完了 - MediaPipe状態:', mediaPipeReady);
        });

        // レーダーチャート作成
        function createRadarChart(results) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const viewType = document.getElementById('viewSelect').value;
            
            // 視点に応じたラベルとデータを動的に設定
            let labels = [];
            let data = [];
            
            if (viewType === 'front') {
                labels = ['ボール位置', 'スタンス幅', '頭の位置', '手の位置', '体重配分'];
                data = [results.ballPosition, results.stance, results.headPosition, results.handPosition, results.weight];
            } else { // rear
                labels = ['前傾角度', '手と体の距離', '前後バランス', '体の向き', '背中の曲がり具合'];
                data = [results.forwardLean, results.handBodyDistance, results.frontBackBalance, results.bodyDirection, results.backCurvature];
            }
            
            if (window.radarChartInstance) {
                window.radarChartInstance.destroy();
            }
            
            window.radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '現在のスコア',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)'
                    }, {
                        label: '理想スコア',
                        data: new Array(labels.length).fill(95),
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(76, 175, 80, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 16
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 14
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                }
            });
        }

        // ソーシャルシェア機能
        function shareToTwitter() {
            const text = encodeURIComponent('ゴルフアドレス診断ツールで診断しました！ #ゴルフ #アドレス診断');
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
        }

        function shareToFacebook() {
            try {
                const url = window.location.href;
                const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                const popup = window.open(shareUrl, 'facebook-share', 'width=600,height=400,scrollbars=yes,resizable=yes');
                
                if (!popup) {
                    // ポップアップがブロックされた場合の代替案
                    navigator.clipboard.writeText(url).then(() => {
                        alert('🔗 URLをクリップボードにコピーしました！\nFacebookで手動で投稿してください。');
                    }).catch(() => {
                        alert('Facebookシェアページを開くことができませんでした。\n以下のURLを手動でコピーしてFacebookで共有してください:\n\n' + url);
                    });
                }
            } catch (error) {
                console.error('Facebook共有エラー:', error);
                alert('Facebook共有でエラーが発生しました。ブラウザの設定を確認してください。');
            }
        }

        function shareToInstagram() {
            try {
                // 診断結果の情報を取得
                const totalScore = document.querySelector('#totalScore')?.textContent || '結果未取得';
                const message = `🏌️‍♂️ ゴルフアドレス診断結果: ${totalScore}\n\n野山佳治プロ監修のAI診断で姿勢をチェック！\n\n#ゴルフアドレス診断 #野山佳治プロ監修 #ゴルフ上達 #アドレス改善`;
                
                // クリップボードにコピー
                navigator.clipboard.writeText(message).then(() => {
                    alert('📷 Instagramでの共有方法:\n\n1. 診断結果のスクリーンショットを撮影\n2. ハッシュタグをクリップボードにコピーしました\n3. Instagramで投稿してください！\n\n#ゴルフアドレス診断 #野山佳治プロ監修');
                }).catch(() => {
                    alert('📷 Instagramでの共有方法:\n\n1. 診断結果のスクリーンショットを撮影\n2. 以下のハッシュタグを使用してInstagramで投稿してください:\n\n#ゴルフアドレス診断 #野山佳治プロ監修 #ゴルフ上達');
                });
            } catch (error) {
                console.error('Instagram共有エラー:', error);
                alert('📷 診断結果のスクリーンショットを撮って、Instagramで共有してください！\n\n#ゴルフアドレス診断 #野山佳治プロ監修');
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ページ読み込み完了 - 初期化開始');
            
            // MediaPipe初期化
            const mediaPipeReady = initMediaPipe();
            if (!mediaPipeReady) {
                console.warn('MediaPipe初期化失敗 - フォールバックモードで動作');
            }
            
            console.log('✅ アプリケーション準備完了');
        });
    </script>
</body>
</html>
