<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ« - AI & ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç‰ˆ</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J7QD0MNVWG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J7QD0MNVWG');
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f0ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e6e6ff;
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .control-group select, .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .control-group select:focus, .control-group input:focus {
            border-color: #667eea;
            outline: none;
        }

        .analysis-container {
            display: grid;
            grid-template-columns: 1fr 1.4fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        .image-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .image-container {
            position: relative;
            text-align: center;
            margin-bottom: 20px;
        }

        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .image-container canvas {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 10px;
            cursor: crosshair;
        }

        .ball-position-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #FFD700 0%, #FFA500 100%);
            border: 3px solid #FF4500;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            box-shadow: 0 3px 12px rgba(255, 69, 0, 0.4);
            cursor: pointer;
            animation: ballPulse 1.5s ease-in-out infinite;
        }

        @keyframes ballPulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .ball-position-marker::after {
            content: 'ğŸŒï¸â€â™‚ï¸';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .click-instruction {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 15;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); }
        }

        .ball-position-instruction {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 215, 0, 0.85);
            color: #333;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
            border: 2px solid #FFD700;
            max-width: 150px;
            line-height: 1.2;
        }

        .score-feedback-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .score-feedback-item {
            background: linear-gradient(135deg, #f6f9fc 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .score-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .advice-text {
            color: #666;
            line-height: 1.6;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .score-label {
            color: #666;
            font-size: 0.9em;
        }

        .score-excellent { border-left-color: #28a745; }
        .score-good { border-left-color: #17a2b8; }
        .score-average { border-left-color: #ffc107; }
        .score-poor { border-left-color: #dc3545; }

        .score-excellent .score-value { color: #28a745; }
        .score-good .score-value { color: #17a2b8; }
        .score-average .score-value { color: #ffc107; }
        .score-poor .score-value { color: #dc3545; }

        .radar-container {
            position: relative;
            height: 550px;
            margin: 20px 0;
            padding: 25px;
        }

        .feedback {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .feedback h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .feedback-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .feedback-item h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .feedback-item p {
            color: #666;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        /* ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .social-btn {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .social-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .social-btn:active {
            transform: translateY(0);
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”¨ */
        @media (max-width: 1024px) {
            .container {
                padding: 15px;
            }
            
            .analysis-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
        }

        /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1em;
            }

            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ç›£ä¿®è€…æƒ…å ±ã‚’ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èª¿æ•´ */
            .header div[style*="display: flex"] {
                flex-direction: column !important;
                text-align: center !important;
                gap: 10px !important;
                padding: 12px !important;
            }

            .header div[style*="display: flex"] img {
                width: 60px !important;
                height: 60px !important;
            }

            .analysis-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .upload-section {
                padding: 15px;
            }

            .upload-area {
                padding: 30px 20px;
            }

            .upload-icon {
                font-size: 3em;
            }

            .upload-text {
                font-size: 16px;
            }

            .controls {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .control-group {
                flex-direction: column;
                gap: 8px;
                text-align: left;
            }

            .control-group label {
                font-size: 16px;
                font-weight: bold;
            }

            .control-group select,
            .control-group button {
                font-size: 16px;
                padding: 12px;
                min-height: 44px; /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚º */
            }

            .score-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .score-feedback-item {
                padding: 15px;
            }

            .score-title {
                font-size: 16px;
            }

            .score-value {
                font-size: 18px;
            }

            .advice-text {
                font-size: 14px;
                line-height: 1.5;
            }

            /* ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èª¿æ•´ */
            .chart-container {
                padding: 15px;
            }

            /* ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢ã‚’ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èª¿æ•´ */
            #socialShare div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 12px !important;
            }

            .social-btn {
                justify-content: center !important;
                padding: 14px 20px !important;
                font-size: 16px !important;
            }

            /* ãƒ¬ãƒƒã‚¹ãƒ³æ¡ˆå†…ã‚’ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«èª¿æ•´ */
            #lessonPromotion {
                padding: 20px 15px !important;
            }

            #lessonPromotion div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 15px !important;
            }

            #lessonPromotion img {
                width: 70px !important;
                height: 70px !important;
            }

            #lessonPromotion h3 {
                font-size: 18px !important;
            }

            #lessonPromotion p {
                font-size: 14px !important;
            }

            /* ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯æŒ‡ç¤ºã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            #ballPositionInstruction {
                font-size: 14px !important;
                padding: 8px 12px !important;
                top: 5px !important;
                right: 5px !important;
            }

            /* ç”»åƒã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
            #imageContainer {
                margin: 15px 0;
            }

            #uploadedImage {
                max-height: 300px !important;
            }
        }

        /* å°ã•ãªã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .upload-area {
                padding: 25px 15px;
            }

            .upload-icon {
                font-size: 2.5em;
            }

            .upload-text {
                font-size: 14px;
            }

            .control-group select,
            .control-group button {
                font-size: 14px;
                padding: 10px;
            }

            .score-feedback-item {
                padding: 12px;
            }

            .score-title {
                font-size: 14px;
            }

            .score-value {
                font-size: 16px;
            }

            .advice-text {
                font-size: 13px;
            }

            #lessonPromotion {
                padding: 15px 10px !important;
            }

            #lessonPromotion h3 {
                font-size: 16px !important;
            }

            #lessonPromotion p {
                font-size: 13px !important;
            }

            #uploadedImage {
                max-height: 250px !important;
            }
        }

        /* ãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        @media (max-width: 768px) and (orientation: landscape) {
            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 0.9em;
            }

            #uploadedImage {
                max-height: 200px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒï¸ ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
            <p>AIæ­è¼‰ - MediaPipe & ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆåˆ†æç‰ˆ</p>
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 2px solid #ddd; display: flex; align-items: center; gap: 15px;">
                <a href="https://noyamagolf.com/" target="_blank" style="display: block; flex-shrink: 0;">
                    <img src="noyama-keiji.png" alt="é‡å±±ä½³æ²»" style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #007bff; object-fit: cover; cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                </a>
                <div style="flex: 1; color: #333;">
                    <h3 style="margin: 0 0 5px 0; font-size: 16px; font-weight: bold; color: #007bff;">
                        ãƒ†ã‚£ãƒ¼ãƒãƒ³ã‚°ãƒ—ãƒ­é‡å±±ä½³æ²»ç›£ä¿®
                    </h3>
                    <p style="margin: 0; font-size: 14px; color: #666;">
                        <a href="https://noyamagolf.com/" target="_blank" style="color: #007bff; text-decoration: none; font-weight: 500;">
                            ğŸŒ https://noyamagolf.com/
                        </a>
                    </p>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                <div class="upload-icon">ğŸ“¸</div>
                <div class="upload-text">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
                <p>JPG, PNG, GIFå½¢å¼ã«å¯¾å¿œ</p>
            </div>
            <input type="file" id="imageInput" class="file-input" accept="image/*">
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="viewSelect">æ’®å½±è¦–ç‚¹:</label>
                <select id="viewSelect">
                    <option value="front">æ­£é¢</option>
                    <option value="back">å¾Œæ–¹</option>
                </select>
            </div>
            <div class="control-group">
                <label for="clubSelect">ã‚¯ãƒ©ãƒ–é¸æŠ:</label>
                <select id="clubSelect">
                    <option value="Driver">ãƒ‰ãƒ©ã‚¤ãƒãƒ¼</option>
                    <option value="FairwayWood">ãƒ•ã‚§ã‚¢ã‚¦ã‚§ã‚¤ã‚¦ãƒƒãƒ‰</option>
                    <option value="Utility">ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¼</option>
                    <option value="3Iron">3ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="4Iron">4ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="5Iron">5ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="6Iron">6ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="7Iron" selected>7ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="8Iron">8ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="9Iron">9ç•ªã‚¢ã‚¤ã‚¢ãƒ³</option>
                    <option value="Wedge">ã‚¦ã‚¨ãƒƒã‚¸</option>
                </select>
            </div>
            <div class="control-group">
                <button id="startDiagnosis" class="btn">ğŸ” è¨ºæ–­é–‹å§‹</button>
            </div>
        </div>

        <div id="analysisResults" class="hidden">
            <div class="analysis-container">
                <div class="image-section">
                    <h3>ğŸ“Š å§¿å‹¢åˆ†æçµæœ</h3>
                    <div class="image-container" id="imageContainer">
                        <img id="uploadedImage" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ">
                        <canvas id="poseCanvas"></canvas>
                        <div class="click-instruction" id="clickInstruction">âš ï¸ æ­£é¢æ’®å½±æ™‚ï¼šä¸Šæ‰‹ãæ¤œå‡ºã•ã‚Œã¦ã„ãªã„ã¨ãã«ã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
                        <div class="ball-position-instruction" id="ballPositionInstruction">
                            ğŸŒï¸â€â™‚ï¸ ã‚´ãƒ«ãƒ•ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
                            <small>æ­£é¢æ’®å½±ã§ã¯å¿…é ˆã§ã™</small>
                        </div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h3>ğŸ“ˆ ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</h3>
                    <div class="radar-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="score-feedback-grid" id="scoreFeedbackGrid">
                <!-- ã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’çµ±åˆè¡¨ç¤º -->
            </div>
            
            <!-- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
            <div id="socialShare" class="hidden" style="margin-top: 20px; padding: 20px; background: white; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">ğŸ“± è¨ºæ–­çµæœã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ï¼</h3>
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button onclick="shareToTwitter()" class="social-btn twitter-btn" style="background: #1DA1F2; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                        </svg>
                        Twitter
                    </button>
                    
                    <button onclick="shareToFacebook()" class="social-btn facebook-btn" style="background: #4267B2; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                        Facebook
                    </button>
                    
                    <button onclick="shareToLine()" class="social-btn line-btn" style="background: #00B900; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.349 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.629 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.070 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                        </svg>
                        LINE
                    </button>
                    
                    <button onclick="copyToClipboard()" class="social-btn copy-btn" style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.2s;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                        URLã‚³ãƒ”ãƒ¼
                    </button>
                </div>
            </div>

            <!-- è¨ºæ–­çµæœå¾Œã®ãƒ¬ãƒƒã‚¹ãƒ³æ¡ˆå†… -->
            <div id="lessonPromotion" class="hidden" style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 15px; text-align: center; box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);">
                <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                    <a href="https://noyamagolf.com/" target="_blank" style="display: block;">
                        <img src="noyama-keiji.png" alt="é‡å±±ä½³æ²»" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; object-fit: cover; cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    </a>
                    <div style="color: white; text-align: left; flex: 1; min-width: 250px;">
                        <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: bold;">
                            ğŸŒï¸ è¨ºæ–­çµæœã‚’ã‚‚ã¨ã«ã€ã•ã‚‰ãªã‚‹ä¸Šé”ã‚’ç›®æŒ‡ã—ã¾ã›ã‚“ã‹ï¼Ÿ
                        </h3>
                        <p style="margin: 0 0 12px 0; font-size: 16px; line-height: 1.4;">
                            ãƒ—ãƒ­ãŒæ•™ãˆã‚‹å®Ÿè·µçš„ãªãƒ¬ãƒƒã‚¹ãƒ³ã§ã€ç†æƒ³ã®ã‚¹ã‚¤ãƒ³ã‚°ã‚’èº«ã«ã¤ã‘ã¾ã—ã‚‡ã†
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: flex-start; margin-bottom: 12px;">
                            <a href="https://noyamagolf.com/%e3%83%a9%e3%82%a6%e3%83%b3%e3%83%89%e3%83%ac%e3%83%83%e3%82%b9%e3%83%b3/" target="_blank" style="text-decoration: none;">
                                <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-size: 14px; color: white; border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">
                                    ğŸŒï¸ ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¬ãƒƒã‚¹ãƒ³
                                </div>
                            </a>
                            <a href="https://noyamagolf.com/%e3%82%aa%e3%83%b3%e3%83%a9%e3%82%a4%e3%83%b3%e3%83%ac%e3%83%83%e3%82%b9%e3%83%b3/" target="_blank" style="text-decoration: none;">
                                <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-size: 14px; color: white; border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">
                                    ğŸ’» ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¬ãƒƒã‚¹ãƒ³
                                </div>
                            </a>
                            <a href="https://noyamagolf.com/%e3%82%b9%e3%82%bf%e3%82%b8%e3%82%aa%e3%83%ac%e3%83%83%e3%82%b9%e3%83%b3/" target="_blank" style="text-decoration: none;">
                                <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 20px; font-size: 14px; color: white; border: 1px solid rgba(255,255,255,0.3); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='scale(1)'">
                                    ğŸ‘¨â€ğŸ« ãƒãƒ³ãƒ„ãƒ¼ãƒãƒ³ãƒ¬ãƒƒã‚¹ãƒ³
                                </div>
                            </a>
                        </div>
                        <p style="margin: 0; font-size: 16px;">
                            <a href="https://noyamagolf.com/" target="_blank" style="color: #FFD700; text-decoration: underline; font-weight: bold; font-size: 18px;">é‡å±±ä½³æ²»ã®ã‚´ãƒ«ãƒ•ãƒ¬ãƒƒã‚¹ãƒ³</a> ã§è©³ç´°ã‚’ã”ç¢ºèªãã ã•ã„
                        </p>
                    </div>
                    <div style="color: white; font-size: 40px;">â›³</div>
                </div>
            </div>
        </div>

        <div id="loadingSection" class="loading hidden">
            <div class="loading-spinner"></div>
            <p>AIåˆ†æä¸­...</p>
        </div>
    </div>

    <script>
        let pose;
        let camera;
        let poseResults;
        let uploadedImageElement;
        let radarChartInstance;
        let userClickedBallPosition = null;
        let isBallPositionClickEnabled = false;
        let isDiagnosisStarted = false; // è¨ºæ–­é–‹å§‹ãƒ•ãƒ©ã‚°

        // MediaPipe PoseåˆæœŸåŒ–
        function initMediaPipe() {
            pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });

            pose.setOptions({
                modelComplexity: 0, // è»½é‡ãƒ¢ãƒ¼ãƒ‰ã§é«˜é€ŸåŒ–
                smoothLandmarks: false, // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç„¡åŠ¹ã§é«˜é€ŸåŒ–
                enableSegmentation: false,
                smoothSegmentation: false, // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç„¡åŠ¹ã§é«˜é€ŸåŒ–
                minDetectionConfidence: 0.4, // æ¤œå‡ºé–¾å€¤ã‚’ä¸‹ã’ã¦é«˜é€ŸåŒ–
                minTrackingConfidence: 0.4 // ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é–¾å€¤ã‚’ä¸‹ã’ã¦é«˜é€ŸåŒ–
            });

            pose.onResults(onPoseResults);
        }

        // Poseçµæœå‡¦ç†
        function onPoseResults(results) {
            console.log('MediaPipeçµæœå—ä¿¡:', results);
            poseResults = results;
            
            // å¿…ãšæç”»ã‚’å®Ÿè¡Œ
            if (uploadedImageElement) {
                console.log('æç”»ã‚’å®Ÿè¡Œã—ã¾ã™');
                drawPoseOverlay();
            }
            
            // åˆ†æã¯è¨ºæ–­ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®ã¿å®Ÿè¡Œ
            // analyzePosture();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        const uploadArea = document.querySelector('.upload-area');
        const fileInput = document.getElementById('imageInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageUpload(e.target.files[0]);
            }
        });

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleImageUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // Google Analytics ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
            if (typeof gtag !== 'undefined') {
                gtag('event', 'image_upload', {
                    'event_category': 'engagement',
                    'event_label': 'Golf Photo Upload'
                });
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('uploadedImage');
                img.src = e.target.result;
                img.onload = function() {
                    uploadedImageElement = img;
                    userClickedBallPosition = null; // ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                    isDiagnosisStarted = false; // è¨ºæ–­ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ç”»åƒã«åˆã‚ã›ã¦è¨­å®š
                    const canvas = document.getElementById('poseCanvas');
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ç”»åƒã®ã‚µã‚¤ã‚ºã‚’å–å¾—
                    setTimeout(() => {
                        const imgRect = img.getBoundingClientRect();
                        const containerRect = img.parentElement.getBoundingClientRect();
                        
                        // ç”»åƒã®å®Ÿéš›ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å–å¾—
                        const displayWidth = img.clientWidth;
                        const displayHeight = img.clientHeight;
                        
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’æ­£ç¢ºã«è¨­å®š
                        canvas.width = displayWidth;
                        canvas.height = displayHeight;
                        canvas.style.width = displayWidth + 'px';
                        canvas.style.height = displayHeight + 'px';
                        
                        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç”»åƒã¨å®Œå…¨ã«é‡ã­ã‚‹
                        canvas.style.position = 'absolute';
                        canvas.style.top = img.offsetTop + 'px';
                        canvas.style.left = img.offsetLeft + 'px';
                        canvas.style.transform = 'none';
                        canvas.style.display = 'block';
                        canvas.style.pointerEvents = 'auto';
                        
                        console.log('ã‚­ãƒ£ãƒ³ãƒã‚¹æœ€çµ‚è¨­å®š:', canvas.width, 'x', canvas.height);
                        console.log('ç”»åƒä½ç½®:', img.offsetTop, img.offsetLeft);
                    }, 150);
                    
                    console.log('ç”»åƒãƒ­ãƒ¼ãƒ‰å®Œäº†:', img.width, 'x', img.height);
                    console.log('ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚º:', canvas.width, 'x', canvas.height);
                    
                    // åˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    document.getElementById('analysisResults').classList.remove('hidden');
                    
                    // ç”»åƒã‚’ç¢ºå®Ÿã«è¡¨ç¤º
                    img.style.display = 'block';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '400px';
                    img.style.borderRadius = '10px';
                    
                    setupBallPositionClick();
                    updateDiagnosisButtonState(); // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                    
                    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã«è‡ªå‹•ã§MediaPipeå‡¦ç†ã‚’å®Ÿè¡Œï¼ˆãƒãƒ¼ã‚ºæ¤œå‡ºã®ã¿ï¼‰
                    setTimeout(() => {
                        if (pose && uploadedImageElement) {
                            console.log('è‡ªå‹•MediaPipeå‡¦ç†é–‹å§‹');
                            pose.send({image: uploadedImageElement});
                        }
                    }, 800); // ã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®šå¾Œã«å®Ÿè¡Œ
                };
            };
            reader.readAsDataURL(file);
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ã®è¨­å®šï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function setupBallPositionClick() {
            const viewType = document.getElementById('viewSelect').value;
            const canvas = document.getElementById('poseCanvas');
            const container = document.getElementById('imageContainer');
            const instruction = document.getElementById('clickInstruction');
            const ballInstruction = document.getElementById('ballPositionInstruction');
            
            if (viewType === 'front') {
                isBallPositionClickEnabled = true;
                canvas.style.pointerEvents = 'auto';
                canvas.style.cursor = 'crosshair';
                
                // æŒ‡ç¤ºã‚’è¡¨ç¤ºï¼ˆç°¡æ½”ã«ï¼‰
                instruction.style.display = 'block';
                ballInstruction.style.display = 'block';
                ballInstruction.innerHTML = 'ğŸŒï¸â€â™‚ï¸ ã‚´ãƒ«ãƒ•ãƒœãƒ¼ãƒ«<br>ã‚¯ãƒªãƒƒã‚¯';
                ballInstruction.style.backgroundColor = 'rgba(255, 215, 0, 0.85)';
                ballInstruction.style.borderColor = '#FFD700';
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                canvas.removeEventListener('click', handleBallPositionClick); // é‡è¤‡é˜²æ­¢
                canvas.addEventListener('click', handleBallPositionClick);
                
                // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼åŠ¹æœ
                canvas.addEventListener('mouseenter', () => {
                    ballInstruction.style.backgroundColor = 'rgba(255, 215, 0, 1)';
                    ballInstruction.style.transform = 'translateX(-50%) scale(1.05)';
                });
                
                canvas.addEventListener('mouseleave', () => {
                    ballInstruction.style.backgroundColor = 'rgba(255, 215, 0, 0.9)';
                    ballInstruction.style.transform = 'translateX(-50%) scale(1)';
                });
                
                // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateDiagnosisButtonState();
                
                // 7ç§’å¾Œã«ä¸Šéƒ¨æŒ‡ç¤ºã‚’éè¡¨ç¤º
                setTimeout(() => {
                    instruction.style.display = 'none';
                }, 7000);
            } else {
                isBallPositionClickEnabled = false;
                canvas.style.pointerEvents = 'none';
                canvas.style.cursor = 'default';
                instruction.style.display = 'none';
                ballInstruction.style.display = 'none';
                canvas.removeEventListener('click', handleBallPositionClick);
                
                // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                updateDiagnosisButtonState();
            }
        }

        // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateDiagnosisButtonState() {
            const diagnosisBtn = document.getElementById('startDiagnosis');
            const viewType = document.getElementById('viewSelect').value;
            
            if (viewType === 'front') {
                if (userClickedBallPosition) {
                    // ãƒœãƒ¼ãƒ«ä½ç½®ãŒè¨­å®šæ¸ˆã¿ - ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                    diagnosisBtn.disabled = false;
                    diagnosisBtn.textContent = 'ğŸ” è¨ºæ–­é–‹å§‹';
                    diagnosisBtn.style.opacity = '1';
                    diagnosisBtn.style.cursor = 'pointer';
                } else {
                    // ãƒœãƒ¼ãƒ«ä½ç½®ãŒæœªè¨­å®š - ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                    diagnosisBtn.disabled = true;
                    diagnosisBtn.textContent = 'ğŸŒï¸â€â™‚ï¸ ã‚´ãƒ«ãƒ•ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
                    diagnosisBtn.style.opacity = '0.6';
                    diagnosisBtn.style.cursor = 'not-allowed';
                }
            } else {
                // å¾Œæ–¹è¦–ç‚¹ã§ã¯é€šå¸¸é€šã‚Šæœ‰åŠ¹
                diagnosisBtn.disabled = false;
                diagnosisBtn.textContent = 'ğŸ” è¨ºæ–­é–‹å§‹';
                diagnosisBtn.style.opacity = '1';
                diagnosisBtn.style.cursor = 'pointer';
            }
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        function handleBallPositionClick(event) {
            if (!isBallPositionClickEnabled) return;
            
            const canvas = document.getElementById('poseCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å–å¾—ï¼ˆCSSã‚µã‚¤ã‚ºï¼‰
            const displayWidth = rect.width;
            const displayHeight = rect.height;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’æ­£è¦åŒ–ï¼ˆ0-1ã®ç¯„å›²ï¼‰
            const normalizedX = x / displayWidth;
            const normalizedY = y / displayHeight;
            
            userClickedBallPosition = { x: normalizedX, y: normalizedY };
            
            // ãƒœãƒ¼ãƒ«ä½ç½®ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
            showBallPositionMarker(x, y);
            
            // æŒ‡ç¤ºã‚’æ›´æ–°
            const ballInstruction = document.getElementById('ballPositionInstruction');
            ballInstruction.innerHTML = 'âœ… ãƒœãƒ¼ãƒ«ä½ç½®ãŒè¨­å®šã•ã‚Œã¾ã—ãŸï¼<br><small>è¨ºæ–­é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</small>';
            ballInstruction.style.backgroundColor = 'rgba(40, 167, 69, 0.9)';
            ballInstruction.style.borderColor = '#28a745';
            
            // è¨ºæ–­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateDiagnosisButtonState();
            
            // è¨ºæ–­é–‹å§‹ã¾ã§è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼ˆã‚¿ã‚¤ãƒãƒ¼å‰Šé™¤ï¼‰
            // setTimeout(() => {
            //     ballInstruction.style.display = 'none';
            // }, 5000);
            
            console.log('ãƒœãƒ¼ãƒ«ä½ç½®ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:', userClickedBallPosition);
            console.log('ã‚¯ãƒªãƒƒã‚¯åº§æ¨™:', x, y, 'ã‚­ãƒ£ãƒ³ãƒã‚¹è¡¨ç¤ºã‚µã‚¤ã‚º:', displayWidth, displayHeight);
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
        function showBallPositionMarker(x, y) {
            const container = document.getElementById('imageContainer');
            
            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
            const existingMarker = container.querySelector('.ball-position-marker');
            if (existingMarker) {
                existingMarker.remove();
            }
            
            // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
            const marker = document.createElement('div');
            marker.className = 'ball-position-marker';
            marker.style.left = x + 'px';
            marker.style.top = y + 'px';
            
            container.appendChild(marker);
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading() {
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('analysisResults').classList.add('hidden');
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('analysisResults').classList.remove('hidden');
            // è¨ºæ–­çµæœå¾Œã®ãƒ¬ãƒƒã‚¹ãƒ³æ¡ˆå†…ã‚’è¡¨ç¤º
            document.getElementById('lessonPromotion').classList.remove('hidden');
            
            // ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('socialShare').classList.remove('hidden');
        }

        // ç”»åƒå‡¦ç†
        async function processImage() {
            if (!uploadedImageElement) return;

            console.log('MediaPipeå‡¦ç†é–‹å§‹...');
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æº–å‚™
            const canvas = document.getElementById('poseCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = uploadedImageElement.clientWidth || uploadedImageElement.width;
            canvas.height = uploadedImageElement.clientHeight || uploadedImageElement.height;
            
            // MediaPipeã§ãƒãƒ¼ã‚ºæ¤œå‡º
            try {
                await pose.send({image: uploadedImageElement});
                console.log('MediaPipeé€ä¿¡å®Œäº†');
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æç”»ã‚’ç¢ºèª
                setTimeout(() => {
                    if (poseResults && poseResults.poseLandmarks) {
                        console.log('ãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã‚ã‚Šã€å¼·åˆ¶æç”»å®Ÿè¡Œ');
                        drawPoseOverlay();
                        // è¨ºæ–­ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®ã¿åˆ†æå®Ÿè¡Œ
                        analyzePosture();
                    } else {
                        console.log('ãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ãªã—ã€ç©ºã‚­ãƒ£ãƒ³ãƒã‚¹æç”»');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
                        ctx.fillRect(10, 10, 300, 40);
                        ctx.fillStyle = '#000';
                        ctx.font = '16px Arial';
                        ctx.fillText('MediaPipe: ãƒãƒ¼ã‚ºæ¤œå‡ºå‡¦ç†ä¸­...', 15, 35);
                    }
                }, 500);
            } catch (error) {
                console.error('MediaPipeå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒãƒ¼ã‚ºã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”»ï¼ˆå¼·åˆ¶è¡¨ç¤ºï¼‰
        function drawPoseOverlay() {
            const canvas = document.getElementById('poseCanvas');
            const ctx = canvas.getContext('2d');
            const img = uploadedImageElement;

            if (!canvas || !ctx || !img) {
                console.log('æç”»è¦ç´ ãŒä¸è¶³:', {canvas: !!canvas, ctx: !!ctx, img: !!img});
                return;
            }

            // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”»åƒã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const displayedWidth = img.clientWidth || img.offsetWidth;
            const displayedHeight = img.clientHeight || img.offsetHeight;
            
            // å…ƒç”»åƒã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const originalWidth = img.naturalWidth || img.width;
            const originalHeight = img.naturalHeight || img.height;
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”»åƒã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹
            canvas.width = displayedWidth;
            canvas.height = displayedHeight;
            canvas.style.width = displayedWidth + 'px';
            canvas.style.height = displayedHeight + 'px';

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            console.log('æç”»é–‹å§‹ - è¡¨ç¤ºã‚µã‚¤ã‚º:', displayedWidth, 'x', displayedHeight);
            console.log('å…ƒç”»åƒã‚µã‚¤ã‚º:', originalWidth, 'x', originalHeight);

            if (poseResults && poseResults.poseLandmarks && poseResults.poseLandmarks.length > 0) {
                console.log('MediaPipe landmarks detected:', poseResults.poseLandmarks.length);
                
                // ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ç‡ã‚’è¨ˆç®—ï¼ˆMediaPipeã®åº§æ¨™ã¯0-1ã®ç¯„å›²ï¼‰
                const scaleX = displayedWidth;
                const scaleY = displayedHeight;
                
                // æ¥ç¶šç·šã‚’å…ˆã«æç”»ï¼ˆèƒŒæ™¯ï¼‰
                drawConnections(ctx, poseResults.poseLandmarks, scaleX, scaleY);
                
                // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’ä¸Šã«æç”»ï¼ˆå‰æ™¯ï¼‰
                drawLandmarks(ctx, poseResults.poseLandmarks, scaleX, scaleY);
                
                // ãƒœãƒ¼ãƒ«ä½ç½®ã¨ç†æƒ³ä½ç½®ã‚’æç”»ï¼ˆæ­£é¢ã‹ã‚‰ã®å ´åˆã¯è‡ªå‹•æ¤œå‡ºã‚’è©¦è¡Œï¼‰
                const viewType = document.getElementById('viewSelect').value;
                if (viewType === 'front') {
                    tryAutomaticBallDetection(ctx, poseResults.poseLandmarks, scaleX, scaleY);
                } else {
                    drawBallPosition(ctx, poseResults.poseLandmarks, scaleX, scaleY);
                }
            } else {
                console.log('No pose landmarks detected or empty result');
                // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæ¤œå‡ºã•ã‚Œãªã„å ´åˆã§ã‚‚ä½•ã‹ã‚’æç”»
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.fillRect(10, 10, 200, 30);
                ctx.fillStyle = '#000';
                ctx.font = '14px Arial';
                ctx.fillText('MediaPipe: ãƒãƒ¼ã‚ºæ¤œå‡ºä¸­...', 15, 30);
            }
        }

        // è‡ªå‹•ãƒœãƒ¼ãƒ«ä½ç½®æ¤œå‡ºã‚’è©¦è¡Œ
        function tryAutomaticBallDetection(ctx, landmarks, width, height) {
            const clubType = document.getElementById('clubSelect').value;
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            
            if (!leftAnkle || !rightAnkle || !leftWrist || !rightWrist) {
                // å¿…è¦ãªãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯æ‰‹å‹•é¸æŠã«åˆ‡ã‚Šæ›¿ãˆ
                showBallPositionClickInstruction();
                return;
            }
            
            // æ‰‹ã®ä½ç½®ã‹ã‚‰è‡ªå‹•ã§ãƒœãƒ¼ãƒ«ä½ç½®ã‚’æ¨å®š
            const handCenter = (leftWrist.x + rightWrist.x) / 2;
            const footY = Math.max(leftAnkle.y, rightAnkle.y);
            
            // æ¨å®šä¿¡é ¼åº¦ã‚’è¨ˆç®—ï¼ˆæ‰‹é¦–ã®æ¤œå‡ºä¿¡é ¼åº¦ãŒä½ã„å ´åˆã¯æ‰‹å‹•é¸æŠï¼‰
            const confidence = Math.min(leftWrist.visibility, rightWrist.visibility);
            
            if (confidence < 0.7) {
                // ä¿¡é ¼åº¦ãŒä½ã„å ´åˆã¯æ‰‹å‹•é¸æŠã«åˆ‡ã‚Šæ›¿ãˆ
                showBallPositionClickInstruction();
                return;
            }
            
            // è‡ªå‹•æ¤œå‡ºæˆåŠŸ - ãƒœãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®š
            userClickedBallPosition = { x: handCenter, y: footY + 0.03 };
            
            // è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸãƒœãƒ¼ãƒ«ä½ç½®ã‚’æç”»
            drawAutomaticBallPosition(ctx, handCenter, footY, width, height);
            
            // ç†æƒ³ä½ç½®ã‚‚æç”»ï¼ˆè¨ºæ–­é–‹å§‹å¾Œã®ã¿ï¼‰
            if (isDiagnosisStarted) {
                drawIdealBallPosition(ctx, landmarks, width, height, clubType);
            }
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showAutoDetectionSuccess();
        }
        
        // è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸãƒœãƒ¼ãƒ«ä½ç½®ã‚’æç”»
        function drawAutomaticBallPosition(ctx, x, footY, width, height) {
            // è‡ªå‹•æ¤œå‡ºã•ã‚ŒãŸãƒœãƒ¼ãƒ«ä½ç½®ï¼ˆé’ã„å††ï¼‰
            ctx.fillStyle = '#0066FF';
            ctx.globalAlpha = 0.8;
            ctx.beginPath();
            ctx.arc(x * width, (footY + 0.03) * height, 10, 0, 2 * Math.PI);
            ctx.fill();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#0066FF';
            ctx.globalAlpha = 1.0;
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('è‡ªå‹•æ¤œå‡º', x * width, (footY + 0.03) * height - 15);
            
            // è¦–è¦šçš„ãƒãƒ¼ã‚«ãƒ¼ã‚‚è¡¨ç¤º
            const ballMarkerX = x * width;
            const ballMarkerY = (footY + 0.03) * height;
            showBallPositionMarker(ballMarkerX, ballMarkerY);
        }
        
        // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ã‚’æç”»
        function drawIdealBallPosition(ctx, landmarks, width, height, clubType) {
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const leftHeel = landmarks[29];
            const rightHeel = landmarks[30];
            
            if (!leftAnkle || !rightAnkle) return;
            
            // è¶³ã®ä½ç½®è¨ˆç®—
            const leftFootCenter = leftHeel ? leftHeel.x : leftAnkle.x;
            const rightFootCenter = rightHeel ? rightHeel.x : rightAnkle.x;
            const stanceCenter = (leftFootCenter + rightFootCenter) / 2;
            
            // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®
            const idealPositions = {
                'Driver': leftFootCenter,                // å·¦è¶³ã‹ã‹ã¨ä½ç½®
                'FairwayWood': leftFootCenter + 0.02,   // å·¦è¶³ã‹ã‹ã¨å†…å´ã‚ˆã‚Šå°‘ã—å³
                'Utility': stanceCenter - 0.02,        // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '3Iron': stanceCenter - 0.015,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '4Iron': stanceCenter - 0.01,          // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '5Iron': stanceCenter - 0.005,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '6Iron': stanceCenter,                  // ä¸­å¤®
                '7Iron': stanceCenter,                  // ä¸­å¤®
                '8Iron': stanceCenter + 0.005,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³
                '9Iron': stanceCenter + 0.01,          // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³
                'Wedge': stanceCenter + 0.03           // ä¸­å¤®ã‚ˆã‚Šå³
            };
            
            const idealPosition = idealPositions[clubType] || stanceCenter;
            const footY = Math.max(leftAnkle.y, rightAnkle.y);
            
            // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ã‚’ç·‘ã®å††ã§æç”»
            ctx.fillStyle = '#00FF00';
            ctx.globalAlpha = 0.7;
            ctx.beginPath();
            ctx.arc(idealPosition * width, footY * height + 20, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#00FF00';
            ctx.globalAlpha = 1.0;
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('ç†æƒ³ä½ç½®', idealPosition * width, footY * height + 5);
        }
        
        // è‡ªå‹•æ¤œå‡ºæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        function showAutoDetectionSuccess() {
            const ballInstruction = document.getElementById('ballPositionInstruction');
            if (ballInstruction) {
                ballInstruction.innerHTML = 'âœ… ãƒœãƒ¼ãƒ«ä½ç½®ã‚’è‡ªå‹•æ¤œå‡ºã—ã¾ã—ãŸï¼<br><small>æ­£ã—ãæ¤œå‡ºã•ã‚Œã¦ã„ãªã„æ™‚ã¯ãƒœãƒ¼ãƒ«ã®ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</small>';
                ballInstruction.style.backgroundColor = 'rgba(40, 167, 69, 0.9)';
                ballInstruction.style.display = 'block';
                
                // è¨ºæ–­é–‹å§‹ã¾ã§è¡¨ç¤ºã—ç¶šã‘ã‚‹ï¼ˆã‚¿ã‚¤ãƒãƒ¼å‰Šé™¤ï¼‰
                // setTimeout(() => {
                //     ballInstruction.style.display = 'none';
                // }, 5000);
            }
            
            // è¨ºæ–­ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            updateDiagnosisButtonState();
            
            // æ‰‹å‹•èª¿æ•´ã®ãŸã‚ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ã‚‚æœ‰åŠ¹ã«ã—ã¦ãŠã
            isBallPositionClickEnabled = true;
            const canvas = document.getElementById('poseCanvas');
            canvas.style.cursor = 'crosshair';
            canvas.removeEventListener('click', handleBallPositionClick);
            canvas.addEventListener('click', handleBallPositionClick);
        }
        
        // ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯æŒ‡ç¤ºã‚’è¡¨ç¤º
        function showBallPositionClickInstruction() {
            const ballInstruction = document.getElementById('ballPositionInstruction');
            if (ballInstruction) {
                ballInstruction.innerHTML = 'ğŸŒï¸â€â™‚ï¸ è‡ªå‹•æ¤œå‡ºå¤±æ•—<br>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„';
                ballInstruction.style.backgroundColor = 'rgba(255, 140, 0, 0.9)';
                ballInstruction.style.display = 'block';
            }
            
            // æ‰‹å‹•ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
            isBallPositionClickEnabled = true;
            const canvas = document.getElementById('poseCanvas');
            canvas.style.cursor = 'crosshair';
            canvas.removeEventListener('click', handleBallPositionClick);
            canvas.addEventListener('click', handleBallPositionClick);
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®æç”»ï¼ˆå¾Œæ–¹è¦–ç‚¹ç”¨ï¼‰
        function drawBallPosition(ctx, landmarks, width, height) {
            const clubType = document.getElementById('clubSelect').value;
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            const leftHeel = landmarks[29];
            const rightHeel = landmarks[30];
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            
            if (!leftAnkle || !rightAnkle) return;
            
            // è¶³ã®ä½ç½®è¨ˆç®—
            const leftFootCenter = leftHeel ? leftHeel.x : leftAnkle.x;
            const rightFootCenter = rightHeel ? rightHeel.x : rightAnkle.x;
            const stanceCenter = (leftFootCenter + rightFootCenter) / 2;
            
            // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®
            const idealPositions = {
                'Driver': leftFootCenter,                // å·¦è¶³ã‹ã‹ã¨ä½ç½®
                'FairwayWood': leftFootCenter + 0.01,
                'Utility': stanceCenter - 0.02,
                '3Iron': stanceCenter - 0.015,
                '4Iron': stanceCenter - 0.01,
                '5Iron': stanceCenter - 0.005,
                '6Iron': stanceCenter,
                '7Iron': stanceCenter,
                '8Iron': stanceCenter + 0.005,
                '9Iron': stanceCenter + 0.01,
                'Wedge': stanceCenter + 0.03
            };
            
            const idealPosition = idealPositions[clubType] || stanceCenter;
            
            // æ¨å®šãƒœãƒ¼ãƒ«ä½ç½®
            let estimatedBallPosition = stanceCenter;
            if (leftWrist && rightWrist) {
                const handCenter = (leftWrist.x + rightWrist.x) / 2;
                estimatedBallPosition = handCenter;
            }
            
            // è¶³å…ƒã®é«˜ã•ã‚’å–å¾—
            const footY = Math.max(leftAnkle.y, rightAnkle.y);
            
            // ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ã‚’ç·‘ã®å††ã§æç”»ï¼ˆè¨ºæ–­é–‹å§‹å¾Œã®ã¿ï¼‰
            if (isDiagnosisStarted) {
                ctx.fillStyle = '#00FF00';
                ctx.globalAlpha = 0.7;
                ctx.beginPath();
                ctx.arc(idealPosition * width, footY * height + 20, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // ãƒ©ãƒ™ãƒ«
                ctx.fillStyle = '#00FF00';
                ctx.globalAlpha = 1.0;
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ç†æƒ³', idealPosition * width, footY * height + 45);
            }
            
            // æ¨å®šãƒœãƒ¼ãƒ«ä½ç½®ã‚’é’ã„å††ã§æç”»
            ctx.fillStyle = '#0066FF';
            ctx.globalAlpha = 0.7;
            ctx.beginPath();
            ctx.arc(estimatedBallPosition * width, footY * height + 20, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = '#0066FF';
            ctx.globalAlpha = 1.0;
            ctx.fillText('æ¨å®š', estimatedBallPosition * width, footY * height + 65);
            
            ctx.globalAlpha = 1.0;
        }

        // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯æç”»ï¼ˆMediaPipeæ¨™æº–ã‚¹ã‚¿ã‚¤ãƒ«ãƒ»å¼·åŒ–ç‰ˆï¼‰
        function drawLandmarks(ctx, landmarks, width, height) {
            console.log('Drawing landmarks, count:', landmarks.length);
            
            landmarks.forEach((landmark, index) => {
                // ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯ã‚’ç·©ãã—ã¦ã€ã‚ˆã‚Šå¤šãã®ç‚¹ã‚’è¡¨ç¤º
                if (landmark.visibility < 0.3) return; 
                
                const x = landmark.x * width;
                const y = landmark.y * height;
                
                // éƒ¨ä½åˆ¥ã®è‰²åˆ†ã‘ï¼ˆã‚ˆã‚Šé®®ã‚„ã‹ãªè‰²ï¼‰
                let color;
                if (index <= 10) {
                    color = '#FF4500'; // é¡”ãƒ»é ­éƒ¨ï¼šèµ¤ã‚ªãƒ¬ãƒ³ã‚¸
                } else if (index >= 11 && index <= 22) {
                    color = '#00CED1'; // ä¸ŠåŠèº«ï¼šãƒ€ãƒ¼ã‚¯ã‚¿ãƒ¼ã‚³ã‚¤ã‚º
                } else {
                    color = '#1E90FF'; // ä¸‹åŠèº«ï¼šãƒ‰ãƒƒã‚¸ãƒ–ãƒ«ãƒ¼
                }
                
                // é‡è¦ãªé–¢ç¯€ç‚¹ã¯å¤§ããè¡¨ç¤ºï¼ˆã•ã‚‰ã«å°ã•ãï¼‰
                const isKeyPoint = [0, 11, 12, 13, 14, 15, 16, 23, 24, 25, 26, 27, 28].includes(index);
                const radius = isKeyPoint ? 2 : 1; // ã•ã‚‰ã«å°ã•ã
                
                // é–¢ç¯€ç‚¹ã‚’èµ¤ã„å††ã§æç”»
                ctx.fillStyle = '#FF0000'; // èµ¤è‰²ã«çµ±ä¸€
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, 2 * Math.PI);
                ctx.fill();
                
                // ç•ªå·è¡¨ç¤ºã‚’å‰Šé™¤ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
                // if (isKeyPoint) {
                //     ctx.fillStyle = '#FFFFFF';
                //     ctx.font = 'bold 12px Arial';
                //     ctx.textAlign = 'center';
                //     ctx.strokeStyle = '#000000';
                //     ctx.lineWidth = 3;
                //     ctx.strokeText(index.toString(), x, y + 4);
                //     ctx.fillText(index.toString(), x, y + 4);
                // }
            });
        }

        // æ¥ç¶šç·šæç”»ï¼ˆMediaPipeæ¨™æº–æº–æ‹ ãƒ»å¼·åŒ–ç‰ˆï¼‰
        function drawConnections(ctx, landmarks, width, height) {
            console.log('Drawing connections...');
            ctx.lineWidth = 2; // ç´°ã„ç·š

            // MediaPipe Poseæ¨™æº–ã®æ¥ç¶šç·šå®šç¾©
            const connections = [
                // é¡”
                [0, 1], [1, 2], [2, 3], [3, 7], [0, 4], [4, 5], [5, 6], [6, 8],
                // ä¸ŠåŠèº«
                [9, 10], [11, 12], [11, 13], [13, 15], [15, 17], [15, 19], [15, 21], [17, 19],
                [12, 14], [14, 16], [16, 18], [16, 20], [16, 22], [18, 20],
                [11, 23], [12, 24], [23, 24],
                // ä¸‹åŠèº«
                [23, 25], [25, 27], [27, 29], [29, 31], [27, 31],
                [24, 26], [26, 28], [28, 30], [30, 32], [28, 32]
            ];

            connections.forEach(([start, end]) => {
                // ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯ã‚’ç·©ãã—ã¦ã€ã‚ˆã‚Šå¤šãã®ç·šã‚’è¡¨ç¤º
                if (landmarks[start] && landmarks[end] && 
                    landmarks[start].visibility > 0.3 && landmarks[end].visibility > 0.3) {
                    
                    // è‰²ã‚’ç·‘è‰²ã«çµ±ä¸€
                    ctx.strokeStyle = '#00FF00'; // ã™ã¹ã¦ã®æ¥ç¶šç·šã‚’ç·‘è‰²ã«
                    
                    // å½±ä»˜ãã®ç·šã‚’æç”»
                    ctx.shadowColor = 'rgba(0,0,0,0.3)';
                    ctx.shadowBlur = 2;
                    ctx.shadowOffsetX = 1;
                    ctx.shadowOffsetY = 1;
                    
                    ctx.beginPath();
                    ctx.moveTo(landmarks[start].x * width, landmarks[start].y * height);
                    ctx.lineTo(landmarks[end].x * width, landmarks[end].y * height);
                    ctx.stroke();
                    
                    // å½±ã‚’ãƒªã‚»ãƒƒãƒˆ
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;
                }
            });
        }

        // å§¿å‹¢åˆ†æ
        function analyzePosture() {
            console.log('åˆ†æé–‹å§‹ã€ãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿:', poseResults);
            
            if (!poseResults || !poseResults.poseLandmarks) {
                alert('ãƒãƒ¼ã‚ºãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ˆã‚Šæ˜ç¢ºãªå§¿å‹¢ã®ç”»åƒã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
                hideLoading();
                return;
            }

            const clubType = document.getElementById('clubSelect').value;
            const scores = calculatePostureScores(poseResults.poseLandmarks, clubType);
            
            console.log('è¨ˆç®—ã•ã‚ŒãŸã‚¹ã‚³ã‚¢:', scores);
            
            displayResults(scores);
            createRadarChart(scores);
            
            hideLoading();
        }

        // å§¿å‹¢ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆè¦–ç‚¹åˆ¥ï¼‰
        function calculatePostureScores(landmarks, clubType) {
            const viewType = document.getElementById('viewSelect').value;
            let scores = {};

            if (viewType === 'front') {
                // æ­£é¢è¦–ç‚¹ï¼šãƒœãƒ¼ãƒ«ä½ç½®ã€ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã€é‡å¿ƒé…åˆ†ã€ãƒãƒ©ãƒ³ã‚¹ã€é ­ã®ä½ç½®
                const stanceResult = evaluateStanceWidth(landmarks, clubType);
                const balanceResult = evaluateBalance(landmarks);
                const headResult = evaluateHeadPosition(landmarks);
                scores = {
                    ballPosition: evaluateBallPosition(landmarks, clubType).score,
                    ballPositionData: evaluateBallPosition(landmarks, clubType),
                    stance: stanceResult.score,
                    stanceStatus: stanceResult.status,
                    weight: evaluateWeightDistribution(landmarks, clubType),
                    balance: balanceResult.score,
                    balanceData: balanceResult,
                    headPosition: headResult.score,
                    headData: headResult
                };
            } else {
                // å¾Œæ–¹è¦–ç‚¹ï¼šä½“ã®å‘ãã€å‰å‚¾è§’åº¦ã€æ‰‹ã®ä½ç½®ã€å‰å¾Œã®é‡å¿ƒã€èƒŒç­‹ã®æ›²ãŒã‚Šå…·åˆ
                scores = {
                    bodyAlignment: evaluateBodyAlignment(landmarks),
                    forwardTilt: evaluateForwardTilt(landmarks),
                    handPosition: evaluateHandPosition(landmarks, clubType),
                    frontBackWeight: evaluateFrontBackWeight(landmarks),
                    spinalCurve: evaluateSpinalCurve(landmarks)
                };
            }

            // ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆæ•°å€¤ã®ã¿ã‚’å¯¾è±¡ï¼‰
            const numericScores = Object.entries(scores).filter(([key, value]) => 
                typeof value === 'number' && key !== 'total'
            ).map(([key, value]) => value);
            
            const totalScore = numericScores.reduce((sum, score) => sum + score, 0) / numericScores.length;
            scores.total = Math.round(totalScore);

            return scores;
        }

        // æ–°ã—ã„è©•ä¾¡é–¢æ•°ï¼ˆå¾Œæ–¹è¦–ç‚¹ç”¨ï¼‰
        
        // ä½“ã®å‘ãè©•ä¾¡ï¼ˆè‚©ã€è…°ã€ã‹ã‹ã¨ã®ãƒ©ã‚¤ãƒ³ï¼‰
        function evaluateBodyAlignment(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftHeel = landmarks[29];
            const rightHeel = landmarks[30];
            
            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip || !leftHeel || !rightHeel) return 0;
            
            // è‚©ã€è…°ã€ã‹ã‹ã¨ã®ãƒ©ã‚¤ãƒ³ãŒå¹³è¡Œã‹ã©ã†ã‹ã‚’è©•ä¾¡
            const shoulderLine = Math.abs(leftShoulder.x - rightShoulder.x);
            const hipLine = Math.abs(leftHip.x - rightHip.x);
            const heelLine = Math.abs(leftHeel.x - rightHeel.x);
            
            const alignmentDeviation = Math.abs(shoulderLine - hipLine) + Math.abs(hipLine - heelLine);
            
            if (alignmentDeviation < 0.02) return 95;
            if (alignmentDeviation < 0.04) return 85;
            if (alignmentDeviation < 0.06) return 75;
            if (alignmentDeviation < 0.08) return 65;
            return 50;
        }
        
        // å‰å‚¾è§’åº¦è©•ä¾¡
        function evaluateForwardTilt(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!nose || !leftShoulder || !rightShoulder || !leftHip || !rightHip) return 0;
            
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            
            // å‰å‚¾è§’åº¦ã‚’è¨ˆç®—
            const tiltAngle = Math.atan2(shoulderCenter.y - hipCenter.y, shoulderCenter.x - hipCenter.x) * 180 / Math.PI;
            const idealTilt = 20; // ç†æƒ³çš„ãªå‰å‚¾è§’åº¦
            const deviation = Math.abs(Math.abs(tiltAngle) - idealTilt);
            
            if (deviation < 5) return 95;
            if (deviation < 10) return 85;
            if (deviation < 15) return 75;
            if (deviation < 20) return 65;
            return 50;
        }
        
        // æ‰‹ã®ä½ç½®è©•ä¾¡
        function evaluateHandPosition(landmarks, clubType) {
            const leftWrist = landmarks[15];
            const rightWrist = landmarks[16];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!leftWrist || !rightWrist || !leftShoulder || !rightShoulder) return 0;
            
            const handCenter = {
                x: (leftWrist.x + rightWrist.x) / 2,
                y: (leftWrist.y + rightWrist.y) / 2
            };
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            
            // æ‰‹ã¨è‚©ã®ä½ç½®é–¢ä¿‚ã‚’è©•ä¾¡
            const handDistance = Math.abs(handCenter.x - shoulderCenter.x);
            
            let idealDistance;
            if (clubType === 'Driver') {
                idealDistance = 0.03; // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯å°‘ã—å‰
            } else {
                idealDistance = 0.01; // ä»–ã®ã‚¯ãƒ©ãƒ–ã¯è‚©ã®çœŸä¸‹
            }
            
            const deviation = Math.abs(handDistance - idealDistance);
            
            if (deviation < 0.01) return 95;
            if (deviation < 0.02) return 85;
            if (deviation < 0.03) return 75;
            if (deviation < 0.04) return 65;
            return 50;
        }
        
        // å‰å¾Œã®é‡å¿ƒè©•ä¾¡
        function evaluateFrontBackWeight(landmarks) {
            const nose = landmarks[0];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftAnkle = landmarks[27];
            const rightAnkle = landmarks[28];
            
            if (!nose || !leftHip || !rightHip || !leftAnkle || !rightAnkle) return 0;
            
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            const ankleCenter = {
                x: (leftAnkle.x + rightAnkle.x) / 2,
                y: (leftAnkle.y + rightAnkle.y) / 2
            };
            
            // å‰å¾Œã®é‡å¿ƒãƒãƒ©ãƒ³ã‚¹ã‚’è©•ä¾¡
            const weightBalance = Math.abs(hipCenter.x - ankleCenter.x);
            
            if (weightBalance < 0.02) return 95;
            if (weightBalance < 0.04) return 85;
            if (weightBalance < 0.06) return 75;
            if (weightBalance < 0.08) return 65;
            return 50;
        }
        
        // èƒŒç­‹ã®æ›²ãŒã‚Šå…·åˆè©•ä¾¡
        function evaluateSpinalCurve(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!nose || !leftShoulder || !rightShoulder || !leftHip || !rightHip) return 0;
            
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            
            // èƒŒç­‹ã®è‡ªç„¶ãªã‚«ãƒ¼ãƒ–ã‚’è©•ä¾¡ï¼ˆç°¡ç•¥åŒ–ï¼‰
            const spineDeviation = Math.abs(nose.x - shoulderCenter.x) + Math.abs(shoulderCenter.x - hipCenter.x);
            
            if (spineDeviation < 0.03) return 95;
            if (spineDeviation < 0.06) return 85;
            if (spineDeviation < 0.09) return 75;
            if (spineDeviation < 0.12) return 65;
            return 50;
        }
        
        // æ—§è©•ä¾¡é–¢æ•°ï¼ˆæ­£é¢è¦–ç‚¹ç”¨ã«ä¿æŒï¼‰
        
        // è„Šæ¤è§’åº¦è©•ä¾¡ï¼ˆæ­£é¢ãƒ»å¾Œé¢è¦–ç‚¹å¯¾å¿œï¼‰
        function evaluateSpineAngle(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip) return 0;
            
            // æ­£é¢è¦–ç‚¹ã§ã®è„Šæ¤ã®ç›´ç·šæ€§ã‚’è©•ä¾¡
            const shoulderCenter = {
                x: (leftShoulder.x + rightShoulder.x) / 2,
                y: (leftShoulder.y + rightShoulder.y) / 2
            };
            const hipCenter = {
                x: (leftHip.x + rightHip.x) / 2,
                y: (leftHip.y + rightHip.y) / 2
            };
            
            // æ°´å¹³ã‹ã‚‰ã®å‚¾ãã‚’è¨ˆç®—
            const spineDeviation = Math.abs(shoulderCenter.x - hipCenter.x);
            
            if (spineDeviation < 0.02) return 95;
            if (spineDeviation < 0.04) return 85;
            if (spineDeviation < 0.06) return 75;
            if (spineDeviation < 0.08) return 65;
            return 50;
        }

        // è‚©ã®ä½ç½®è©•ä¾¡ï¼ˆæ­£é¢è¦–ç‚¹æœ€é©åŒ–ï¼‰
        function evaluateShoulderAlignment(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!leftShoulder || !rightShoulder) return 0;
            
            // æ­£é¢è¦–ç‚¹ã§ã®è‚©ã®æ°´å¹³åº¦ã‚’è©•ä¾¡
            const heightDiff = Math.abs(leftShoulder.y - rightShoulder.y);
            
            // æ­£é¢ã‹ã‚‰ã¯è‚©ã®é«˜ã•ã®é•ã„ãŒã‚ˆã‚Šæ˜ç¢ºã«è¦‹ãˆã‚‹
            if (heightDiff < 0.015) return 95;
            if (heightDiff < 0.03) return 85;
            if (heightDiff < 0.045) return 75;
            if (heightDiff < 0.06) return 65;
            return 50;
        }

        // è†ã®ä½ç½®è©•ä¾¡ï¼ˆæ­£é¢è¦–ç‚¹æœ€é©åŒ–ï¼‰
        function evaluateKneeAlignment(landmarks) {
            const leftKnee = landmarks[25];
            const rightKnee = landmarks[26];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftKnee || !rightKnee || !leftHip || !rightHip) return 0;
            
            // æ­£é¢è¦–ç‚¹ã§ã®è†ã®ä½ç½®ã‚’è‚¡é–¢ç¯€ã¨ã®é–¢ä¿‚ã§è©•ä¾¡
            const leftKneeAlignment = Math.abs(leftKnee.x - leftHip.x);
            const rightKneeAlignment = Math.abs(rightKnee.x - rightHip.x);
            
            // è†ã®é«˜ã•ã®æƒã„å…·åˆã‚‚è©•ä¾¡
            const kneeHeightDiff = Math.abs(leftKnee.y - rightKnee.y);
            
            const avgAlignment = (leftKneeAlignment + rightKneeAlignment) / 2;
            const totalDeviation = avgAlignment + kneeHeightDiff;
            
            if (totalDeviation < 0.03) return 95;
            if (totalDeviation < 0.06) return 85;
            if (totalDeviation < 0.09) return 75;
            if (totalDeviation < 0.12) return 65;
            return 50;
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®è©•ä¾¡ï¼ˆæ”¹è‰¯ç‰ˆãƒ»ã‚¯ãƒªãƒƒã‚¯å¯¾å¿œï¼‰
        function evaluateBallPosition(landmarks, clubType) {
            const leftAnkle = landmarks[27]; // å·¦è¶³é¦–
            const rightAnkle = landmarks[28]; // å³è¶³é¦–
            const leftHeel = landmarks[29]; // å·¦ã‹ã‹ã¨
            const rightHeel = landmarks[30]; // å³ã‹ã‹ã¨
            const leftToe = landmarks[31]; // å·¦ã¤ã¾å…ˆ
            const rightToe = landmarks[32]; // å³ã¤ã¾å…ˆ
            
            if (!leftAnkle || !rightAnkle || !leftHeel || !rightHeel) return 0;
            
            // ã‚ˆã‚Šæ­£ç¢ºãªè¶³ã®ä½ç½®è¨ˆç®—
            const leftFootCenter = leftHeel ? leftHeel.x : leftAnkle.x;
            const rightFootCenter = rightHeel ? rightHeel.x : rightAnkle.x;
            const stanceCenter = (leftFootCenter + rightFootCenter) / 2;
            
            // ã‚¯ãƒ©ãƒ–åˆ¥ã®ç†æƒ³çš„ãªãƒœãƒ¼ãƒ«ä½ç½®ï¼ˆå·¦è¶³ã‹ã‹ã¨å†…å´ã‚’åŸºæº–ï¼‰
            const idealPositions = {
                'Driver': leftFootCenter,                // å·¦è¶³ã‹ã‹ã¨ä½ç½®
                'FairwayWood': leftFootCenter + 0.02,   // å·¦è¶³ã‹ã‹ã¨å†…å´ã‚ˆã‚Šå°‘ã—å³
                'Utility': stanceCenter - 0.02,        // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '3Iron': stanceCenter - 0.015,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '4Iron': stanceCenter - 0.01,          // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '5Iron': stanceCenter - 0.005,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦
                '6Iron': stanceCenter,                  // ä¸­å¤®
                '7Iron': stanceCenter,                  // ä¸­å¤®
                '8Iron': stanceCenter + 0.005,         // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³
                '9Iron': stanceCenter + 0.01,          // ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³
                'Wedge': stanceCenter + 0.03           // ä¸­å¤®ã‚ˆã‚Šå³
            };
            
            // å®Ÿéš›ã®ãƒœãƒ¼ãƒ«ä½ç½®ã‚’æ±ºå®š
            let actualBallPosition;
            
            if (userClickedBallPosition && document.getElementById('viewSelect').value === 'front') {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã‚’ä½¿ç”¨
                actualBallPosition = userClickedBallPosition.x;
            } else {
                // æ‰‹é¦–ã®ä½ç½®ã‹ã‚‰æ¨å®š
                const leftWrist = landmarks[15];
                const rightWrist = landmarks[16];
                actualBallPosition = stanceCenter; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                
                if (leftWrist && rightWrist) {
                    // æ‰‹é¦–ã®ä¸­å¤®ã‹ã‚‰ãƒœãƒ¼ãƒ«ä½ç½®ã‚’æ¨å®š
                    const handCenter = (leftWrist.x + rightWrist.x) / 2;
                    actualBallPosition = handCenter;
                }
            }
            
            const idealPosition = idealPositions[clubType] || stanceCenter;
            const deviation = Math.abs(actualBallPosition - idealPosition);
            const isLeftOfIdeal = actualBallPosition > idealPosition; // ç†æƒ³ä½ç½®ã‚ˆã‚Šå·¦ã«ã‚ã‚‹ï¼ˆMediaPipeåº§æ¨™ç³»ã§ã¯é€†ï¼‰
            
            // ã‚¹ã‚³ã‚¢è¨ˆç®—
            let score;
            if (deviation < 0.025) score = 95; // è¨±å®¹ç¯„å›²ã‚’åºƒã
            else if (deviation < 0.05) score = 90;  // 90ç‚¹å°ã‚‚è¿½åŠ 
            else if (deviation < 0.075) score = 85;
            else if (deviation < 0.10) score = 75;
            else if (deviation < 0.125) score = 65;
            else score = 50;
            
            return {
                score: score,
                actualPosition: actualBallPosition,
                idealPosition: idealPosition,
                deviation: deviation,
                isLeftOfIdeal: isLeftOfIdeal,
                clubType: clubType
            };
        }

        // ã‚¹ã‚¿ãƒ³ã‚¹å¹…è©•ä¾¡
        function evaluateStanceWidth(landmarks, clubType) {
            const leftFoot = landmarks[27];
            const rightFoot = landmarks[28];
            
            if (!leftFoot || !rightFoot) return { score: 0, status: 'unknown' };
            
            const stanceWidth = Math.abs(leftFoot.x - rightFoot.x);
            
            const idealWidths = {
                'Driver': 0.25,
                'FairwayWood': 0.23,
                'Utility': 0.22,
                '3Iron': 0.21,
                '4Iron': 0.21,
                '5Iron': 0.20,
                '6Iron': 0.20,
                '7Iron': 0.20,
                '8Iron': 0.19,
                '9Iron': 0.19,
                'Wedge': 0.18
            };
            
            const idealWidth = idealWidths[clubType] || 0.20;
            const deviation = stanceWidth - idealWidth;
            
            let score, status;
            
            if (Math.abs(deviation) < 0.02) {
                score = 95;
                status = 'ideal';
            } else if (Math.abs(deviation) < 0.04) {
                score = 85;
                status = deviation > 0 ? 'slightly_wide' : 'slightly_narrow';
            } else if (Math.abs(deviation) < 0.06) {
                score = 75;
                status = deviation > 0 ? 'wide' : 'narrow';
            } else if (Math.abs(deviation) < 0.08) {
                score = 65;
                status = deviation > 0 ? 'too_wide' : 'too_narrow';
            } else {
                score = 50;
                status = deviation > 0 ? 'much_too_wide' : 'much_too_narrow';
            }
            
            return { 
                score: score, 
                status: status
            };
        }

        // é‡å¿ƒé…åˆ†è©•ä¾¡ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
        function evaluateWeightDistribution(landmarks, clubType) {
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            const leftFoot = landmarks[27];
            const rightFoot = landmarks[28];
            
            if (!leftHip || !rightHip || !leftFoot || !rightFoot) return 0;
            
            // é‡å¿ƒä½ç½®ã‚’æ¨å®šï¼ˆè…°ã®ä½ç½®ã¨è¶³ã®ä½ç½®ã‹ã‚‰ï¼‰
            const hipCenter = (leftHip.x + rightHip.x) / 2;
            const footCenter = (leftFoot.x + rightFoot.x) / 2;
            
            // å·¦å³ã®é‡å¿ƒé…åˆ†ã‚’è¨ˆç®—
            const weightDistribution = (hipCenter - footCenter) / Math.abs(leftFoot.x - rightFoot.x);
            
            if (clubType === 'Driver') {
                // ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼š6:4ã§å³é‡å¿ƒãŒç†æƒ³
                const idealRightWeight = 0.1; // å³ã«10%åã£ãŸçŠ¶æ…‹
                const deviation = Math.abs(weightDistribution - idealRightWeight);
                
                if (deviation < 0.05) return 95;
                if (deviation < 0.10) return 85;
                if (deviation < 0.15) return 75;
                if (deviation < 0.20) return 65;
                return 50;
            } else {
                // ãã®ä»–ã®ã‚¯ãƒ©ãƒ–ï¼š5:5ã§å‡ç­‰ãŒç†æƒ³
                const deviation = Math.abs(weightDistribution);
                
                if (deviation < 0.03) return 95;
                if (deviation < 0.06) return 85;
                if (deviation < 0.09) return 75;
                if (deviation < 0.12) return 65;
                return 50;
            }
        }

        // ãƒãƒ©ãƒ³ã‚¹è©•ä¾¡
        function evaluateBalance(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            if (!leftShoulder || !rightShoulder || !leftHip || !rightHip) return { score: 0, currentValue: 0, idealValue: 0, unit: 'cm' };
            
            const shoulderCenter = (leftShoulder.x + rightShoulder.x) / 2;
            const hipCenter = (leftHip.x + rightHip.x) / 2;
            const balance = Math.abs(shoulderCenter - hipCenter);
            
            // ãƒãƒ©ãƒ³ã‚¹ã®ã‚ºãƒ¬ã‚’cmå˜ä½ã«å¤‰æ›ï¼ˆä»®æƒ³çš„ãªå¤‰æ›ï¼‰
            const balanceInCm = balance * 100; // 0.01 = 1cmç›¸å½“ã¨ä»®å®š
            
            let score;
            if (balance < 0.02) score = 95;
            else if (balance < 0.04) score = 85;
            else if (balance < 0.06) score = 75;
            else if (balance < 0.08) score = 65;
            else score = 50;
            
            return {
                score: score,
                currentValue: Math.round(balanceInCm * 10) / 10,
                idealValue: 0,
                unit: 'cmã®ã‚ºãƒ¬'
            };
        }

        // é ­ã®ä½ç½®è©•ä¾¡
        function evaluateHeadPosition(landmarks) {
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            
            if (!nose || !leftShoulder || !rightShoulder) return { score: 0, currentValue: 0, idealValue: 0, unit: 'cm' };
            
            const shoulderCenter = (leftShoulder.x + rightShoulder.x) / 2;
            const headPosition = Math.abs(nose.x - shoulderCenter);
            
            // é ­ã®ã‚ºãƒ¬ã‚’cmå˜ä½ã«å¤‰æ›
            const headOffsetInCm = headPosition * 100;
            
            let score;
            if (headPosition < 0.03) score = 95;
            else if (headPosition < 0.06) score = 85;
            else if (headPosition < 0.09) score = 75;
            else if (headPosition < 0.12) score = 65;
            else score = 50;
            
            return {
                score: score,
                currentValue: Math.round(headOffsetInCm * 10) / 10,
                idealValue: 0,
                unit: 'cmã®ã‚ºãƒ¬'
            };
        }

        // çµæœè¡¨ç¤ºï¼ˆã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’çµ±åˆï¼‰
        function displayResults(scores) {
            const scoreFeedbackGrid = document.getElementById('scoreFeedbackGrid');
            scoreFeedbackGrid.innerHTML = '';
            const viewType = document.getElementById('viewSelect').value;

            // è¦–ç‚¹åˆ¥ã«è¡¨ç¤ºé …ç›®ã‚’å¤‰æ›´
            let scoreItems;
            if (viewType === 'front') {
                scoreItems = [
                    { key: 'total', label: 'ç·åˆã‚¹ã‚³ã‚¢' },
                    { key: 'ballPosition', label: 'ãƒœãƒ¼ãƒ«ä½ç½®' },
                    { key: 'stance', label: 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…' },
                    { key: 'weight', label: 'é‡å¿ƒé…åˆ†' },
                    { key: 'balance', label: 'ãƒãƒ©ãƒ³ã‚¹' },
                    { key: 'headPosition', label: 'é ­ã®ä½ç½®' }
                ];
            } else {
                scoreItems = [
                    { key: 'total', label: 'ç·åˆã‚¹ã‚³ã‚¢' },
                    { key: 'bodyAlignment', label: 'ä½“ã®å‘ã' },
                    { key: 'forwardTilt', label: 'å‰å‚¾è§’åº¦' },
                    { key: 'handPosition', label: 'æ‰‹ã®ä½ç½®' },
                    { key: 'frontBackWeight', label: 'å‰å¾Œã®é‡å¿ƒ' },
                    { key: 'spinalCurve', label: 'èƒŒç­‹ã®æ›²ãŒã‚Š' }
                ];
            }

            const advice = generateAdvice(scores);

            scoreItems.forEach(item => {
                if (scores[item.key] !== undefined) {
                    const scoreValue = scores[item.key];
                    const scoreClass = getScoreClass(scoreValue);
                    
                    const scoreElement = document.createElement('div');
                    scoreElement.className = `score-feedback-item ${scoreClass}`;
                    scoreElement.innerHTML = `
                        <div class="score-header">
                            <div class="score-title">${item.label}</div>
                            <div class="score-value">${scoreValue}ç‚¹</div>
                        </div>
                        <div class="advice-text">${advice[item.key]}</div>
                    `;
                    scoreFeedbackGrid.appendChild(scoreElement);
                }
            });
        }

        // ã‚¹ã‚³ã‚¢ã‚¯ãƒ©ã‚¹åˆ¤å®š
        function getScoreClass(score) {
            if (score >= 90) return 'score-excellent';
            if (score >= 80) return 'score-good';
            if (score >= 70) return 'score-average';
            return 'score-poor';
        }

        // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆä½œæˆï¼ˆè¦–ç‚¹åˆ¥ï¼‰
        function createRadarChart(scores) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const viewType = document.getElementById('viewSelect').value;
            
            if (radarChartInstance) {
                radarChartInstance.destroy();
            }

            let labels, scoreData, idealData;
            
            if (viewType === 'front') {
                labels = ['ãƒœãƒ¼ãƒ«ä½ç½®', 'ã‚¹ã‚¿ãƒ³ã‚¹å¹…', 'é‡å¿ƒé…åˆ†', 'ãƒãƒ©ãƒ³ã‚¹', 'é ­ã®ä½ç½®'];
                scoreData = [
                    scores.ballPosition,
                    scores.stance,
                    scores.weight,
                    scores.balance,
                    scores.headPosition
                ];
                idealData = [100, 100, 100, 100, 100];
            } else {
                labels = ['ä½“ã®å‘ã', 'å‰å‚¾è§’åº¦', 'æ‰‹ã®ä½ç½®', 'å‰å¾Œã®é‡å¿ƒ', 'èƒŒç­‹ã®æ›²ãŒã‚Š'];
                scoreData = [
                    scores.bodyAlignment,
                    scores.forwardTilt,
                    scores.handPosition,
                    scores.frontBackWeight,
                    scores.spinalCurve
                ];
                idealData = [100, 100, 100, 100, 100];
            }

            const data = {
                labels: labels,
                datasets: [{
                    label: 'ã‚ãªãŸã®ã‚¹ã‚³ã‚¢',
                    data: scoreData,
                    backgroundColor: 'rgba(102, 126, 234, 0.3)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 3,
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(102, 126, 234, 1)',
                    pointHoverRadius: 8
                }, {
                    label: 'ç†æƒ³å€¤',
                    data: idealData,
                    backgroundColor: 'rgba(40, 167, 69, 0.15)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(40, 167, 69, 1)',
                    pointHoverRadius: 7
                }]
            };

            const config = {
                type: 'radar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#333'
                            },
                            pointLabels: {
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: '#333',
                                padding: 15
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#333',
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: `ã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹åˆ†æ - ${viewType === 'front' ? 'æ­£é¢è¦–ç‚¹' : 'å¾Œæ–¹è¦–ç‚¹'}`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333',
                            padding: 20
                        }
                    }
                }
            };

            radarChartInstance = new Chart(ctx, config);
        }

        // ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function getStanceAdvice(stanceStatus, clubType) {
            // ç†æƒ³ã®è¡¨ç¾ã‚’åˆ†ã‹ã‚Šã‚„ã™ã
            const idealDescription = clubType === 'Driver' ? 
                'è‚©å¹…ã‚ˆã‚Šã‚‚å°‘ã—åºƒã‚' :
                'è‚©å¹…ç¨‹åº¦';
                
            switch(stanceStatus) {
                case 'slightly_narrow':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚å°‘ã—ç‹­ã‚ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'narrow':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚ç‹­ã„ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'too_narrow':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚ã‹ãªã‚Šç‹­ã„ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'much_too_narrow':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚éå¸¸ã«ç‹­ã™ãã¾ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'slightly_wide':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚å°‘ã—åºƒã‚ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'wide':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚åºƒã„ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'too_wide':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚ã‹ãªã‚Šåºƒã„ã§ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                case 'much_too_wide':
                    return `ç¾çŠ¶ã¯ç†æƒ³ã‚ˆã‚Šã‚‚éå¸¸ã«åºƒã™ãã¾ã™ã€‚\nğŸ“ ç†æƒ³ï¼š${idealDescription}`;
                default:
                    return `ç†æƒ³ï¼š${idealDescription}`;
            }
        }

        // ãƒœãƒ¼ãƒ«ä½ç½®ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function getBallPositionAdvice(score, ballPositionData) {
            if (score >= 80) {
                return 'ãƒœãƒ¼ãƒ«ä½ç½®ã¯é©åˆ‡ã§ã™ã€‚ã“ã®ä½ç½®ã‚’æ„è­˜ã—ã¦ã‚¢ãƒ‰ãƒ¬ã‚¹ã—ã¾ã—ã‚‡ã†ã€‚';
            }
            
            if (!ballPositionData) {
                return 'ãƒœãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚';
            }
            
            const { clubType, isLeftOfIdeal } = ballPositionData;
            
            // ã‚¯ãƒ©ãƒ–åˆ¥ã®ç†æƒ³ä½ç½®ã®èª¬æ˜
            const idealDescription = getIdealBallPositionDescription(clubType);
            
            // ç¾åœ¨ä½ç½®ãŒç†æƒ³ä½ç½®ã‚ˆã‚Šã‚‚å·¦ã«ã‚ã‚‹ã‹å³ã«ã‚ã‚‹ã‹
            const direction = isLeftOfIdeal ? 'å³å¯„ã‚Š' : 'å·¦å¯„ã‚Š';
            const currentStatus = isLeftOfIdeal ? 'ç†æƒ³ã‚ˆã‚Šã‚‚å·¦' : 'ç†æƒ³ã‚ˆã‚Šã‚‚å³';
            
            return `ç¾çŠ¶ã¯${currentStatus}ã«ã‚ã‚Šã¾ã™ã€‚\nğŸŒï¸â€â™‚ï¸ ç†æƒ³ï¼š${idealDescription}\nğŸ’¡ ${direction}ã«èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚`;
        }
        
        // ç†æƒ³ãƒœãƒ¼ãƒ«ä½ç½®ã®èª¬æ˜
        function getIdealBallPositionDescription(clubType) {
            switch(clubType) {
                case 'Driver':
                    return 'å·¦è¶³ã‹ã‹ã¨ä½ç½®';
                case 'FairwayWood':
                    return 'å·¦è¶³ã‹ã‹ã¨å†…å´ã‚ˆã‚Šå°‘ã—å³';
                case 'Utility':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦';
                case '3Iron':
                case '4Iron':
                case '5Iron':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®ã‚ˆã‚Šå°‘ã—å·¦';
                case '6Iron':
                case '7Iron':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®';
                case '8Iron':
                case '9Iron':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®ã‚ˆã‚Šå°‘ã—å³';
                case 'Wedge':
                    return 'ã‚¹ã‚¿ãƒ³ã‚¹ä¸­å¤®ã‚ˆã‚Šå³';
                default:
                    return 'ã‚¯ãƒ©ãƒ–ã«å¿œã˜ãŸé©åˆ‡ãªä½ç½®';
            }
        }

        // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        function generateAdvice(scores) {
            const clubType = document.getElementById('clubSelect').value;
            const viewType = document.getElementById('viewSelect').value;
            
            let advice = {
                total: scores.total >= 90 ? 
                    'ğŸ† ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãªã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ï¼ã“ã®ç´ æ™´ã‚‰ã—ã„å§¿å‹¢ã‚’ç¶­æŒã—ã¦ã‚¹ã‚¤ãƒ³ã‚°ã—ã¾ã—ã‚‡ã†ã€‚ãƒ—ãƒ­ãƒ¬ãƒ™ãƒ«ã®å®‰å®šã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®èª¿å­ã§ãƒ©ã‚¦ãƒ³ãƒ‰ã«è‡¨ã‚ã°ã€ãã£ã¨è‰¯ã„ã‚¹ã‚³ã‚¢ãŒæœŸå¾…ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚' :
                    scores.total >= 85 ? 
                    'âœ¨ éå¸¸ã«è‰¯ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ï¼ã»ã¼ç†æƒ³çš„ãªå§¿å‹¢ãŒå–ã‚Œã¦ã„ã¾ã™ã€‚ç´°ã‹ã„å¾®èª¿æ•´ã‚’è¡Œã†ã“ã¨ã§ã€ã•ã‚‰ã«å®‰å®šã—ãŸã‚·ãƒ§ãƒƒãƒˆãŒæ‰“ã¦ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã®åŸºæœ¬å§¿å‹¢ã‚’ãƒ™ãƒ¼ã‚¹ã«ç·´ç¿’ã‚’ç©ã¿é‡ã­ã¾ã—ã‚‡ã†ã€‚' :
                    scores.total >= 75 ? 
                    'ğŸ‘ è‰¯ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚åŸºæœ¬çš„ãªå§¿å‹¢ã¯ç¿’å¾—ã§ãã¦ãŠã‚Šã€ã„ãã¤ã‹ã®ãƒã‚¤ãƒ³ãƒˆã‚’æ”¹å–„ã™ã‚‹ã“ã¨ã§ã‚ˆã‚Šè‰¯ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãªã‚Šã¾ã™ã€‚ç¶™ç¶šçš„ãªç·´ç¿’ã§ç¢ºå®Ÿã«ä¸Šé”ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚' :
                    scores.total >= 65 ? 
                    'âš ï¸ ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚ã„ãã¤ã‹ã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’è¦‹ç›´ã™ã“ã¨ã§ã€ã‚ˆã‚Šå®‰å®šã—ãŸã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚åŸºæœ¬ã«ç«‹ã¡è¿”ã£ã¦ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚' :
                    scores.total >= 50 ? 
                    'ğŸ“š ã‚¢ãƒ‰ãƒ¬ã‚¹ã®åŸºæœ¬ã‹ã‚‰è¦‹ç›´ã—ã¾ã—ã‚‡ã†ã€‚ç¾åœ¨ã®å§¿å‹¢ã§ã¯å®‰å®šã—ãŸã‚·ãƒ§ãƒƒãƒˆãŒé›£ã—ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚åŸºæœ¬çš„ãªã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¦ç´ ã‚’ä¸€ã¤ãšã¤ç¢ºèªã—ã€æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒ ã‚’èº«ã«ã¤ã‘ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚' :
                    'ğŸ”„ ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ ¹æœ¬ã‹ã‚‰è¦‹ç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚åŸºæœ¬çš„ãªæ§‹ãˆæ–¹ã‹ã‚‰å­¦ã³ç›´ã™ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ãƒ—ãƒ­ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’å—ã‘ã‚‹ã‹ã€åŸºæœ¬çš„ãªæ•™æã‚’å‚è€ƒã«ã—ã¦ã€æ­£ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¿’å¾—ã—ã¾ã—ã‚‡ã†ã€‚ç¶™ç¶šçš„ãªç·´ç¿’ãŒå¿…è¦ã§ã™ã€‚',
                
                spine: scores.spine >= 80 ? 
                    'è„Šæ¤ã®ç›´ç·šæ€§ã¯è‰¯å¥½ã§ã™ã€‚ã“ã®å§¿å‹¢ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                    'æ­£é¢ã‹ã‚‰è¦‹ã¦ã€è‚©ã¨è…°ã®ä¸­å¿ƒãŒä¸€ç›´ç·šã«ãªã‚‹ã‚ˆã†æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚å·¦å³ã®å‚¾ãã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚',
                
                shoulder: scores.shoulder >= 80 ? 
                    'è‚©ã®ä½ç½®ã¯é©åˆ‡ã§ã™ã€‚ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸçŠ¶æ…‹ã‚’ä¿ã¡ã¾ã—ã‚‡ã†ã€‚' :
                    'ä¸¡è‚©ã®é«˜ã•ã‚’æƒãˆã¦ãã ã•ã„ã€‚æ­£é¢ã‹ã‚‰è¦‹ã¦æ°´å¹³ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚',
                
                knee: scores.knee >= 80 ? 
                    'è†ã®ä½ç½®ã¯è‰¯å¥½ã§ã™ã€‚ã“ã®å®‰å®šã—ãŸã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                    'è†ãŒè‚¡é–¢ç¯€ã®çœŸä¸‹ã«æ¥ã‚‹ã‚ˆã†èª¿æ•´ã—ã€ä¸¡è†ã®é«˜ã•ã‚’æƒãˆã¾ã—ã‚‡ã†ã€‚',
                
                ballPosition: getBallPositionAdvice(scores.ballPosition, scores.ballPositionData),
                
                stance: scores.stance >= 80 ? 
                    (clubType === 'Driver' ? 
                        'ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã¯é©åˆ‡ã§ã™ã€‚ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯è‚©å¹…ã‚ˆã‚Šã‚‚å°‘ã—åºƒã„ãã‚‰ã„ãŒç†æƒ³ã§ã™ã€‚' :
                        'ã‚¹ã‚¿ãƒ³ã‚¹å¹…ã¯é©åˆ‡ã§ã™ã€‚è‚©å¹…ãŒç†æƒ³çš„ã§ã™ã€‚') :
                    getStanceAdvice(scores.stanceStatus, clubType),
                
                weight: scores.weight >= 80 ? 
                    'é‡å¿ƒé…åˆ†ã¯é©åˆ‡ã§ã™ã€‚ã“ã®æ„Ÿè¦šã‚’è¦šãˆã¦ãŠãã¾ã—ã‚‡ã†ã€‚' :
                    clubType === 'Driver' ? 
                    'é‡å¿ƒã‚’ã‚‚ã†å°‘ã—å³è¶³ã«ç§»ã—ã¾ã—ã‚‡ã†ï¼ˆ6:4ã®é…åˆ†ï¼‰ã€‚ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã§ã¯å³é‡å¿ƒãŒç†æƒ³ã§ã™ã€‚' :
                    'é‡å¿ƒã‚’å·¦å³å‡ç­‰ã«é…åˆ†ã—ã¾ã—ã‚‡ã†ï¼ˆ5:5ã®é…åˆ†ï¼‰ã€‚ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚',
                
                balance: scores.balance >= 80 ? 
                    'ãƒãƒ©ãƒ³ã‚¹ã¯è‰¯å¥½ã§ã™ã€‚ã“ã®å®‰å®šã—ãŸå§¿å‹¢ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                    `ä¸ŠåŠèº«ã¨ä¸‹åŠèº«ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ•´ãˆã¾ã—ã‚‡ã†ã€‚é‡å¿ƒã‚’ä¸­å¤®ã«ä¿ã¡ã¾ã™ã€‚${scores.balanceData ? `\nğŸ“ ç¾çŠ¶ï¼š${scores.balanceData.currentValue}${scores.balanceData.unit} / ç†æƒ³ï¼š${scores.balanceData.idealValue}${scores.balanceData.unit}` : ''}`,
                
                headPosition: scores.headPosition >= 80 ? 
                    'é ­ã®ä½ç½®ã¯é©åˆ‡ã§ã™ã€‚ã“ã®çŠ¶æ…‹ã‚’ä¿ã¡ã¾ã—ã‚‡ã†ã€‚' :
                    `é ­ã‚’ä¸¡è‚©ã®ä¸­å¤®ã«ä½ç½®ã•ã›ã¾ã—ã‚‡ã†ã€‚å·¦å³ã«å‚¾ã‹ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚${scores.headData ? `\nğŸ“ ç¾çŠ¶ï¼š${scores.headData.currentValue}${scores.headData.unit} / ç†æƒ³ï¼š${scores.headData.idealValue}${scores.headData.unit}` : ''}`
            };
            
            if (viewType === 'back') {
                advice = {
                    ...advice,
                    bodyAlignment: scores.bodyAlignment >= 80 ? 
                        'ä½“ã®å‘ãã¯è‰¯å¥½ã§ã™ã€‚è‚©ã€è…°ã€ã‹ã‹ã¨ãŒé©åˆ‡ã«æƒã£ã¦ã„ã¾ã™ã€‚' :
                        'è‚©ã€è…°ã€ã‹ã‹ã¨ã®å‘ãã‚’ç›®æ¨™æ–¹å‘ã«æƒãˆã¾ã—ã‚‡ã†ã€‚å¹³è¡Œã«ãªã‚‹ã‚ˆã†æ„è­˜ã—ã¦ãã ã•ã„ã€‚',
                    
                    forwardTilt: scores.forwardTilt >= 80 ? 
                        'å‰å‚¾è§’åº¦ã¯é©åˆ‡ã§ã™ã€‚ã“ã®è§’åº¦ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                        'å‰å‚¾è§’åº¦ã‚’èª¿æ•´ã—ã¾ã—ã‚‡ã†ã€‚è‚¡é–¢ç¯€ã‹ã‚‰å‰å‚¾ã—ã€èƒŒç­‹ã¯ã¾ã£ã™ãä¿ã¡ã¾ã™ã€‚',
                    
                    handPosition: scores.handPosition >= 80 ? 
                        'æ‰‹ã®ä½ç½®ã¯é©åˆ‡ã§ã™ã€‚ã“ã®ä½ç½®ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                        clubType === 'Driver' ? 
                        'ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®å ´åˆã€æ‰‹ã¯è‚©ã®çœŸä¸‹ã‚ˆã‚Šå°‘ã—å‰ï¼ˆä½“ã‹ã‚‰é›¢ã‚Œã‚‹ï¼‰ã«ä½ç½®ã—ã¾ã—ã‚‡ã†ã€‚' :
                        'æ‰‹ã¯è‚©ã®çœŸä¸‹ã«ä½ç½®ã—ã€ä½“ã¨ã®è·é›¢ã¯æ‹³ï¼‘ï¼ï¼•ï½ï¼’å€‹ãã‚‰ã„ã«ã—ã¾ã—ã‚‡ã†ã€‚',
                    
                    frontBackWeight: scores.frontBackWeight >= 80 ? 
                        'å‰å¾Œã®é‡å¿ƒã¯é©åˆ‡ã§ã™ã€‚ã“ã®ãƒãƒ©ãƒ³ã‚¹ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                        'é‡å¿ƒã‚’ãƒœãƒ¼ãƒ«å´ï¼ˆã¤ã¾å…ˆå´ï¼‰ã«ã‚„ã‚„ç§»ã—ã¾ã—ã‚‡ã†ã€‚ã‹ã‹ã¨é‡å¿ƒã«ãªã‚‰ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚',
                    
                    spinalCurve: scores.spinalCurve >= 80 ? 
                        'èƒŒç­‹ã®æ›²ãŒã‚Šå…·åˆã¯è‰¯å¥½ã§ã™ã€‚è‡ªç„¶ãªï¼³å­—ã‚«ãƒ¼ãƒ–ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚' :
                        'èƒŒç­‹ã®è‡ªç„¶ãªï¼³å­—ã‚«ãƒ¼ãƒ–ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚çŒ«èƒŒã‚„åã‚Šè…¹ã«ãªã‚‰ãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚'
                };
            }
            
            return advice;
        }

        // è¨ºæ–­é–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', function() {
            // UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å³åº§ã«æœ‰åŠ¹åŒ–
            document.getElementById('viewSelect').disabled = false;
            document.getElementById('clubSelect').disabled = false;
            document.getElementById('startDiagnosis').disabled = false;
            
            // MediaPipeã¯éåŒæœŸã§åˆæœŸåŒ–ï¼ˆUIãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
            setTimeout(() => {
                initMediaPipe();
            }, 100);
            
            // æ’®å½±è¦–ç‚¹ãŒå¤‰ã‚ã£ãŸã¨ãã®å‡¦ç†
            document.getElementById('viewSelect').addEventListener('change', function() {
                // ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                userClickedBallPosition = null;
                
                // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                const existingMarker = document.getElementById('imageContainer').querySelector('.ball-position-marker');
                if (existingMarker) {
                    existingMarker.remove();
                }
                
                if (uploadedImageElement) {
                    setupBallPositionClick();
                }
            });
            
            document.getElementById('startDiagnosis').addEventListener('click', function() {
                if (!uploadedImageElement) {
                    alert('ã¾ãšç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                    return;
                }
                
                const viewType = document.getElementById('viewSelect').value;
                
                // æ­£é¢è¦–ç‚¹ã®å ´åˆã¯ãƒœãƒ¼ãƒ«ä½ç½®ã‚¯ãƒªãƒƒã‚¯ãŒå¿…é ˆ
                if (viewType === 'front' && !userClickedBallPosition) {
                    alert('æ­£é¢æ’®å½±ã®å ´åˆã€ãƒœãƒ¼ãƒ«ä½ç½®ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚\nè‡ªå‹•æ¤œå‡ºã§ããªã„å ´åˆã¯ã€ç”»åƒä¸Šã®ãƒœãƒ¼ãƒ«ãŒã‚ã‚‹ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
                    
                    // ãƒœãƒ¼ãƒ«ä½ç½®æŒ‡ç¤ºã‚’å†è¡¨ç¤º
                    const ballInstruction = document.getElementById('ballPositionInstruction');
                    ballInstruction.style.display = 'block';
                    ballInstruction.innerHTML = 'âš ï¸ ãƒœãƒ¼ãƒ«ä½ç½®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„<br><small>æ­£é¢æ’®å½±ã§ã¯å¿…é ˆã§ã™</small>';
                    ballInstruction.style.backgroundColor = 'rgba(255, 193, 7, 0.9)';
                    ballInstruction.style.borderColor = '#ffc107';
                    
                    return;
                }
                
                // è¨ºæ–­é–‹å§‹æ™‚ã«ãƒœãƒ¼ãƒ«ä½ç½®æŒ‡ç¤ºã‚’éè¡¨ç¤º
                const ballInstruction = document.getElementById('ballPositionInstruction');
                if (ballInstruction) {
                    ballInstruction.style.display = 'none';
                }
                
                // è¨ºæ–­é–‹å§‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                isDiagnosisStarted = true;
                
                // Google Analytics ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'diagnosis_start', {
                        'club_type': document.getElementById('clubSelect').value,
                        'view_type': viewType,
                        'event_category': 'engagement',
                        'event_label': 'Golf Address Diagnosis'
                    });
                }
                
                showLoading();
                
                // æ—¢ã«ãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯åˆ†æã®ã¿å®Ÿè¡Œ
                if (poseResults && poseResults.poseLandmarks) {
                    console.log('æ—¢å­˜ãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã§åˆ†æå®Ÿè¡Œ');
                    analyzePosture();
                } else {
                    console.log('ãƒãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ãªã—ã€MediaPipeå‡¦ç†ã‹ã‚‰é–‹å§‹');
                    processImage();
                }
            });
        });

        // ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚·ã‚§ã‚¢é–¢æ•°
        function shareToTwitter() {
            const text = encodeURIComponent('ğŸŒï¸ AIã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã§å§¿å‹¢ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸï¼\n\né‡å±±ä½³æ²»ãƒ—ãƒ­ç›£ä¿®ã®æœ¬æ ¼çš„ãªè¨ºæ–­ãŒç„¡æ–™ã§å—ã‘ã‚‰ã‚Œã¾ã™ã€‚\n\n#ã‚´ãƒ«ãƒ• #ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ #ã‚´ãƒ«ãƒ•ä¸Šé” #AIè¨ºæ–­');
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
            
            // Google Analytics ã‚¤ãƒ™ãƒ³ãƒˆ
            if (typeof gtag !== 'undefined') {
                gtag('event', 'social_share', {
                    'method': 'Twitter',
                    'event_category': 'engagement'
                });
            }
        }

        function shareToFacebook() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
            
            // Google Analytics ã‚¤ãƒ™ãƒ³ãƒˆ
            if (typeof gtag !== 'undefined') {
                gtag('event', 'social_share', {
                    'method': 'Facebook',
                    'event_category': 'engagement'
                });
            }
        }

        function shareToLine() {
            const text = encodeURIComponent('ğŸŒï¸ AIã‚´ãƒ«ãƒ•ã‚¢ãƒ‰ãƒ¬ã‚¹è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã§å§¿å‹¢ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ãŸï¼\n\né‡å±±ä½³æ²»ãƒ—ãƒ­ç›£ä¿®ã®æœ¬æ ¼çš„ãªè¨ºæ–­ãŒç„¡æ–™ã§å—ã‘ã‚‰ã‚Œã¾ã™ã€‚');
            const url = encodeURIComponent(window.location.href);
            window.open(`https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`, '_blank');
            
            // Google Analytics ã‚¤ãƒ™ãƒ³ãƒˆ
            if (typeof gtag !== 'undefined') {
                gtag('event', 'social_share', {
                    'method': 'LINE',
                    'event_category': 'engagement'
                });
            }
        }

        function copyToClipboard() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€æ™‚çš„ã«å¤‰æ›´
                const btn = event.target.closest('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = btn.innerHTML.replace('URLã‚³ãƒ”ãƒ¼', 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            }).catch(() => {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const btn = event.target.closest('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = btn.innerHTML.replace('URLã‚³ãƒ”ãƒ¼', 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
            
            // Google Analytics ã‚¤ãƒ™ãƒ³ãƒˆ
            if (typeof gtag !== 'undefined') {
                gtag('event', 'social_share', {
                    'method': 'Copy URL',
                    'event_category': 'engagement'
                });
            }
        }
    </script>
</body>
</html>